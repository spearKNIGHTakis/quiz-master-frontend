<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuizMaster - Ghana Curriculum Quiz Platform</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary: #4361ee;
            --secondary: #3f37c9;
            --success: #4cc9f0;
            --danger: #f72585;
            --warning: #f8961e;
            --info: #4895ef;
            --light: #f8f9fa;
            --dark: #212529;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            background: rgba(255,255,255,0.95);
        }
        
        .category-card, .subject-card {
            transition: all 0.3s ease;
            cursor: pointer;
            border: 2px solid transparent;
        }
        
        .category-card:hover, .subject-card:hover {
            transform: translateY(-5px);
            border-color: var(--primary);
        }
        
        .category-card.selected, .subject-card.selected {
            border-color: var(--primary);
            background-color: rgba(67, 97, 238, 0.1);
        }
        
        .option {
            padding: 15px;
            margin: 10px 0;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .option:hover {
            border-color: var(--primary);
            background-color: rgba(67, 97, 238, 0.05);
        }
        
        .option.selected {
            border-color: var(--primary);
            background-color: rgba(67, 97, 238, 0.1);
        }
        
        .option.correct {
            border-color: var(--success);
            background-color: rgba(76, 201, 240, 0.2);
        }
        
        .option.incorrect {
            border-color: var(--danger);
            background-color: rgba(247, 37, 133, 0.1);
        }
        
        .timer {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary);
        }
        
        .timer.warning {
            color: var(--warning);
        }
        
        .timer.danger {
            color: var(--danger);
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .question-feedback {
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            display: none;
        }
        
        .question-feedback.show {
            display: block;
        }
        
        .question-feedback.correct {
            background-color: rgba(76, 201, 240, 0.2);
            border-left: 5px solid var(--success);
        }
        
        .question-feedback.incorrect {
            background-color: rgba(247, 37, 133, 0.1);
            border-left: 5px solid var(--danger);
        }
        
        .multiplayer-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            background: var(--light);
        }
        
        .player-item, .scoreboard-item, .leaderboard-item {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            margin: 5px 0;
            border-radius: 10px;
            background: var(--light);
            transition: all 0.3s ease;
        }
        
        .player-item:hover, .scoreboard-item:hover, .leaderboard-item:hover {
            transform: translateX(5px);
        }
        
        .current-player {
            background: rgba(67, 97, 238, 0.1);
            border-left: 4px solid var(--primary);
        }
        
        .scoreboard-rank, .leaderboard-rank {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 10px;
        }
        
        .chat-messages {
            max-height: 200px;
            overflow-y: auto;
        }
        
        .chat-message {
            padding: 8px 12px;
            margin: 5px 0;
            border-radius: 10px;
            background: var(--light);
        }
        
        .chat-message.own-message {
            background: rgba(67, 97, 238, 0.1);
            margin-left: 20px;
        }
        
        .chat-message.system-message {
            background: rgba(248, 150, 30, 0.1);
            font-style: italic;
            text-align: center;
        }
        
        .status {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        .status.connected {
            background: rgba(76, 201, 240, 0.2);
            color: var(--success);
        }
        
        .status.disconnected {
            background: rgba(247, 37, 133, 0.1);
            color: var(--danger);
        }
        
        .status.connecting {
            background: rgba(248, 150, 30, 0.2);
            color: var(--warning);
        }
        
        .online-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }
        
        .online-indicator.online {
            background: var(--success);
        }
        
        .online-indicator.offline {
            background: var(--danger);
        }
        
        .online-indicator.connecting {
            background: var(--warning);
            animation: pulse 1.5s infinite;
        }
        
        .countdown-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }
        
        .countdown-content {
            text-align: center;
            color: white;
        }
        
        .countdown-number {
            font-size: 5rem;
            font-weight: bold;
            color: var(--success);
        }
        
        .confetti {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 9999;
            display: none;
        }
        
        .skip-link {
            position: absolute;
            top: -40px;
            left: 6px;
            background: #000;
            color: white;
            padding: 8px;
            z-index: 10000;
            text-decoration: none;
        }
        
        .skip-link:focus {
            top: 6px;
        }
        
        .avatar-option {
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .avatar-option:hover {
            transform: scale(1.1);
        }
        
        .loading {
            opacity: 0.7;
            pointer-events: none;
        }
        
        .stat-card {
            padding: 15px;
            border-radius: 10px;
            background: var(--light);
            text-align: center;
        }
        
        .reconnection-alert {
            animation: slideDown 0.5s ease;
        }
        
        @keyframes slideDown {
            from { transform: translateY(-100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .option-content {
            display: flex;
            align-items: center;
        }
        
        .option-letter {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 15px;
        }
    </style>
</head>
<body>
    <!-- Confetti Animation -->
    <div id="confetti" class="confetti"></div>

    <!-- Audio Elements -->
    <audio id="correct-sound" preload="auto">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-correct-answer-tone-2870.mp3" type="audio/mpeg">
    </audio>
    <audio id="wrong-sound" preload="auto">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-wrong-answer-fail-notification-946.mp3" type="audio/mpeg">
    </audio>
    <audio id="victory-sound" preload="auto">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-winning-chimes-2015.mp3" type="audio/mpeg">
    </audio>

    <div class="container py-4">
        <div class="row justify-content-center">
            <div class="col-lg-10 col-xl-8">
                <div class="card">
                    <div class="card-body p-4 p-md-5">
                        <!-- Header -->
                        <div class="text-center mb-4">
                            <h1 class="display-4 fw-bold text-primary mb-2">üéì QuizMaster</h1>
                            <p class="lead text-muted">Ghana Curriculum Quiz Platform</p>
                            
                            <!-- Connection Status -->
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <div id="connection-status" class="status connecting">
                                    <span class="online-indicator connecting"></span>
                                    <i class="fas fa-sync-alt me-2"></i>Connecting...
                                </div>
                                <button id="toggle-sound" class="btn btn-outline-success btn-sm">
                                    <i class="fas fa-volume-up me-1"></i>Sound On
                                </button>
                            </div>
                        </div>

                        <!-- Error/Success Messages -->
                        <div id="error-message" class="alert alert-danger d-none" role="alert">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <span id="error-text"></span>
                        </div>
                        
                        <div id="success-message" class="alert alert-success d-none" role="alert">
                            <i class="fas fa-check-circle me-2"></i>
                            <span id="success-text"></span>
                        </div>

                        <!-- Loading Spinner -->
                        <div id="loading-spinner" class="text-center d-none">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2 text-muted">Loading...</p>
                        </div>

                        <!-- Category Selection Screen -->
                        <div id="category-selection">
                            <div class="text-center mb-5">
                                <h2 class="mb-3">Select Education Level</h2>
                                <p class="text-muted">Choose your academic level to begin the quiz</p>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-4 mb-4">
                                    <div class="card category-card h-100" data-category="primary" role="button" tabindex="0" aria-label="Primary School Level">
                                        <div class="card-body text-center p-4">
                                            <i class="fas fa-pencil-alt fa-3x text-primary mb-3" aria-hidden="true"></i>
                                            <h4 class="card-title">Primary School</h4>
                                            <p class="card-text text-muted">Basic 1-6 (BECE Level)</p>
                                            <div class="mt-3">
                                                <span class="badge bg-success me-1">Easy</span>
                                                <span class="badge bg-warning">Medium</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-md-4 mb-4">
                                    <div class="card category-card h-100" data-category="highschool" role="button" tabindex="0" aria-label="High School Level">
                                        <div class="card-body text-center p-4">
                                            <i class="fas fa-graduation-cap fa-3x text-success mb-3" aria-hidden="true"></i>
                                            <h4 class="card-title">JHS & SHS</h4>
                                            <p class="card-text text-muted">WASSCE Level</p>
                                            <div class="mt-3">
                                                <span class="badge bg-success me-1">Easy</span>
                                                <span class="badge bg-warning me-1">Medium</span>
                                                <span class="badge bg-danger">Hard</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-md-4 mb-4">
                                    <div class="card category-card h-100" data-category="tertiary" role="button" tabindex="0" aria-label="Tertiary Education Level">
                                        <div class="card-body text-center p-4">
                                            <i class="fas fa-university fa-3x text-info mb-3" aria-hidden="true"></i>
                                            <h4 class="card-title">Tertiary</h4>
                                            <p class="card-text text-muted">University & College</p>
                                            <div class="mt-3">
                                                <span class="badge bg-warning me-1">Medium</span>
                                                <span class="badge bg-danger">Hard</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="text-center mt-4">
                                <button id="setup-multiplayer" class="btn btn-outline-primary btn-lg">
                                    <i class="fas fa-users me-2"></i>Multiplayer Mode
                                </button>
                            </div>
                        </div>

                        <!-- Subject Selection Screen -->
                        <div id="subject-selection" class="d-none">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <button id="back-to-categories" class="btn btn-outline-secondary">
                                    <i class="fas fa-arrow-left me-2"></i>Back
                                </button>
                                <h2 id="category-title" class="mb-0 text-center flex-grow-1">Select Subject</h2>
                                <div style="width: 100px;"></div> <!-- Spacer for alignment -->
                            </div>
                            
                            <div id="subjects-container" class="row">
                                <!-- Subjects will be dynamically loaded here -->
                            </div>
                            
                            <div class="mt-4 p-4 bg-light rounded">
                                <h5 class="mb-3"><i class="fas fa-cogs me-2"></i>Quiz Settings</h5>
                                
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label for="player-name" class="form-label">Your Name</label>
                                        <input type="text" class="form-control" id="player-name" placeholder="Enter your name" value="Player">
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <label class="form-label">Avatar</label>
                                        <div id="avatar-selection" class="d-flex gap-2">
                                            <!-- Avatars will be dynamically loaded here -->
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-4">
                                        <label for="difficulty-select" class="form-label">Difficulty</label>
                                        <select class="form-select" id="difficulty-select">
                                            <option value="all">All Levels</option>
                                            <option value="easy">Easy</option>
                                            <option value="medium" selected>Medium</option>
                                            <option value="hard">Hard</option>
                                        </select>
                                    </div>
                                    
                                    <div class="col-md-4">
                                        <label for="question-count" class="form-label">Questions</label>
                                        <select class="form-select" id="question-count">
                                            <option value="5">5 Questions</option>
                                            <option value="10" selected>10 Questions</option>
                                            <option value="15">15 Questions</option>
                                            <option value="20">20 Questions</option>
                                        </select>
                                    </div>
                                    
                                    <div class="col-md-4">
                                        <label for="question-source" class="form-label">Question Source</label>
                                        <select class="form-select" id="question-source">
                                            <option value="ghana_curriculum" selected>Ghana Curriculum</option>
                                            <option value="mixed">Mixed Sources</option>
                                        </select>
                                    </div>
                                    
                                    <div class="col-12">
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="radio" name="gameMode" id="singlePlayer" value="single" checked>
                                            <label class="form-check-label" for="singlePlayer">
                                                <i class="fas fa-user me-1"></i>Single Player
                                            </label>
                                        </div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="radio" name="gameMode" id="multiplayer" value="multiplayer">
                                            <label class="form-check-label" for="multiplayer">
                                                <i class="fas fa-users me-1"></i>Multiplayer
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="text-center mt-4">
                                    <button id="start-quiz-btn" class="btn btn-primary btn-lg">
                                        <i class="fas fa-play me-2"></i>Start Quiz
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Multiplayer Setup Screen -->
                        <div id="multiplayer-setup" class="d-none">
                            <div class="text-center mb-4">
                                <h2>Multiplayer Mode</h2>
                                <p class="text-muted">Challenge your friends in real-time quiz battles</p>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-4">
                                    <div class="card h-100">
                                        <div class="card-body text-center p-4">
                                            <i class="fas fa-plus-circle fa-3x text-success mb-3" aria-hidden="true"></i>
                                            <h4 class="card-title">Create Room</h4>
                                            <p class="card-text">Start a new game and invite friends</p>
                                            
                                            <div class="mt-4">
                                                <label for="mp-player-name" class="form-label">Your Name</label>
                                                <input type="text" class="form-control mb-3" id="mp-player-name" placeholder="Enter your name" value="Player">
                                                
                                                <label class="form-label">Avatar</label>
                                                <div id="mp-avatar-selection" class="d-flex gap-2 justify-content-center mb-3">
                                                    <!-- Avatars will be dynamically loaded here -->
                                                </div>
                                                
                                                <button id="create-room-btn" class="btn btn-success btn-lg w-100">
                                                    <i class="fas fa-plus me-2"></i>Create Room
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-md-6 mb-4">
                                    <div class="card h-100">
                                        <div class="card-body text-center p-4">
                                            <i class="fas fa-sign-in-alt fa-3x text-primary mb-3" aria-hidden="true"></i>
                                            <h4 class="card-title">Join Room</h4>
                                            <p class="card-text">Enter a room code to join existing game</p>
                                            
                                            <div class="mt-4">
                                                <label for="room-code-input" class="form-label">Room Code</label>
                                                <input type="text" class="form-control mb-3 text-uppercase" id="room-code-input" placeholder="Enter 4-digit code" maxlength="4">
                                                
                                                <button id="join-room-btn" class="btn btn-primary btn-lg w-100">
                                                    <i class="fas fa-sign-in-alt me-2"></i>Join Room
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="text-center mt-3">
                                <button id="back-to-multiplayer-setup" class="btn btn-outline-secondary">
                                    <i class="fas fa-arrow-left me-2"></i>Back to Main Menu
                                </button>
                            </div>
                        </div>

                       <!-- In the multiplayer-lobby section of index.html -->
<div id="multiplayer-lobby" class="d-none">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <button id="leave-room-btn" class="btn btn-outline-danger">
            <i class="fas fa-door-open me-2"></i>Leave Room
        </button>
        <h2 class="mb-0">Game Lobby</h2>
        <div class="text-end">
            <div class="fw-bold">Room: <span id="room-code" class="badge bg-primary">----</span></div>
            <small class="text-muted" id="player-count">0 players</small>
        </div>
    </div>
    
    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="fas fa-users me-2"></i>Players</h5>
            <button id="toggle-ready-btn" class="btn btn-outline-primary btn-sm">
                <i class="fas fa-check me-1"></i>Ready
            </button>
        </div>
        <div class="card-body">
            <div id="players-list">
                <!-- Real players will appear here as they join -->
            </div>
        </div>
    </div>
    
    <div class="text-center">
        <button id="start-game-btn" class="btn btn-success btn-lg" style="display: none;">
            <i class="fas fa-play me-2"></i>Start Game
        </button>
        <p class="text-muted mt-2" id="start-game-hint">Share the room code with other players to begin</p>
    </div>
</div>
                        <!-- Single Player Quiz Screen -->
                        <div id="quiz-screen" class="d-none">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <div>
                                    <h3 id="current-subject" class="mb-0">Loading Quiz...</h3>
                                    <span class="badge bg-primary" id="question-count-display">Question 1 of 10</span>
                                </div>
                                <div class="timer">
                                    <i class="fas fa-clock me-2" aria-hidden="true"></i>
                                    <span id="time-left" aria-live="assertive">30</span>s
                                </div>
                            </div>
                            
                            <div class="progress mb-4">
                                <div id="progress-bar" class="progress-bar bg-success" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                            
                            <div id="question-feedback" class="question-feedback" aria-live="polite">
                                <i class="fas fa-info-circle me-2" aria-hidden="true"></i>
                                <span id="feedback-text"></span>
                            </div>
                            
                            <div class="card question-card">
                                <div class="card-body">
                                    <h4 id="question-text" class="card-title">Loading question...</h4>
                                    <div id="options-container" class="mt-4" role="listbox" aria-label="Answer options">
                                        <!-- Options will be dynamically loaded here -->
                                    </div>
                                </div>
                            </div>
                            
                            <div class="d-flex justify-content-between mt-4">
                                <button id="prev-question" class="btn btn-outline-secondary" style="display: none;">
                                    <i class="fas fa-arrow-left me-2"></i>Previous
                                </button>
                                <div>
                                    <button id="next-question" class="btn btn-outline-primary" style="display: none;">
                                        Next <i class="fas fa-arrow-right ms-2"></i>
                                    </button>
                                    <button id="submit-quiz" class="btn btn-success" style="display: none;">
                                        <i class="fas fa-flag me-2"></i>Submit Quiz
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Single Player Results Screen -->
                        <div id="results-screen" class="d-none">
                            <div class="text-center mb-5">
                                <h2>Quiz Complete! üéâ</h2>
                                <div class="display-4 fw-bold text-primary mb-2" id="final-score">0/0</div>
                                <p class="lead" id="points-earned">0 points earned</p>
                            </div>
                            
                            <div id="performance-stats" class="mb-4">
                                <!-- Performance stats will be dynamically loaded here -->
                            </div>
                            
                            <div class="text-center mt-4">
                                <button id="play-again-btn" class="btn btn-primary btn-lg me-3">
                                    <i class="fas fa-redo me-2"></i>Play Again
                                </button>
                                <button id="back-to-menu" class="btn btn-outline-primary">
                                    <i class="fas fa-home me-2"></i>Main Menu
                                </button>
                            </div>
                        </div>

                        <!-- Multiplayer Quiz and Results screens will be dynamically created -->
                    </div>
                </div>
                
                <div class="text-center mt-4">
                    <small class="text-white-50">
                        &copy; 2024 QuizMaster - Ghana Curriculum Quiz Platform
                    </small>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.min.js"></script>
    
    <script>
        // QuizMaster - Complete JavaScript with Enhanced Features
        console.log('üöÄ Loading Enhanced QuizMaster JavaScript...');

        // Configuration
        const BACKEND_URL = 'https://quiz-app-backend-3g8p.onrender.com';
        const SOCKET_URL = BACKEND_URL;
        const API_URL = `${BACKEND_URL}/api`;

        // App State
        let currentState = {
            screen: 'category-selection',
            category: null,
            subject: null,
            gameMode: 'single',
            connectionStatus: 'connecting'
        };

        // Enhanced Sound System
        const soundSystem = {
            enabled: true,
            play(soundName) {
                if (!this.enabled) return;
                try {
                    const sound = document.getElementById(`${soundName}-sound`);
                    if (sound) {
                        sound.currentTime = 0;
                        sound.play().catch(e => console.log('Audio play failed:', e));
                    }
                } catch (error) {
                    console.log('Sound error:', error);
                }
            },
            toggle() {
                this.enabled = !this.enabled;
                const button = document.getElementById('toggle-sound');
                if (button) {
                    button.innerHTML = this.enabled ? 
                        '<i class="fas fa-volume-up me-1"></i> Sound On' : 
                        '<i class="fas fa-volume-mute me-1"></i> Sound Off';
                    button.classList.toggle('btn-outline-success');
                    button.classList.toggle('btn-outline-secondary');
                }
                storageManager.savePreferences();
            }
        };

        // Enhanced Storage Manager with Offline Support
        const storageManager = {
            savePreferences() {
                try {
                    const preferences = {
                        soundEnabled: soundSystem.enabled,
                        selectedAvatar: avatarSystem.selectedAvatar,
                        playerName: document.getElementById('player-name')?.value || 'Player',
                        mpPlayerName: document.getElementById('mp-player-name')?.value || 'Player',
                        lastCategory: categoryManager.currentCategory,
                        lastSubject: categoryManager.currentSubject,
                        savedAt: Date.now()
                    };
                    localStorage.setItem('quizMasterPrefs', JSON.stringify(preferences));
                    console.log('‚úÖ Preferences saved');
                } catch (error) {
                    console.error('‚ùå Failed to save preferences:', error);
                }
            },
            
            loadPreferences() {
                try {
                    const saved = localStorage.getItem('quizMasterPrefs');
                    if (saved) {
                        const prefs = JSON.parse(saved);
                        soundSystem.enabled = prefs.soundEnabled !== undefined ? prefs.soundEnabled : true;
                        avatarSystem.selectedAvatar = prefs.selectedAvatar || 'üë®‚Äçüíª';
                        
                        const playerNameInput = document.getElementById('player-name');
                        const mpPlayerNameInput = document.getElementById('mp-player-name');
                        
                        if (playerNameInput && prefs.playerName) {
                            playerNameInput.value = prefs.playerName;
                        }
                        if (mpPlayerNameInput && prefs.mpPlayerName) {
                            mpPlayerNameInput.value = prefs.mpPlayerName;
                        }
                        
                        // Restore last selected category/subject
                        if (prefs.lastCategory && prefs.lastSubject) {
                            categoryManager.currentCategory = prefs.lastCategory;
                            categoryManager.currentSubject = prefs.lastSubject;
                        }
                        
                        console.log('‚úÖ Preferences loaded');
                    }
                } catch (error) {
                    console.error('‚ùå Failed to load preferences:', error);
                }
            },
            
            saveGameProgress(gameState) {
                try {
                    localStorage.setItem('quizMasterCurrentGame', JSON.stringify({
                        ...gameState,
                        savedAt: Date.now(),
                        playerId: multiplayerSystem.playerId
                    }));
                    console.log('üíæ Game progress saved');
                } catch (error) {
                    console.error('‚ùå Failed to save game progress:', error);
                }
            },
            
            loadGameProgress() {
                try {
                    const saved = localStorage.getItem('quizMasterCurrentGame');
                    if (saved) {
                        const gameState = JSON.parse(saved);
                        // Check if saved game is not too old (e.g., 2 hours) and belongs to current player
                        if (Date.now() - gameState.savedAt < 7200000 && 
                            gameState.playerId === multiplayerSystem.playerId) {
                            console.log('üíæ Game progress loaded');
                            return gameState;
                        } else {
                            // Clear expired game data
                            this.clearGameProgress();
                        }
                    }
                } catch (error) {
                    console.error('‚ùå Failed to load game progress:', error);
                }
                return null;
            },
            
            clearGameProgress() {
                try {
                    localStorage.removeItem('quizMasterCurrentGame');
                    console.log('üóëÔ∏è Game progress cleared');
                } catch (error) {
                    console.error('‚ùå Failed to clear game progress:', error);
                }
            },
            
            // Enhanced data validation
            validateStoredData() {
                try {
                    const prefs = localStorage.getItem('quizMasterPrefs');
                    if (prefs) {
                        JSON.parse(prefs); // This will throw if invalid JSON
                    }
                    return true;
                } catch (error) {
                    console.error('‚ùå Corrupted data detected, clearing...');
                    this.clearAllData();
                    return false;
                }
            },
            
            clearAllData() {
                try {
                    localStorage.removeItem('quizMasterPrefs');
                    localStorage.removeItem('quizMasterCurrentGame');
                    localStorage.removeItem('quizMasterSessions');
                    console.log('üóëÔ∏è All game data cleared');
                } catch (error) {
                    console.error('‚ùå Failed to clear all data:', error);
                }
            }
        };

        // Enhanced API Manager with Timeouts
        const apiManager = {
            async safeCall(apiCall, fallbackData = null, errorMessage = 'Operation failed', timeout = 10000) {
                try {
                    categoryManager.showLoading(true);
                    
                    // Create a timeout promise
                    const timeoutPromise = new Promise((_, reject) => {
                        setTimeout(() => reject(new Error('Request timeout')), timeout);
                    });
                    
                    // Race between the API call and timeout
                    const result = await Promise.race([apiCall(), timeoutPromise]);
                    
                    categoryManager.showLoading(false);
                    return result;
                } catch (error) {
                    console.error('API call failed:', error);
                    categoryManager.showLoading(false);
                    categoryManager.showError(errorMessage);
                    return fallbackData;
                }
            },
            
            withRetry(apiCall, maxRetries = 3, delay = 1000) {
                return async (...args) => {
                    for (let attempt = 1; attempt <= maxRetries; attempt++) {
                        try {
                            return await apiCall(...args);
                        } catch (error) {
                            if (attempt === maxRetries) throw error;
                            console.log(`Retry ${attempt}/${maxRetries} after ${delay}ms`);
                            await this.delay(delay);
                            delay *= 2; // Exponential backoff
                        }
                    }
                };
            },
            
            delay(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }
        };

        // Button Manager
        const buttonManager = {
            setLoading(button, isLoading, originalText = null) {
                if (!button) return;
                
                if (isLoading) {
                    button.dataset.originalText = originalText || button.innerHTML;
                    button.disabled = true;
                    button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Loading...';
                    button.classList.add('loading');
                } else {
                    button.disabled = false;
                    button.innerHTML = button.dataset.originalText || originalText || 'Submit';
                    button.classList.remove('loading');
                }
            },
            
            debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            }
        };

        // Avatar System
        const avatarSystem = {
            selectedAvatar: 'üë®‚Äçüíª',
            init() {
                console.log('üë§ Avatar system initialized');
                this.renderAvatarSelection();
                this.renderMultiplayerAvatarSelection();
            },
            
            renderAvatarSelection() {
                const container = document.getElementById('avatar-selection');
                if (!container) return;
                
                const avatars = ['üë®‚Äçüíª', 'üë©‚ÄçüöÄ', 'ü¶∏', 'üë®‚Äçüéì', 'üë©‚Äçüé®', 'ü§ñ', 'üê±', 'ü¶ä'];
                
                container.innerHTML = avatars.map(avatar => `
                    <div class="avatar-option ${avatar === this.selectedAvatar ? 'selected' : ''}" 
                         data-avatar="${avatar}" role="button" aria-label="Select ${avatar} avatar" tabindex="0">
                        <div class="avatar-display" style="font-size: 2rem; cursor: pointer; padding: 5px; border-radius: 10px; border: 3px solid ${avatar === this.selectedAvatar ? '#4361ee' : 'transparent'}">
                            ${avatar}
                        </div>
                    </div>
                `).join('');
                
                container.querySelectorAll('.avatar-option').forEach(option => {
                    option.addEventListener('click', () => {
                        this.selectAvatar(option.dataset.avatar);
                    });
                    option.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter' || e.key === ' ') {
                            this.selectAvatar(option.dataset.avatar);
                        }
                    });
                });
            },

            renderMultiplayerAvatarSelection() {
                const container = document.getElementById('mp-avatar-selection');
                if (!container) return;
                
                const avatars = ['üë®‚Äçüíª', 'üë©‚ÄçüöÄ', 'ü¶∏', 'üë®‚Äçüéì', 'üë©‚Äçüé®', 'ü§ñ', 'üê±', 'ü¶ä'];
                
                container.innerHTML = avatars.map(avatar => `
                    <div class="avatar-option ${avatar === this.selectedAvatar ? 'selected' : ''}" 
                         data-avatar="${avatar}" role="button" aria-label="Select ${avatar} avatar" tabindex="0">
                        <div class="avatar-display" style="font-size: 2rem; cursor: pointer; padding: 5px; border-radius: 10px; border: 3px solid ${avatar === this.selectedAvatar ? '#4361ee' : 'transparent'}">
                            ${avatar}
                        </div>
                    </div>
                `).join('');
                
                container.querySelectorAll('.avatar-option').forEach(option => {
                    option.addEventListener('click', () => {
                        this.selectAvatar(option.dataset.avatar);
                    });
                    option.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter' || e.key === ' ') {
                            this.selectAvatar(option.dataset.avatar);
                        }
                    });
                });
            },
            
            selectAvatar(avatar) {
                this.selectedAvatar = avatar;
                this.renderAvatarSelection();
                this.renderMultiplayerAvatarSelection();
                storageManager.savePreferences();
            }
        };

        // Enhanced Connection Manager with Backend Compatibility
        const connectionManager = {
            socket: null,
            isConnected: false,
            reconnectAttempts: 0,
            maxReconnectAttempts: 5,
            reconnectDelay: 3000,
            eventListeners: new Map(),
            useFallback: false,
            
            async init() {
                console.log('üîå Initializing enhanced connection manager...');
                
                // Check if Socket.io is available
                if (typeof io === 'undefined') {
                    console.log('üö´ Socket.io not available - using fallback mode');
                    this.useFallback = true;
                    this.enableFallbackMode();
                    return;
                }
                
                await this.connect();
            },
            
            async connect() {
                // Don't attempt reconnection if we're using fallback
                if (this.useFallback) {
                    console.log('üîÑ Using fallback mode - skipping Socket.io connection');
                    this.setConnectionStatus('disconnected');
                    return;
                }
                
                try {
                    this.setConnectionStatus('connecting');
                    
                    console.log(`üîó Attempting Socket.io connection to: ${BACKEND_URL}`);
                    
                    // Initialize Socket.io with proper configuration
                    this.socket = io(BACKEND_URL, {
                        transports: ['websocket', 'polling'],
                        timeout: 10000,
                        reconnectionAttempts: 3,
                        reconnectionDelay: 2000
                    });
                    
                    this.socket.on('connect', () => {
                        console.log('‚úÖ Socket.io connected successfully');
                        this.isConnected = true;
                        this.reconnectAttempts = 0;
                        this.setConnectionStatus('connected');
                        
                        // Rejoin room if we were in one
                        if (multiplayerSystem.currentRoom) {
                            this.rejoinRoom();
                        }
                    });
                    
                    this.socket.on('disconnect', (reason) => {
                        console.log('‚ùå Socket.io disconnected:', reason);
                        this.isConnected = false;
                        this.setConnectionStatus('disconnected');
                        
                        if (reason === 'io server disconnect') {
                            // Server intentionally disconnected, don't reconnect
                            console.log('üö´ Server disconnected us - switching to fallback');
                            this.useFallback = true;
                            this.enableFallbackMode();
                        } else {
                            // Attempt reconnection
                            if (this.reconnectAttempts < this.maxReconnectAttempts) {
                                setTimeout(() => {
                                    this.reconnectAttempts++;
                                    console.log(`üîÑ Attempting reconnect ${this.reconnectAttempts}/${this.maxReconnectAttempts}...`);
                                }, this.reconnectDelay);
                            } else {
                                console.log('üö´ Max reconnection attempts reached - switching to fallback mode');
                                this.useFallback = true;
                                this.enableFallbackMode();
                            }
                        }
                    });
                    
                    this.socket.on('connect_error', (error) => {
                        console.error('Socket.io connection error:', error);
                        this.setConnectionStatus('disconnected');
                        
                        // Switch to fallback after multiple failures
                        if (this.reconnectAttempts >= 2) {
                            console.log('üö´ Multiple connection failures - switching to fallback');
                            this.useFallback = true;
                            this.enableFallbackMode();
                        }
                    });
                    
                    // Set up event listeners for Socket.io events
                    this.setupSocketListeners();
                    
                } catch (error) {
                    console.error('Failed to connect with Socket.io:', error);
                    this.setConnectionStatus('disconnected');
                    this.useFallback = true;
                    this.enableFallbackMode();
                }
            },
            
            setupSocketListeners() {
                // Map Socket.io events to our internal handlers
                const eventMap = {
                    'gameCreated': 'gameCreated',
                    'gameJoined': 'gameJoined', 
                    'playerJoined': 'playerJoined',
                    'playerLeft': 'playerLeft',
                    'gameStarting': 'gameStarting',
                    'gameStarted': 'gameStarted',
                    'playerAnswered': 'playerAnswered',
                    'nextQuestion': 'question',
                    'gameFinished': 'gameEnded',
                    'gameError': 'gameError',
                    'playerReadyChanged': 'playerReadyChanged',
                    'newHost': 'newHost',
                    'chatMessage': 'chatMessage'
                };
                
                Object.entries(eventMap).forEach(([socketEvent, internalEvent]) => {
                    this.socket.on(socketEvent, (data) => {
                        console.log(`üì• Received ${socketEvent}:`, data);
                        this.handleMessage({ event: internalEvent, payload: data });
                    });
                });
            },
            
            // Enhanced emit method with backend compatibility
            async emit(event, data) {
                // If using fallback mode, simulate server response
                if (this.useFallback) {
                    console.log(`üîÑ Fallback mode - simulating ${event}:`, data);
                    return this.simulateServerResponse(event, data);
                }
                
                if (!this.isConnected || !this.socket) {
                    console.warn('‚ö†Ô∏è Cannot emit - socket not connected');
                    return { success: false, error: 'Not connected' };
                }
                
                try {
                    // Map our internal events to Socket.io events
                    const eventMap = {
                        'createRoom': 'createGame',
                        'joinRoom': 'joinGame', 
                        'startGame': 'startGame',
                        'submitAnswer': 'submitAnswer',
                        'playerReady': 'playerReady',
                        'chatMessage': 'chatMessage',
                        'leaveRoom': 'disconnect',
                        'rejoinRoom': 'joinGame'
                    };
                    
                    const socketEvent = eventMap[event] || event;
                    
                    // Transform data for backend compatibility
                    let backendData = { ...data };
                    
                    if (event === 'joinRoom') {
                        // Convert roomCode to gameCode for backend
                        backendData = {
                            gameCode: data.roomCode,
                            playerName: data.playerName,
                            avatar: data.avatar
                        };
                    }
                    
                    if (event === 'createRoom') {
                        // Ensure settings are properly formatted
                        backendData = {
                            playerName: data.playerName,
                            avatar: data.avatar,
                            settings: data.settings
                        };
                    }
                    
                    console.log(`üì§ Emitting ${socketEvent} to backend:`, backendData);
                    this.socket.emit(socketEvent, backendData);
                    return { success: true };
                    
                } catch (error) {
                    console.error(`Error emitting ${event}:`, error);
                    return { success: false, error: error.message };
                }
            },
            
            // Enhanced simulateServerResponse for joinRoom to match backend format
            simulateServerResponse(event, data) {
                return new Promise((resolve) => {
                    setTimeout(() => {
                        switch (event) {
                            case 'createRoom':
                                resolve({ 
                                    success: true, 
                                    roomCode: data.roomCode,
                                    message: 'Room created locally'
                                });
                                // Simulate other players joining
                                setTimeout(() => {
                                    this.simulatePlayerJoin(data.roomCode);
                                }, 2000);
                                break;
                                
                            case 'joinRoom':
                                resolve({ 
                                    success: true,
                                    message: 'Joined room locally'
                                });
                                // Simulate existing players
                                setTimeout(() => {
                                    multiplayerSystem.handleRoomUpdated({
                                        roomCode: data.roomCode,
                                        players: [
                                            {
                                                id: 'demo_player_1',
                                                name: 'Demo Player 1',
                                                avatar: 'üë®‚Äçüéì',
                                                score: 0,
                                                isHost: true,
                                                hasAnswered: false
                                            },
                                            {
                                                id: multiplayerSystem.playerId,
                                                name: data.playerName,
                                                avatar: data.avatar,
                                                score: 0,
                                                isHost: false,
                                                hasAnswered: false
                                            }
                                        ],
                                        settings: {
                                            category: 'primary',
                                            subject: 'mathematics',
                                            difficulty: 'medium',
                                            questionCount: 5
                                        },
                                        hostPlayerId: 'demo_player_1'
                                    });
                                }, 1000);
                                break;
                                
                            case 'startGame':
                                resolve({ success: true });
                                // Simulate game starting
                                setTimeout(() => {
                                    const questions = questionManager.getGhanaCurriculumQuestions(
                                        data.settings?.category || 'primary',
                                        data.settings?.subject || 'mathematics',
                                        data.settings?.difficulty || 'medium',
                                        data.settings?.questionCount || 5
                                    );
                                    
                                    multiplayerSystem.handleGameStarted({
                                        roomCode: data.roomCode,
                                        questions: questions,
                                        players: multiplayerSystem.players,
                                        timePerQuestion: 30
                                    });
                                }, 2000);
                                break;
                                
                            default:
                                resolve({ success: true });
                        }
                    }, 500);
                });
            },
            
            // Enhanced event handlers to handle backend responses properly
            handle_gameCreated(data) {
                console.log('‚úÖ Game created on server:', data.gameCode);
                
                // Update our current room with the server-generated code
                if (multiplayerSystem.currentRoom) {
                    multiplayerSystem.currentRoom.code = data.gameCode;
                    multiplayerSystem.currentRoom.host = data.hostId;
                    
                    // Update the room code display
                    const roomCodeElement = document.getElementById('room-code');
                    if (roomCodeElement) {
                        roomCodeElement.textContent = data.gameCode;
                    }
                    
                    categoryManager.showSuccess(`Room created! Code: ${data.gameCode}`);
                    chatSystem.addSystemMessage(`Room created. Share code: ${data.gameCode}`, 'multiplayer-lobby');
                }
            },

            handle_gameJoined(data) {
                console.log('‚úÖ Joined game on server:', data.gameCode);
                
                // Convert backend game data to frontend format
                const players = Array.from(data.players?.values() || []).map(player => ({
                    id: player.id,
                    name: player.name,
                    avatar: player.avatar,
                    score: player.score || 0,
                    isHost: player.id === data.hostId,
                    hasAnswered: false,
                    ready: player.ready || false
                }));
                
                multiplayerSystem.handleRoomUpdated({
                    roomCode: data.gameCode,
                    players: players,
                    settings: data.settings,
                    hostPlayerId: data.hostId
                });
            },

            handleMessage(data) {
                const { event, payload } = data;
                
                // Call all registered listeners for this event
                const listeners = this.eventListeners.get(event) || [];
                listeners.forEach(callback => {
                    try {
                        callback(payload);
                    } catch (error) {
                        console.error(`Error in event listener for ${event}:`, error);
                    }
                });
                
                // Also call specific handler methods if they exist
                if (this[`handle_${event}`]) {
                    this[`handle_${event}`](payload);
                }
            },
            
            on(event, callback) {
                if (!this.eventListeners.has(event)) {
                    this.eventListeners.set(event, []);
                }
                this.eventListeners.get(event).push(callback);
                console.log(`üì• Registered listener for ${event}`);
            },
            
            off(event, callback) {
                const listeners = this.eventListeners.get(event);
                if (listeners) {
                    const index = listeners.indexOf(callback);
                    if (index > -1) {
                        listeners.splice(index, 1);
                    }
                }
            },
            
            setConnectionStatus(status) {
                currentState.connectionStatus = status;
                const statusElement = document.getElementById('connection-status');
                
                if (statusElement) {
                    statusElement.className = `status ${status}`;
                    
                    switch(status) {
                        case 'connected':
                            statusElement.innerHTML = '<span class="online-indicator online"></span><i class="fas fa-check-circle me-2"></i>Connected';
                            statusElement.setAttribute('aria-label', 'Connected to server');
                            break;
                        case 'disconnected':
                            statusElement.innerHTML = '<span class="online-indicator offline"></span><i class="fas fa-times-circle me-2"></i>Offline Mode';
                            statusElement.setAttribute('aria-label', 'Using offline mode');
                            break;
                        case 'connecting':
                            statusElement.innerHTML = '<span class="online-indicator connecting"></span><i class="fas fa-sync-alt me-2"></i>Connecting...';
                            statusElement.setAttribute('aria-label', 'Connecting to server');
                            break;
                    }
                }
            },
            
            async rejoinRoom() {
                if (multiplayerSystem.currentRoom) {
                    console.log('üîÑ Rejoining room after reconnect...');
                    const playerName = document.getElementById('mp-player-name')?.value || 'Player';
                    const avatar = avatarSystem.selectedAvatar;
                    
                    await this.emit('rejoinRoom', {
                        roomCode: multiplayerSystem.currentRoom.code,
                        playerName: playerName,
                        avatar: avatar
                    });
                }
            },
            
            enableFallbackMode() {
                console.log('üîÑ Enabling fallback mode - using simulated multiplayer');
                this.setConnectionStatus('disconnected');
                this.isConnected = false;
                
                // Show notification to user
                categoryManager.showError('Real-time multiplayer unavailable. Using local multiplayer mode.');
                
                // Initialize fallback multiplayer system
                multiplayerSystem.enableFallbackMode();
            },
            
            handleConnectionFailure() {
                console.log('üîÑ Implementing graceful degradation...');
                this.useFallback = true;
                this.enableFallbackMode();
                
                // Notify user
                if (multiplayerSystem.currentRoom) {
                    chatSystem.addSystemMessage('Connection lost. Using local multiplayer mode.', 'multiplayer-lobby');
                }
            },
            // In connectionManager - ensure proper real player handling
handle_playerJoined(data) {
    console.log('üë§ Real player joined:', data);
    
    if (this.currentRoom && this.currentRoom.code === data.roomCode) {
        // Check if player already exists
        const existingPlayer = this.players.find(p => p.id === data.id);
        if (!existingPlayer) {
            // Add new REAL player to the list
            this.players.push({
                id: data.id,
                name: data.name,
                avatar: data.avatar,
                score: data.score || 0,
                isHost: data.isHost || false,
                hasAnswered: false,
                ready: data.ready || false
            });
            
            this.updateLobbyDisplay();
            categoryManager.showSuccess(`${data.name} joined the room!`);
            chatSystem.addSystemMessage(`${data.name} joined the game`, 'multiplayer-lobby');
        }
    }
},
          
            handle_playerLeft(data) {
                multiplayerSystem.handlePlayerLeft({ playerId: data, playerName: 'Player' });
            },
            
            handle_gameStarting(data) {
                console.log('üéÆ Game starting with countdown:', data.countdown);
                chatSystem.addSystemMessage(`Game starting in ${data.countdown} seconds...`, 'multiplayer-lobby');
            },
            
            handle_gameStarted(data) {
                multiplayerSystem.handleGameStarted(data);
            },
            
            handle_playerAnswered(data) {
                multiplayerSystem.handlePlayerAnswered(data);
            },
            
            handle_question(data) {
                multiplayerSystem.handleQuestionReceived({ questionIndex: data.index });
            },
            
            handle_gameEnded(data) {
                multiplayerSystem.handleGameEnded(data);
            },
            
            handle_gameError(data) {
                console.error('Game error from server:', data.message);
                categoryManager.showError(data.message);
            },
            
            handle_playerReadyChanged(data) {
                const player = multiplayerSystem.players.find(p => p.id === data.playerId);
                if (player) {
                    player.ready = data.ready;
                    multiplayerSystem.updateLobbyDisplay();
                }
            },
            
            handle_newHost(data) {
                console.log('üëë New host assigned:', data);
                chatSystem.addSystemMessage('New host assigned to the game', 'multiplayer-lobby');
            },
            
            handle_chatMessage(data) {
                chatSystem.handleIncomingMessage(data);
            }
        };

        // Enhanced Question Manager with Statistics
        const questionManager = {
            async getQuestions(settings) {
                const { category, subject, difficulty, questionCount } = settings;
                console.log(`üìù Getting ${questionCount} ${difficulty} questions for ${category}/${subject}`);
                
                const questions = await apiManager.safeCall(
                    () => this.fetchQuestionsFromAPI(settings),
                    this.getGhanaCurriculumQuestions(category, subject, difficulty, questionCount),
                    'Using Ghana curriculum questions'
                );
                
                return {
                    questions: questions,
                    source: 'ghana_curriculum'
                };
            },
            
            async fetchQuestionsFromAPI(settings) {
                await apiManager.delay(1000);
                throw new Error('API not available');
            },
            
            getGhanaCurriculumQuestions(category, subject, difficulty, count) {
                const allQuestions = this.getAllGhanaQuestions();
                
                // Filter by category and subject
                let filteredQuestions = allQuestions.filter(q => 
                    q.category === category && q.subject === subject
                );
                
                // Filter by difficulty if specified
                if (difficulty !== 'all') {
                    filteredQuestions = filteredQuestions.filter(q => q.difficulty === difficulty);
                }
                
                // Shuffle and return requested count
                return this.shuffleArray(filteredQuestions).slice(0, count);
            },
            
            getAllGhanaQuestions() {
                return [
                    // PRIMARY LEVEL - MATHEMATICS
                    {
                        question: "What is the place value of 7 in the number 4,732?",
                        options: ["Thousands", "Hundreds", "Tens", "Units"],
                        correctAnswer: 1,
                        explanation: "In 4,732, 7 is in the hundreds place (7 √ó 100 = 700).",
                        category: "primary",
                        subject: "mathematics",
                        difficulty: "easy"
                    },
                    {
                        question: "If a bag of rice costs GH‚Çµ 25.50 and you pay with GH‚Çµ 50.00, how much change should you receive?",
                        options: ["GH‚Çµ 24.50", "GH‚Çµ 25.50", "GH‚Çµ 24.00", "GH‚Çµ 23.50"],
                        correctAnswer: 0,
                        explanation: "GH‚Çµ 50.00 - GH‚Çµ 25.50 = GH‚Çµ 24.50",
                        category: "primary",
                        subject: "mathematics",
                        difficulty: "medium"
                    },
                    {
                        question: "Calculate: ¬æ of 48",
                        options: ["12", "24", "36", "40"],
                        correctAnswer: 2,
                        explanation: "¬æ √ó 48 = (48 √∑ 4) √ó 3 = 12 √ó 3 = 36",
                        category: "primary",
                        subject: "mathematics",
                        difficulty: "medium"
                    },

                    // PRIMARY LEVEL - SCIENCE
                    {
                        question: "Which of these is a renewable source of energy?",
                        options: ["Solar power", "Coal", "Natural gas", "Petroleum"],
                        correctAnswer: 0,
                        explanation: "Solar power is renewable because it comes from the sun which won't run out.",
                        category: "primary",
                        subject: "science",
                        difficulty: "easy"
                    },
                    {
                        question: "What is the main function of roots in plants?",
                        options: ["To absorb water and minerals", "To produce food", "To attract insects", "To store air"],
                        correctAnswer: 0,
                        explanation: "Roots anchor the plant and absorb water and minerals from the soil.",
                        category: "primary",
                        subject: "science",
                        difficulty: "easy"
                    },

                    // PRIMARY LEVEL - ENGLISH
                    {
                        question: "Choose the correct plural form of 'child'",
                        options: ["Childs", "Children", "Childes", "Childern"],
                        correctAnswer: 1,
                        explanation: "The irregular plural of 'child' is 'children'.",
                        category: "primary",
                        subject: "english",
                        difficulty: "easy"
                    },
                    {
                        question: "Which word is a noun in this sentence: 'The quick brown fox jumps over the lazy dog'?",
                        options: ["quick", "jumps", "fox", "over"],
                        correctAnswer: 2,
                        explanation: "'Fox' is a noun - it's the name of an animal.",
                        category: "primary",
                        subject: "english",
                        difficulty: "medium"
                    },

                    // PRIMARY LEVEL - SOCIAL STUDIES
                    {
                        question: "Who was the first President of Ghana?",
                        options: ["Jerry John Rawlings", "Kwame Nkrumah", "John Agyekum Kufuor", "John Atta Mills"],
                        correctAnswer: 1,
                        explanation: "Dr. Kwame Nkrumah became Ghana's first President after independence in 1957.",
                        category: "primary",
                        subject: "social_studies",
                        difficulty: "easy"
                    },
                    {
                        question: "Which region in Ghana is known for its gold production?",
                        options: ["Ashanti Region", "Northern Region", "Volta Region", "Central Region"],
                        correctAnswer: 0,
                        explanation: "The Ashanti Region is famous for gold mining, particularly in Obuasi.",
                        category: "primary",
                        subject: "social_studies",
                        difficulty: "medium"
                    },

                    // JHS - MATHEMATICS
                    {
                        question: "Solve for x: 2x + 5 = 15",
                        options: ["x = 5", "x = 10", "x = 7.5", "x = 20"],
                        correctAnswer: 0,
                        explanation: "2x + 5 = 15 ‚Üí 2x = 10 ‚Üí x = 5",
                        category: "highschool",
                        subject: "mathematics",
                        difficulty: "easy"
                    },
                    {
                        question: "What is the area of a triangle with base 8cm and height 6cm?",
                        options: ["14 cm¬≤", "24 cm¬≤", "48 cm¬≤", "28 cm¬≤"],
                        correctAnswer: 1,
                        explanation: "Area = ¬Ω √ó base √ó height = ¬Ω √ó 8 √ó 6 = 24 cm¬≤",
                        category: "highschool",
                        subject: "mathematics",
                        difficulty: "medium"
                    },

                    // JHS - SCIENCE/PHYSICS
                    {
                        question: "Which of these is a vector quantity?",
                        options: ["Mass", "Speed", "Velocity", "Temperature"],
                        correctAnswer: 2,
                        explanation: "Velocity is a vector quantity because it has both magnitude and direction.",
                        category: "highschool",
                        subject: "physics",
                        difficulty: "medium"
                    },

                    // JHS - SCIENCE/CHEMISTRY
                    {
                        question: "What is the chemical symbol for gold?",
                        options: ["Go", "Gd", "Au", "Ag"],
                        correctAnswer: 2,
                        explanation: "The chemical symbol for gold is Au (from Latin 'aurum').",
                        category: "highschool",
                        subject: "chemistry",
                        difficulty: "easy"
                    },

                    // JHS - SCIENCE/BIOLOGY
                    {
                        question: "Which cell organelle is known as the 'powerhouse of the cell'?",
                        options: ["Nucleus", "Mitochondria", "Ribosome", "Chloroplast"],
                        correctAnswer: 1,
                        explanation: "Mitochondria produce energy (ATP) for the cell through cellular respiration.",
                        category: "highschool",
                        subject: "biology",
                        difficulty: "easy"
                    },

                    // JHS - HISTORY
                    {
                        question: "In which year did Ghana gain independence?",
                        options: ["1951", "1957", "1960", "1945"],
                        correctAnswer: 1,
                        explanation: "Ghana gained independence from British colonial rule on March 6, 1957.",
                        category: "highschool",
                        subject: "history",
                        difficulty: "easy"
                    },

                    // JHS - GEOGRAPHY
                    {
                        question: "What is the capital city of the Northern Region?",
                        options: ["Tamale", "Bolgatanga", "Wa", "Yendi"],
                        correctAnswer: 0,
                        explanation: "Tamale is the capital city of the Northern Region.",
                        category: "highschool",
                        subject: "geography",
                        difficulty: "easy"
                    },

                    // SHS - MATHEMATICS (ADVANCED)
                    {
                        question: "Differentiate: y = 3x¬≤ + 2x - 5",
                        options: ["dy/dx = 6x + 2", "dy/dx = 3x + 2", "dy/dx = 6x", "dy/dx = 3x¬≤ + 2"],
                        correctAnswer: 0,
                        explanation: "Using power rule: d/dx(3x¬≤) = 6x, d/dx(2x) = 2, d/dx(-5) = 0",
                        category: "highschool",
                        subject: "mathematics",
                        difficulty: "hard"
                    },

                    // SHS - PHYSICS (ADVANCED)
                    {
                        question: "According to Ohm's Law, what is the relationship between voltage (V), current (I), and resistance (R)?",
                        options: ["V = I/R", "V = I √ó R", "V = R/I", "I = V √ó R"],
                        correctAnswer: 1,
                        explanation: "Ohm's Law states that Voltage = Current √ó Resistance (V = I √ó R)",
                        category: "highschool",
                        subject: "physics",
                        difficulty: "medium"
                    },

                    // TERTIARY - PROGRAMMING
                    {
                        question: "Which of these is NOT a programming language?",
                        options: ["Python", "Java", "HTML", "C++"],
                        correctAnswer: 2,
                        explanation: "HTML is a markup language, not a programming language.",
                        category: "tertiary",
                        subject: "programming",
                        difficulty: "easy"
                    },

                    // TERTIARY - BUSINESS
                    {
                        question: "What does ROI stand for in business?",
                        options: ["Return on Investment", "Rate of Interest", "Return on Income", "Rate of Investment"],
                        correctAnswer: 0,
                        explanation: "ROI stands for Return on Investment - a measure of profitability.",
                        category: "tertiary",
                        subject: "business",
                        difficulty: "easy"
                    },

                    // TERTIARY - ENGINEERING
                    {
                        question: "What is the SI unit of electrical resistance?",
                        options: ["Volt", "Ampere", "Ohm", "Watt"],
                        correctAnswer: 2,
                        explanation: "The ohm (Œ©) is the SI unit of electrical resistance.",
                        category: "tertiary",
                        subject: "engineering",
                        difficulty: "easy"
                    },

                    // TERTIARY - MEDICINE
                    {
                        question: "What is the normal human body temperature in Celsius?",
                        options: ["35¬∞C", "36¬∞C", "37¬∞C", "38¬∞C"],
                        correctAnswer: 2,
                        explanation: "Normal human body temperature is approximately 37¬∞C (98.6¬∞F).",
                        category: "tertiary",
                        subject: "medicine",
                        difficulty: "easy"
                    },

                    // TERTIARY - LAW
                    {
                        question: "What is the supreme law of Ghana?",
                        options: ["The Criminal Code", "The 1992 Constitution", "The Courts Act", "The Chieftaincy Act"],
                        correctAnswer: 1,
                        explanation: "The 1992 Constitution is the supreme law of Ghana.",
                        category: "tertiary",
                        subject: "law",
                        difficulty: "easy"
                    },

                    // TERTIARY - ECONOMICS
                    {
                        question: "What does GDP stand for?",
                        options: ["Gross Domestic Product", "General Domestic Price", "Gross Development Product", "General Development Progress"],
                        correctAnswer: 0,
                        explanation: "GDP stands for Gross Domestic Product - the total value of goods and services produced.",
                        category: "tertiary",
                        subject: "economics",
                        difficulty: "easy"
                    }
                ];
            },
            
            getQuestionStatistics() {
                const allQuestions = this.getAllGhanaQuestions();
                const statistics = {
                    totalQuestions: allQuestions.length,
                    byCategory: {},
                    byDifficulty: {
                        easy: 0,
                        medium: 0,
                        hard: 0
                    },
                    bySubject: {}
                };
                
                allQuestions.forEach(q => {
                    // Count by category
                    if (!statistics.byCategory[q.category]) {
                        statistics.byCategory[q.category] = {};
                    }
                    if (!statistics.byCategory[q.category][q.subject]) {
                        statistics.byCategory[q.category][q.subject] = 0;
                    }
                    statistics.byCategory[q.category][q.subject]++;
                    
                    // Count by difficulty
                    statistics.byDifficulty[q.difficulty]++;
                    
                    // Count by subject
                    if (!statistics.bySubject[q.subject]) {
                        statistics.bySubject[q.subject] = 0;
                    }
                    statistics.bySubject[q.subject]++;
                });
                
                return statistics;
            },
            
            getQuestionsByCategory() {
                const allQuestions = this.getAllGhanaQuestions();
                const categories = {};
                
                allQuestions.forEach(q => {
                    if (!categories[q.category]) categories[q.category] = {};
                    if (!categories[q.category][q.subject]) categories[q.category][q.subject] = 0;
                    categories[q.category][q.subject]++;
                });
                
                return categories;
            },
            
            getQuestionsByDifficulty() {
                const allQuestions = this.getAllGhanaQuestions();
                const difficulties = { easy: 0, medium: 0, hard: 0 };
                
                allQuestions.forEach(q => {
                    difficulties[q.difficulty]++;
                });
                
                return difficulties;
            },
            
            async loadQuestionsChunk(category, subject, chunkSize = 10) {
                console.log(`üìö Loading ${chunkSize} questions for ${category}/${subject}`);
                
                const allQuestions = this.getGhanaCurriculumQuestions(category, subject, 'all', 100);
                const shuffled = this.shuffleArray([...allQuestions]);
                
                return shuffled.slice(0, chunkSize);
            },
            
            preloadNextQuestions(currentCategory, currentSubject) {
                // Preload next set of questions in background
                setTimeout(() => {
                    this.loadQuestionsChunk(currentCategory, currentSubject, 10)
                        .then(questions => {
                            console.log(`üìö Preloaded ${questions.length} questions for next game`);
                        })
                        .catch(error => {
                            console.log('Preloading failed:', error);
                        });
                }, 1000);
            },
            
            shuffleArray(array) {
                const shuffled = [...array];
                for (let i = shuffled.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
                }
                return shuffled;
            }
        };

        // Category Manager with Ghanaian Curriculum
        const categoryManager = {
            categories: {
                primary: {
                    name: "Primary School (Basic 1-6)",
                    subjects: ["mathematics", "science", "english", "social_studies"],
                    difficulties: ["easy", "medium"],
                    description: "Basic Education Certificate Examination (BECE) level"
                },
                highschool: {
                    name: "Junior & Senior High School", 
                    subjects: ["mathematics", "physics", "chemistry", "biology", "history", "geography"],
                    difficulties: ["easy", "medium", "hard"],
                    description: "West African Senior School Certificate Examination (WASSCE) level"
                },
                tertiary: {
                    name: "Tertiary Education",
                    subjects: ["programming", "business", "engineering", "medicine", "law", "economics"],
                    difficulties: ["medium", "hard"],
                    description: "University and College level education"
                }
            },
            currentCategory: null,
            currentSubject: null,
            
            init() {
                console.log('üéØ Category manager initialized');
                this.setupEventListeners();
            },
            
            setupEventListeners() {
                document.querySelectorAll('.category-card').forEach(card => {
                    card.addEventListener('click', () => {
                        this.selectCategory(card.dataset.category);
                    });
                    card.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter' || e.key === ' ') {
                            this.selectCategory(card.dataset.category);
                        }
                    });
                });
                
                const backButton = document.getElementById('back-to-categories');
                if (backButton) {
                    backButton.addEventListener('click', () => {
                        this.showCategorySelection();
                    });
                }
                
            },
            
          

            selectCategory(categoryId) {
                document.querySelectorAll('.category-card').forEach(card => {
                    card.classList.remove('selected', 'border-primary');
                    card.setAttribute('aria-selected', 'false');
                });
                
                const selectedCard = document.querySelector(`[data-category="${categoryId}"]`);
                if (selectedCard) {
                    selectedCard.classList.add('selected', 'border-primary');
                    selectedCard.setAttribute('aria-selected', 'true');
                    selectedCard.focus();
                }
                
                this.currentCategory = categoryId;
                const category = this.categories[categoryId];
                
                if (!category) {
                    this.showError('Category not found. Please try again.');
                    return;
                }
                
                this.showSubjectSelection(category);
            },
            
            showSubjectSelection(category) {
                document.getElementById('category-title').textContent = `Select Subject - ${category.name}`;
                
                const container = document.getElementById('subjects-container');
                container.innerHTML = '';
                
                const subjectNames = {
                    mathematics: { icon: 'fa-calculator', color: 'primary', name: 'Mathematics' },
                    science: { icon: 'fa-flask', color: 'success', name: 'Integrated Science' },
                    english: { icon: 'fa-language', color: 'info', name: 'English Language' },
                    social_studies: { icon: 'fa-globe-africa', color: 'warning', name: 'Social Studies' },
                    physics: { icon: 'fa-atom', color: 'danger', name: 'Physics' },
                    chemistry: { icon: 'fa-vial', color: 'success', name: 'Chemistry' },
                    biology: { icon: 'fa-dna', color: 'success', name: 'Biology' },
                    history: { icon: 'fa-landmark', color: 'warning', name: 'History' },
                    geography: { icon: 'fa-map', color: 'info', name: 'Geography' },
                    programming: { icon: 'fa-code', color: 'dark', name: 'Computer Science' },
                    business: { icon: 'fa-chart-line', color: 'success', name: 'Business Studies' },
                    engineering: { icon: 'fa-cogs', color: 'info', name: 'Engineering' },
                    medicine: { icon: 'fa-heartbeat', color: 'danger', name: 'Medicine' },
                    law: { icon: 'fa-gavel', color: 'warning', name: 'Law' },
                    economics: { icon: 'fa-money-bill-wave', color: 'success', name: 'Economics' }
                };
                
                category.subjects.forEach(subjectId => {
                    const subject = subjectNames[subjectId] || { 
                        icon: 'fa-book', 
                        color: 'secondary', 
                        name: subjectId 
                    };
                    
                    const col = document.createElement('div');
                    col.className = 'col-md-4 col-sm-6 mb-4';
                    col.innerHTML = `
                        <div class="card subject-card h-100" data-subject="${subjectId}" 
                             role="button" aria-label="Select ${subject.name} subject" tabindex="0">
                            <div class="card-body text-center d-flex flex-column">
                                <i class="fas ${subject.icon} fa-2x mb-3 text-${subject.color}" aria-hidden="true"></i>
                                <h5 class="card-title">${subject.name}</h5>
                                <p class="card-text small flex-grow-1">${category.description}</p>
                                <div class="mt-2">
                                    ${this.getDifficultyBadges(category.difficulties)}
                                </div>
                            </div>
                        </div>
                    `;
                    container.appendChild(col);
                });
                
                setTimeout(() => {
                    document.querySelectorAll('.subject-card').forEach(card => {
                        card.addEventListener('click', () => {
                            this.selectSubject(card.dataset.subject);
                        });
                        card.addEventListener('keypress', (e) => {
                            if (e.key === 'Enter' || e.key === ' ') {
                                this.selectSubject(card.dataset.subject);
                            }
                        });
                    });
                }, 100);
                
                this.showScreen('subject-selection');
            },
            
            getDifficultyBadges(difficulties) {
                const difficultyColors = {
                    easy: 'success',
                    medium: 'warning',
                    hard: 'danger'
                };
                
                return difficulties.map(diff => 
                    `<span class="badge bg-${difficultyColors[diff]} me-1">${diff}</span>`
                ).join('');
            },
            
            getSubjectDisplayName(subjectId) {
                const subjectNames = {
                    mathematics: { icon: 'fa-calculator', color: 'primary', name: 'Mathematics' },
                    science: { icon: 'fa-flask', color: 'success', name: 'Integrated Science' },
                    english: { icon: 'fa-language', color: 'info', name: 'English Language' },
                    social_studies: { icon: 'fa-globe-africa', color: 'warning', name: 'Social Studies' },
                    physics: { icon: 'fa-atom', color: 'danger', name: 'Physics' },
                    chemistry: { icon: 'fa-vial', color: 'success', name: 'Chemistry' },
                    biology: { icon: 'fa-dna', color: 'success', name: 'Biology' },
                    history: { icon: 'fa-landmark', color: 'warning', name: 'History' },
                    geography: { icon: 'fa-map', color: 'info', name: 'Geography' },
                    programming: { icon: 'fa-code', color: 'dark', name: 'Computer Science' },
                    business: { icon: 'fa-chart-line', color: 'success', name: 'Business Studies' },
                    engineering: { icon: 'fa-cogs', color: 'info', name: 'Engineering' },
                    medicine: { icon: 'fa-heartbeat', color: 'danger', name: 'Medicine' },
                    law: { icon: 'fa-gavel', color: 'warning', name: 'Law' },
                    economics: { icon: 'fa-money-bill-wave', color: 'success', name: 'Economics' }
                };
                return subjectNames[subjectId] || { icon: 'fa-book', color: 'secondary', name: subjectId };
            },
            
            selectSubject(subjectId) {
                document.querySelectorAll('.subject-card').forEach(card => {
                    card.classList.remove('selected', 'border-primary');
                    card.setAttribute('aria-selected', 'false');
                });
                
                const selectedCard = document.querySelector(`[data-subject="${subjectId}"]`);
                if (selectedCard) {
                    selectedCard.classList.add('selected', 'border-primary');
                    selectedCard.setAttribute('aria-selected', 'true');
                    selectedCard.focus();
                }
                
                this.currentSubject = subjectId;
            },
            
            showCategorySelection() {
                this.showScreen('category-selection');
                this.currentCategory = null;
                this.currentSubject = null;
            },
            
            showScreen(screenName) {
                const screens = [
                    'category-selection',
                    'subject-selection', 
                    'multiplayer-setup',
                    'multiplayer-lobby',
                    'quiz-screen',
                    'results-screen',
                    'multiplayer-quiz-screen',
                    'multiplayer-results-screen'
                ];
                
                screens.forEach(screen => {
                    const element = document.getElementById(screen);
                    if (element) {
                        element.classList.add('d-none');
                        element.setAttribute('aria-hidden', 'true');
                    }
                });
                
                const targetScreen = document.getElementById(screenName);
                if (targetScreen) {
                    targetScreen.classList.remove('d-none');
                    targetScreen.setAttribute('aria-hidden', 'false');
                    currentState.screen = screenName;
                    
                    const mainHeading = targetScreen.querySelector('h1, h2, h3');
                    if (mainHeading) {
                        setTimeout(() => mainHeading.focus(), 100);
                    }
                }
            },
            
            getCurrentSettings() {
                return {
                    category: this.currentCategory,
                    subject: this.currentSubject,
                    difficulty: document.getElementById('difficulty-select').value,
                    questionCount: parseInt(document.getElementById('question-count').value),
                    questionSource: document.getElementById('question-source').value,
                    gameMode: document.querySelector('input[name="gameMode"]:checked').value
                };
            },
            
            showError(message) {
                const errorElement = document.getElementById('error-message');
                const errorText = document.getElementById('error-text');
                if (errorElement && errorText) {
                    errorText.textContent = message;
                    errorElement.style.display = 'block';
                    errorElement.setAttribute('aria-live', 'assertive');
                    
                    setTimeout(() => {
                        errorElement.style.display = 'none';
                    }, 5000);
                }
            },
            
            showSuccess(message) {
                const successElement = document.getElementById('success-message');
                const successText = document.getElementById('success-text');
                if (successElement && successText) {
                    successText.textContent = message;
                    successElement.style.display = 'block';
                    successElement.setAttribute('aria-live', 'polite');
                    
                    setTimeout(() => {
                        successElement.style.display = 'none';
                    }, 3000);
                }
            },
            
            showInfo(message) {
                console.log('‚ÑπÔ∏è ' + message);
            },
            
            showLoading(show) {
                const loadingElement = document.getElementById('loading-spinner');
                if (loadingElement) {
                    loadingElement.style.display = show ? 'block' : 'none';
                    loadingElement.setAttribute('aria-live', 'polite');
                    loadingElement.setAttribute('aria-label', show ? 'Loading content' : '');
                }
            }
        };

        // Single Player System
        const singlePlayerSystem = {
            currentGame: null,
            timerInterval: null,
            timeLeft: 0,
            lastTimerUpdate: 0,
            
            init() {
                console.log('üéÆ Single player system initialized');
            },
            
            async startGame(category, subject, playerName, avatar, difficulty, questionCount, questionSource) {
                try {
                    const startBtn = document.getElementById('start-quiz-btn');
                    buttonManager.setLoading(startBtn, true, 'Starting Game...');
                    
                    const questionResult = await questionManager.getQuestions({
                        category: category,
                        subject: subject,
                        difficulty: difficulty,
                        questionCount: questionCount,
                        questionSource: questionSource
                    });
                    
                    if (questionResult.questions.length === 0) {
                        categoryManager.showError('No questions available.');
                        buttonManager.setLoading(startBtn, false, 'Start Quiz');
                        return false;
                    }
                    
                    this.currentGame = {
                        category: category,
                        subject: subject,
                        playerName: playerName,
                        avatar: avatar,
                        questions: questionResult.questions,
                        currentQuestion: 0,
                        answers: [],
                        score: 0,
                        startTime: Date.now(),
                        timePerQuestion: 30,
                        achievements: [],
                        questionSource: questionResult.source
                    };
                    
                    this.loadQuestion(0);
                    this.startTimer();
                    
                    // Update with Ghana curriculum info
                    this.updateGhanaCurriculumInfo();
                    
                    buttonManager.setLoading(startBtn, false, 'Start Quiz');
                    return true;
                    
                } catch (error) {
                    console.error('Error starting game:', error);
                    categoryManager.showError('Error starting game. Please try again.');
                    const startBtn = document.getElementById('start-quiz-btn');
                    buttonManager.setLoading(startBtn, false, 'Start Quiz');
                    return false;
                }
            },
            
            updateGhanaCurriculumInfo() {
                if (!this.currentGame) return;
                
                const examInfo = {
                    primary: "BECE Curriculum",
                    highschool: "WASSCE Curriculum", 
                    tertiary: "Tertiary Education"
                };
                
                const subjectInfo = categoryManager.getSubjectDisplayName(this.currentGame.subject);
                const infoElement = document.getElementById('current-subject');
                
                if (infoElement) {
                    infoElement.textContent = `${subjectInfo.name} - ${examInfo[this.currentGame.category]}`;
                }
            },
            
            loadQuestion(questionIndex) {
                if (!this.currentGame || questionIndex >= this.currentGame.questions.length) {
                    this.finishGame();
                    return;
                }
                
                this.currentGame.currentQuestion = questionIndex;
                const question = this.currentGame.questions[questionIndex];
                
                document.getElementById('current-subject').textContent = 
                    `${this.currentGame.category} - ${this.currentGame.subject}`;
                
                document.getElementById('question-count-display').textContent = 
                    `Question ${questionIndex + 1} of ${this.currentGame.questions.length}`;
                
                document.getElementById('question-text').textContent = question.question;
                
                const progress = ((questionIndex) / this.currentGame.questions.length) * 100;
                document.getElementById('progress-bar').style.width = `${progress}%`;
                document.getElementById('progress-bar').setAttribute('aria-valuenow', progress);
                
                const optionsContainer = document.getElementById('options-container');
                optionsContainer.innerHTML = '';
                
                question.options.forEach((option, index) => {
                    const optionElement = document.createElement('div');
                    optionElement.className = 'option';
                    optionElement.setAttribute('role', 'button');
                    optionElement.setAttribute('aria-label', `Option ${String.fromCharCode(65 + index)}: ${option}`);
                    optionElement.setAttribute('tabindex', '0');
                    optionElement.innerHTML = `
                        <div class="option-content">
                            <div class="option-letter">${String.fromCharCode(65 + index)}</div>
                            <div class="option-text">${option}</div>
                        </div>
                    `;
                    
                    optionElement.addEventListener('click', () => {
                        this.selectAnswer(index);
                    });
                    
                    optionElement.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter' || e.key === ' ') {
                            this.selectAnswer(index);
                        }
                    });
                    
                    optionsContainer.appendChild(optionElement);
                });
                
                this.resetTimer();
                
                document.getElementById('prev-question').style.display = 
                    questionIndex > 0 ? 'inline-block' : 'none';
                
                document.getElementById('next-question').style.display = 
                    questionIndex < this.currentGame.questions.length - 1 ? 'inline-block' : 'none';
                
                document.getElementById('submit-quiz').style.display = 
                    questionIndex === this.currentGame.questions.length - 1 ? 'inline-block' : 'none';
                
                const feedbackElement = document.getElementById('question-feedback');
                if (feedbackElement) {
                    feedbackElement.classList.remove('show');
                }
                
                categoryManager.showScreen('quiz-screen');
            },
            
            selectAnswer(optionIndex) {
                const question = this.currentGame.questions[this.currentGame.currentQuestion];
                const options = document.querySelectorAll('.option');
                
                options.forEach(opt => {
                    opt.style.pointerEvents = 'none';
                    opt.classList.remove('selected', 'correct', 'incorrect');
                });
                
                options[optionIndex].classList.add('selected');
                
                const isCorrect = optionIndex === question.correctAnswer;
                
                if (isCorrect) {
                    soundSystem.play('correct');
                    options[optionIndex].classList.add('correct');
                } else {
                    soundSystem.play('wrong');
                    options[optionIndex].classList.add('incorrect');
                    if (question.correctAnswer >= 0 && question.correctAnswer < options.length) {
                        options[question.correctAnswer].classList.add('correct');
                    }
                }
                
                const feedbackElement = document.getElementById('question-feedback');
                const feedbackText = document.getElementById('feedback-text');
                
                if (feedbackElement && feedbackText) {
                    feedbackElement.className = `question-feedback ${isCorrect ? 'correct' : 'incorrect'} show`;
                    feedbackText.textContent = question.explanation || 
                        (isCorrect ? 'Correct! Well done.' : `Incorrect. The right answer is ${String.fromCharCode(65 + question.correctAnswer)}.`);
                    feedbackElement.setAttribute('aria-live', 'assertive');
                }
                
                this.currentGame.answers[this.currentGame.currentQuestion] = {
                    selected: optionIndex,
                    isCorrect: isCorrect,
                    timeSpent: this.currentGame.timePerQuestion - this.timeLeft
                };
                
                if (isCorrect) {
                    this.currentGame.score += 10;
                }
                
                setTimeout(() => {
                    this.nextQuestion();
                }, 3000);
            },
            
            nextQuestion() {
                if (this.currentGame.currentQuestion < this.currentGame.questions.length - 1) {
                    this.loadQuestion(this.currentGame.currentQuestion + 1);
                } else {
                    this.finishGame();
                }
            },
            
            prevQuestion() {
                if (this.currentGame.currentQuestion > 0) {
                    this.loadQuestion(this.currentGame.currentQuestion - 1);
                }
            },
            
            submitQuiz() {
                this.finishGame();
            },
            
            finishGame() {
                clearInterval(this.timerInterval);
                
                let correctAnswers = 0;
                this.currentGame.questions.forEach((question, index) => {
                    if (this.currentGame.answers[index] && this.currentGame.answers[index].isCorrect) {
                        correctAnswers++;
                    }
                });
                
                this.currentGame.score = correctAnswers * 10;
                this.currentGame.endTime = Date.now();
                
                const timeTaken = Math.floor((this.currentGame.endTime - this.currentGame.startTime) / 1000);
                
                // Track analytics
                trackGameCompletion({
                    mode: 'single',
                    category: this.currentGame.category,
                    subject: this.currentGame.subject,
                    score: this.currentGame.score,
                    duration: timeTaken,
                    questionsAnswered: this.currentGame.questions.length,
                    correctAnswers: correctAnswers
                });
                
                this.showResults(correctAnswers, timeTaken);
            },
            
            showResults(correctAnswers, timeTaken) {
                const totalQuestions = this.currentGame.questions.length;
                const percentage = Math.round((correctAnswers / totalQuestions) * 100);
                
                document.getElementById('final-score').textContent = `${correctAnswers}/${totalQuestions}`;
                document.getElementById('points-earned').textContent = this.currentGame.score;
                
                const statsContainer = document.getElementById('performance-stats');
                statsContainer.innerHTML = `
                    <div class="row text-center">
                        <div class="col-md-3 mb-3">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h3 class="text-primary">${percentage}%</h3>
                                    <p class="mb-0">Score</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h3 class="text-success">${correctAnswers}</h3>
                                    <p class="mb-0">Correct</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h3 class="text-danger">${totalQuestions - correctAnswers}</h3>
                                    <p class="mb-0">Incorrect</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h3 class="text-info">${Math.floor(timeTaken / 60)}:${(timeTaken % 60).toString().padStart(2, '0')}</h3>
                                    <p class="mb-0">Time</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                if (percentage >= 80) {
                    document.getElementById('confetti').style.display = 'block';
                    soundSystem.play('victory');
                    
                    setTimeout(() => {
                        document.getElementById('confetti').style.display = 'none';
                    }, 5000);
                }
                
                categoryManager.showScreen('results-screen');
            },
            
            startTimer() {
                this.timeLeft = this.currentGame.timePerQuestion;
                this.lastTimerUpdate = Date.now();
                this.updateTimerDisplay();
                
                this.timerInterval = setInterval(() => {
                    const now = Date.now();
                    const delta = now - this.lastTimerUpdate;
                    
                    if (delta >= 1000) {
                        this.timeLeft--;
                        this.lastTimerUpdate = now;
                        this.updateTimerDisplay();
                        
                        if (this.timeLeft <= 0) {
                            clearInterval(this.timerInterval);
                            this.nextQuestion();
                        }
                    }
                }, 100);
            },
            
            resetTimer() {
                clearInterval(this.timerInterval);
                this.startTimer();
            },
            
            updateTimerDisplay() {
                const timerElement = document.getElementById('time-left');
                if (timerElement) {
                    timerElement.textContent = this.timeLeft;
                    timerElement.className = `timer ${this.timeLeft <= 10 ? 'warning' : ''} ${this.timeLeft <= 5 ? 'danger' : ''}`;
                    timerElement.setAttribute('aria-label', `${this.timeLeft} seconds remaining`);
                }
            }
        };

        // Enhanced Chat System
        const chatSystem = {
            messages: [],
            
            init() {
                console.log('üí¨ Chat system initialized');
                this.createChatInterface();
            },
            
            createChatInterface() {
                const multiplayerScreens = ['multiplayer-lobby', 'multiplayer-quiz-screen'];
                
                multiplayerScreens.forEach(screenId => {
                    const screen = document.getElementById(screenId);
                    if (screen && !screen.querySelector('.chat-container')) {
                        const chatHTML = `
                            <div class="chat-container mt-4">
                                <div class="card">
                                    <div class="card-header d-flex justify-content-between align-items-center">
                                        <h6 class="mb-0"><i class="fas fa-comments me-2"></i>Game Chat</h6>
                                        <span class="badge bg-primary" id="chat-indicator">Live</span>
                                    </div>
                                    <div class="card-body p-0">
                                        <div id="chat-messages-${screenId}" class="chat-messages" style="height: 150px; overflow-y: auto; padding: 10px;"></div>
                                        <div class="chat-input-container p-2 border-top">
                                            <div class="input-group">
                                                <input type="text" 
                                                       id="chat-input-${screenId}" 
                                                       class="form-control" 
                                                       placeholder="Type a message..." 
                                                       aria-label="Chat message"
                                                       maxlength="200">
                                                <button class="btn btn-primary" id="send-chat-${screenId}" type="button">
                                                    <i class="fas fa-paper-plane"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                        
                        screen.insertAdjacentHTML('beforeend', chatHTML);
                    }
                });
                
                this.setupChatListeners();
            },
            
            setupChatListeners() {
                const screens = ['multiplayer-lobby', 'multiplayer-quiz-screen'];
                
                screens.forEach(screenId => {
                    const chatInput = document.getElementById(`chat-input-${screenId}`);
                    const sendButton = document.getElementById(`send-chat-${screenId}`);
                    
                    if (chatInput && sendButton) {
                        sendButton.addEventListener('click', () => this.sendMessage(screenId));
                        chatInput.addEventListener('keypress', (e) => {
                            if (e.key === 'Enter') {
                                this.sendMessage(screenId);
                            }
                        });
                    }
                });
            },
            
            async sendMessage(screenId) {
                const chatInput = document.getElementById(`chat-input-${screenId}`);
                const message = chatInput.value.trim();
                
                if (!message) return;
                
                const playerName = document.getElementById('mp-player-name')?.value || 'Player';
                
                this.addMessage(playerName, message, false, screenId);
                
                if (connectionManager.isConnected && multiplayerSystem.currentRoom) {
                    await connectionManager.emit('chatMessage', {
                        roomCode: multiplayerSystem.currentRoom.code,
                        message: message,
                        playerName: playerName,
                        playerId: multiplayerSystem.playerId
                    });
                }
                
                chatInput.value = '';
                chatInput.focus();
            },
            
            handleIncomingMessage(data) {
                if (multiplayerSystem.currentRoom && data.roomCode === multiplayerSystem.currentRoom.code) {
                    if (data.playerId !== multiplayerSystem.playerId) {
                        this.addMessage(data.playerName, data.message, false);
                    }
                }
            },
            
            addMessage(playerName, message, isSystem = false, screenId = null) {
                const timestamp = new Date().toLocaleTimeString();
                const messageObj = {
                    playerName: playerName,
                    message: message,
                    isSystem: isSystem,
                    timestamp: timestamp
                };
                
                this.messages.push(messageObj);
                
                const screens = screenId ? [screenId] : ['multiplayer-lobby', 'multiplayer-quiz-screen'];
                
                screens.forEach(screen => {
                    const chatContainer = document.getElementById(`chat-messages-${screen}`);
                    if (chatContainer && document.getElementById(screen) && !document.getElementById(screen).classList.contains('d-none')) {
                        const messageElement = document.createElement('div');
                        messageElement.className = `chat-message ${isSystem ? 'system-message' : ''} ${playerName === (document.getElementById('mp-player-name')?.value || 'Player') ? 'own-message' : ''}`;
                        messageElement.innerHTML = `
                            <div class="message-header">
                                ${!isSystem ? `<strong>${playerName}</strong>` : '<em>System</em>'}
                                <small class="text-muted ms-2">${timestamp}</small>
                            </div>
                            <div class="message-content">${this.escapeHtml(message)}</div>
                        `;
                        chatContainer.appendChild(messageElement);
                        chatContainer.scrollTop = chatContainer.scrollHeight;
                    }
                });
            },
            
            addSystemMessage(message, screenId = null) {
                this.addMessage('', message, true, screenId);
            },
            
            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
        };

        // Enhanced Multiplayer System with Backend Compatibility
      // In index.html - Update the multiplayerSystem object
const multiplayerSystem = {
    currentRoom: null,
    players: [],
    gameState: null,
    timerInterval: null,
    timeLeft: 0,
    lastTimerUpdate: 0,
    playerId: null,
    
    init() {
        console.log('üéÆ Multiplayer system initialized for real players only');
        this.playerId = this.generatePlayerId();
        this.setupSocketListeners();
        this.createMissingScreens();
    },

    // Enhanced joinRoom method - remove demo players
    async joinRoom(roomCode) {
        const joinBtn = document.getElementById('join-room-btn');
        buttonManager.setLoading(joinBtn, true, 'Joining Room...');
        
        try {
            const playerName = document.getElementById('mp-player-name').value || 'Player';
            const avatar = avatarSystem.selectedAvatar;

            if (!roomCode || roomCode.length !== 4) {
                categoryManager.showError('Please enter a valid 4-character room code');
                return false;
            }

            storageManager.savePreferences();
            categoryManager.showLoading(true);

            // Join room on server
            const result = await connectionManager.emit('joinRoom', {
                roomCode: roomCode.toUpperCase(),
                playerName: playerName,
                avatar: avatar
            });

            if (!result.success) {
                throw new Error(result.error || 'Failed to join room');
            }

            // Set up temporary room while waiting for server response
            this.currentRoom = {
                code: roomCode.toUpperCase(),
                status: 'waiting'
            };

            this.players = [{
                id: this.playerId,
                name: playerName,
                avatar: avatar,
                score: 0,
                isHost: false,
                hasAnswered: false,
                ready: true
            }];

            this.updateLobbyDisplay();
            categoryManager.showScreen('multiplayer-lobby');
            categoryManager.showSuccess(`Joining room: ${roomCode}`);

            return true;

        } catch (error) {
            console.error('Error joining room:', error);
            categoryManager.showError(error.message || 'Failed to join room. Please check the room code.');
            return false;
        } finally {
            categoryManager.showLoading(false);
            buttonManager.setLoading(joinBtn, false, 'Join Room');
        }
    },

    // Enhanced room creation - remove demo players
    async createRoom(settings) {
        const createBtn = document.getElementById('create-room-btn');
        buttonManager.setLoading(createBtn, true, 'Creating Room...');
        
        try {
            console.log('üéÆ Creating multiplayer room for real players...');
            
            const playerName = document.getElementById('mp-player-name').value || 'Player';
            const avatar = avatarSystem.selectedAvatar;
            
            storageManager.savePreferences();
            
            // Create room on server
            const result = await connectionManager.emit('createRoom', {
                playerName: playerName,
                avatar: avatar,
                settings: settings
            });
            
            if (!result.success) {
                throw new Error(result.error || 'Failed to create room');
            }
            
            // Set up a temporary room while waiting for server response
            this.currentRoom = {
                code: 'WAIT', // Temporary, will be updated by server
                host: this.playerId,
                settings: settings,
                status: 'waiting'
            };
            
            this.players = [{
                id: this.playerId,
                name: playerName,
                avatar: avatar,
                score: 0,
                isHost: true,
                hasAnswered: false,
                ready: true
            }];
            
            this.updateLobbyDisplay();
            categoryManager.showScreen('multiplayer-lobby');
            categoryManager.showSuccess('Creating room...');
            chatSystem.addSystemMessage('Room created. Share the room code with other players to join!', 'multiplayer-lobby');
            
            return true;
            
        } catch (error) {
            console.error('Error creating room:', error);
            categoryManager.showError(error.message || 'Failed to create room. Please try again.');
            return false;
        } finally {
            buttonManager.setLoading(createBtn, false, 'Create Room');
        }
    },

    // Enhanced lobby display for real players
    updateLobbyDisplay() {
        const roomCodeElement = document.getElementById('room-code');
        const playerCountElement = document.getElementById('player-count');
        const playersList = document.getElementById('players-list');
        const startButton = document.getElementById('start-game-btn');
        const startHint = document.getElementById('start-game-hint');

        if (roomCodeElement && this.currentRoom) {
            roomCodeElement.textContent = this.currentRoom.code || '----';
        }

        if (playerCountElement) {
            playerCountElement.textContent = `${this.players.length} player(s)`;
            playerCountElement.setAttribute('aria-label', `${this.players.length} players in room`);
        }

        if (playersList) {
            // Clear any waiting messages first
            const existingMessages = playersList.parentNode.querySelectorAll('.waiting-message');
            existingMessages.forEach(msg => msg.remove());

            // Show waiting message if only one player
            if (this.players.length === 1) {
                const waitingMessage = document.createElement('div');
                waitingMessage.className = 'alert alert-info text-center waiting-message';
                waitingMessage.innerHTML = `
                    <i class="fas fa-users me-2" aria-hidden="true"></i>
                    <strong>Waiting for players to join...</strong><br>
                    <small>Share this room code: <code class="fs-5">${this.currentRoom?.code}</code></small><br>
                    <small class="text-muted">Other players can join using the "Join Room" option</small>
                `;
                playersList.parentNode.insertBefore(waitingMessage, playersList);
            }

            // Render actual players
            playersList.innerHTML = this.players.map(player => `
                <div class="player-item ${player.id === this.playerId ? 'current-player' : ''}" role="listitem">
                    <div class="multiplayer-avatar me-2" aria-hidden="true">${player.avatar}</div>
                    <div class="flex-grow-1">
                        <strong>${player.name}</strong>
                        ${player.id === this.playerId ? '<span class="badge bg-primary ms-2">You</span>' : ''}
                    </div>
                    ${player.isHost ? '<span class="badge bg-warning me-2">Host</span>' : ''}
                    ${player.ready ? '<span class="badge bg-success me-2"><i class="fas fa-check"></i> Ready</span>' : '<span class="badge bg-secondary me-2"><i class="fas fa-clock"></i> Waiting</span>'}
                </div>
            `).join('');
        }

        if (startButton && startHint && this.currentRoom) {
            const isHost = this.players.find(p => p.id === this.playerId)?.isHost || false;
            const canStart = this.players.length >= 2 && this.players.every(p => p.ready);

            startButton.style.display = isHost ? 'block' : 'none';
            startButton.disabled = !canStart;

            if (isHost) {
                if (this.players.length < 2) {
                    startHint.textContent = `Need ${2 - this.players.length} more player(s) to start`;
                    startHint.className = 'text-warning';
                } else if (!this.players.every(p => p.ready)) {
                    startHint.textContent = 'Waiting for all players to be ready';
                    startHint.className = 'text-warning';
                } else {
                    startHint.textContent = 'All players ready! You can start the game';
                    startHint.className = 'text-success';
                }
            } else {
                startHint.textContent = 'Waiting for host to start the game...';
                startHint.className = 'text-muted';
            }
        }
    },

    // Remove the addDemoPlayers function entirely
    // Remove this function: addDemoPlayers()

    // Enhanced startGame with real player validation
    async startGame() {
        if (!this.currentRoom) {
            categoryManager.showError('No room found');
            return;
        }

        const currentPlayer = this.players.find(p => p.id === this.playerId);
        if (!currentPlayer?.isHost) {
            categoryManager.showError('Only the host can start the game');
            return;
        }

        if (this.players.length < 2) {
            categoryManager.showError('Need at least 2 players to start the game');
            return;
        }

        if (!this.players.every(p => p.ready)) {
            categoryManager.showError('All players must be ready before starting');
            return;
        }

        const startBtn = document.getElementById('start-game-btn');
        buttonManager.setLoading(startBtn, true, 'Starting Game...');

        try {
            if (connectionManager.useFallback) {
                // In fallback mode, use local questions but with real players
                const questions = questionManager.getGhanaCurriculumQuestions(
                    this.currentRoom.settings.category,
                    this.currentRoom.settings.subject,
                    this.currentRoom.settings.difficulty,
                    this.currentRoom.settings.questionCount
                );

                this.handleGameStarted({
                    roomCode: this.currentRoom.code,
                    questions: questions,
                    players: this.players,
                    timePerQuestion: 30
                });
            } else {
                // Start game on server
                const result = await connectionManager.emit('startGame', {
                    roomCode: this.currentRoom.code,
                    settings: this.currentRoom.settings
                });

                if (!result.success) {
                    throw new Error(result.error || 'Failed to start game');
                }

                categoryManager.showSuccess('Game starting...');
                chatSystem.addSystemMessage('Game is starting! Get ready!', 'multiplayer-lobby');
            }
        } catch (error) {
            console.error('Error starting game:', error);
            categoryManager.showError(error.message || 'Failed to start game');
        } finally {
            buttonManager.setLoading(startBtn, false, 'Start Game');
        }
    },

    // Keep other methods but remove any demo player references
    // ... rest of the methods remain the same but without demo player code


           
            loadQuestion(questionIndex) {
                if (!this.gameState || questionIndex >= this.gameState.questions.length) {
                    // Game finished
                    this.showResults(this.gameState.players);
                    return;
                }
                
                this.gameState.currentQuestion = questionIndex;
                const question = this.gameState.questions[questionIndex];
                
                // Reset answered status for new question
                this.players.forEach(player => {
                    player.hasAnswered = false;
                });
                
                // Update UI with Ghana curriculum info
                const examInfo = {
                    primary: "BECE Curriculum",
                    highschool: "WASSCE Curriculum", 
                    tertiary: "Tertiary Education"
                };
                
                const subjectInfo = categoryManager.getSubjectDisplayName(this.currentRoom.settings.subject);
                document.getElementById('mp-current-subject').textContent = 
                    `${subjectInfo.name} - ${examInfo[this.currentRoom.settings.category]}`;
                
                document.getElementById('mp-question-count-display').textContent = 
                    `Question ${questionIndex + 1} of ${this.gameState.questions.length}`;
                
                document.getElementById('mp-question-text').textContent = question.question;
                
                // Update progress bar
                const progress = ((questionIndex) / this.gameState.questions.length) * 100;
                document.getElementById('mp-progress-bar').style.width = `${progress}%`;
                document.getElementById('mp-progress-bar').setAttribute('aria-valuenow', progress);
                
                // Render options
                const optionsContainer = document.getElementById('mp-options-container');
                optionsContainer.innerHTML = '';
                
                question.options.forEach((option, index) => {
                    const optionElement = document.createElement('div');
                    optionElement.className = 'option';
                    optionElement.setAttribute('role', 'button');
                    optionElement.setAttribute('aria-label', `Option ${String.fromCharCode(65 + index)}: ${option}`);
                    optionElement.setAttribute('tabindex', '0');
                    optionElement.innerHTML = `
                        <div class="option-content">
                            <div class="option-letter">${String.fromCharCode(65 + index)}</div>
                            <div class="option-text">${option}</div>
                        </div>
                    `;
                    
                    optionElement.addEventListener('click', () => {
                        this.selectAnswer(index);
                    });
                    
                    optionElement.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter' || e.key === ' ') {
                            this.selectAnswer(index);
                        }
                    });
                    
                    optionsContainer.appendChild(optionElement);
                });
                
                // Start timer
                this.startTimer();
                
                // Update scoreboard
                this.updateScoreboard();
                
                categoryManager.showScreen('multiplayer-quiz-screen');
                
                // Add chat message for new question
                chatSystem.addSystemMessage(`Question ${questionIndex + 1} started!`, 'multiplayer-quiz-screen');
            },

            selectAnswer(optionIndex) {
                if (!this.gameState) return;
                
                const questionIndex = this.gameState.currentQuestion;
                const question = this.gameState.questions[questionIndex];
                const options = document.querySelectorAll('#mp-options-container .option');
                
                // Disable all options after selection
                options.forEach(opt => {
                    opt.style.pointerEvents = 'none';
                    opt.classList.remove('selected', 'correct', 'incorrect');
                });
                
                options[optionIndex].classList.add('selected');
                
                const isCorrect = optionIndex === question.correctAnswer;
                
                // Show correct/incorrect feedback
                if (isCorrect) {
                    soundSystem.play('correct');
                    options[optionIndex].classList.add('correct');
                } else {
                    soundSystem.play('wrong');
                    options[optionIndex].classList.add('incorrect');
                    if (question.correctAnswer >= 0 && question.correctAnswer < options.length) {
                        options[question.correctAnswer].classList.add('correct');
                    }
                }
                
                // Submit answer
                this.submitAnswer(questionIndex, optionIndex);
                
                // Show explanation
                const feedbackElement = document.getElementById('mp-question-feedback');
                const feedbackText = document.getElementById('mp-feedback-text');
                
                if (feedbackElement && feedbackText) {
                    feedbackElement.className = `question-feedback ${isCorrect ? 'correct' : 'incorrect'} show`;
                    feedbackText.textContent = question.explanation || 
                        (isCorrect ? 'Correct! Well done.' : `Incorrect. The right answer is ${String.fromCharCode(65 + question.correctAnswer)}.`);
                    feedbackElement.setAttribute('aria-live', 'assertive');
                }
                
                // Move to next question after delay
                setTimeout(() => {
                    this.nextQuestion();
                }, 3000);
            },

            async submitAnswer(questionIndex, optionIndex) {
                if (!this.gameState || !this.currentRoom) return;
                
                const question = this.gameState.questions[questionIndex];
                const isCorrect = optionIndex === question.correctAnswer;
                
                // Update player score
                const player = this.players.find(p => p.id === this.playerId);
                if (player) {
                    if (isCorrect) {
                        player.score += 100;
                    }
                    player.hasAnswered = true;
                }
                
                // Update scoreboard
                this.updateScoreboard();
                
                // Send answer to server
                if (connectionManager.isConnected) {
                    await connectionManager.emit('submitAnswer', {
                        roomCode: this.currentRoom.code,
                        playerId: this.playerId,
                        questionIndex: questionIndex,
                        answerIndex: optionIndex,
                        isCorrect: isCorrect,
                        score: player.score
                    });
                }
            },

            nextQuestion() {
                if (this.gameState && this.gameState.currentQuestion < this.gameState.questions.length - 1) {
                    this.loadQuestion(this.gameState.currentQuestion + 1);
                } else {
                    this.showResults(this.gameState.players);
                }
            },

            startTimer() {
                clearInterval(this.timerInterval);
                this.timeLeft = this.gameState.timePerQuestion;
                this.lastTimerUpdate = Date.now();
                this.updateTimerDisplay();
                
                // Use requestAnimationFrame for more accurate timing
                this.timerInterval = setInterval(() => {
                    const now = Date.now();
                    const delta = now - this.lastTimerUpdate;
                    
                    if (delta >= 1000) {
                        this.timeLeft--;
                        this.lastTimerUpdate = now;
                        this.updateTimerDisplay();
                        
                        if (this.timeLeft <= 0) {
                            clearInterval(this.timerInterval);
                            this.nextQuestion();
                        }
                    }
                }, 100); // Check every 100ms for better accuracy
            },

            updateTimerDisplay() {
                const timerElement = document.getElementById('mp-time-left');
                if (timerElement) {
                    timerElement.textContent = this.timeLeft;
                    timerElement.className = `timer ${this.timeLeft <= 10 ? 'warning' : ''} ${this.timeLeft <= 5 ? 'danger' : ''}`;
                    timerElement.setAttribute('aria-label', `${this.timeLeft} seconds remaining`);
                }
            },

            updateScoreboard() {
                const scoreboard = document.getElementById('multiplayer-scoreboard');
                if (!scoreboard || !this.players.length) return;
                
                // Sort players by score (descending)
                const sortedPlayers = [...this.players].sort((a, b) => b.score - a.score);
                
                scoreboard.innerHTML = sortedPlayers.map((player, index) => {
                    const isCurrentPlayer = player.id === this.playerId;
                    const playerClass = isCurrentPlayer ? 'current-player' : '';
                    const rank = index + 1;
                    
                    return `
                        <div class="scoreboard-item ${playerClass}" role="listitem" aria-label="Rank ${rank}: ${player.name} with ${player.score} points">
                            <div class="scoreboard-rank">${rank}</div>
                            <div class="multiplayer-avatar" aria-hidden="true">${player.avatar}</div>
                            <div class="scoreboard-name">${player.name}</div>
                            <div class="scoreboard-score">${player.score} pts</div>
                            ${player.hasAnswered ? '<div class="scoreboard-status answered" aria-label="Answered"><i class="fas fa-check" aria-hidden="true"></i></div>' : '<div class="scoreboard-status waiting" aria-label="Waiting for answer"><i class="fas fa-clock" aria-hidden="true"></i></div>'}
                        </div>
                    `;
                }).join('');
            },

            showResults(finalScores) {
                clearInterval(this.timerInterval);
                
                if (!finalScores) {
                    finalScores = this.players;
                }
                
                // Sort players by score
                const sortedPlayers = [...finalScores].sort((a, b) => b.score - a.score);
                const winner = sortedPlayers[0];
                const isWinner = winner.id === this.playerId;
                
                // Update results display
                document.getElementById('mp-final-score').textContent = `${winner.name} wins!`;
                document.getElementById('mp-winner-avatar').textContent = winner.avatar;
                document.getElementById('mp-winner-name').textContent = winner.name;
                document.getElementById('mp-winner-score').textContent = `${winner.score} points`;
                
                // Show confetti for winner
                if (isWinner) {
                    document.getElementById('confetti').style.display = 'block';
                    soundSystem.play('victory');
                    
                    setTimeout(() => {
                        document.getElementById('confetti').style.display = 'none';
                    }, 5000);
                }
                
                // Update leaderboard
                const leaderboard = document.getElementById('mp-leaderboard');
                leaderboard.innerHTML = sortedPlayers.map((player, index) => {
                    const isCurrentPlayer = player.id === this.playerId;
                    const playerClass = isCurrentPlayer ? 'current-player' : '';
                    const rank = index + 1;
                    const medal = rank === 1 ? 'ü•á' : rank === 2 ? 'ü•à' : rank === 3 ? 'ü•â' : `${rank}.`;
                    
                    return `
                        <div class="leaderboard-item ${playerClass}" role="listitem" aria-label="Position ${rank}: ${player.name} with ${player.score} points">
                            <div class="leaderboard-rank">${medal}</div>
                            <div class="multiplayer-avatar" aria-hidden="true">${player.avatar}</div>
                            <div class="leaderboard-name">${player.name}</div>
                            <div class="leaderboard-score">${player.score} pts</div>
                        </div>
                    `;
                }).join('');
                
                categoryManager.showScreen('multiplayer-results-screen');
                
                // Add final results to chat
                chatSystem.addSystemMessage(`Game finished! Winner: ${winner.name} with ${winner.score} points`, 'multiplayer-quiz-screen');
                
                // Track analytics
                trackGameCompletion({
                    mode: 'multiplayer',
                    category: this.currentRoom.settings.category,
                    subject: this.currentRoom.settings.subject,
                    score: this.players.find(p => p.id === this.playerId)?.score || 0,
                    duration: Math.floor((Date.now() - (this.gameState?.startTime || Date.now())) / 1000),
                    questionsAnswered: this.gameState?.questions.length || 0,
                    correctAnswers: Math.floor((this.players.find(p => p.id === this.playerId)?.score || 0) / 100)
                });
            },

            async startGame() {
                if (!this.currentRoom || !this.players.find(p => p.id === this.playerId)?.isHost) {
                    categoryManager.showError('Only the host can start the game');
                    return;
                }

                const startBtn = document.getElementById('start-game-btn');
                buttonManager.setLoading(startBtn, true, 'Starting Game...');

                try {
                    if (connectionManager.useFallback) {
                        // Use local questions for fallback mode
                        const questions = questionManager.getGhanaCurriculumQuestions(
                            this.currentRoom.settings.category,
                            this.currentRoom.settings.subject,
                            this.currentRoom.settings.difficulty,
                            this.currentRoom.settings.questionCount
                        );

                        this.handleGameStarted({
                            roomCode: this.currentRoom.code,
                            questions: questions,
                            players: this.players,
                            timePerQuestion: 30
                        });
                    } else {
                        // Start game on server
                        const result = await connectionManager.emit('startGame', {
                            roomCode: this.currentRoom.code,
                            settings: this.currentRoom.settings
                        });

                        if (!result.success) {
                            throw new Error(result.error || 'Failed to start game');
                        }

                        // The actual game start will be handled by the gameStarted event
                        categoryManager.showSuccess('Game starting...');
                    }
                } catch (error) {
                    console.error('Error starting game:', error);
                    categoryManager.showError(error.message || 'Failed to start game');
                } finally {
                    buttonManager.setLoading(startBtn, false, 'Start Game');
                }
            },

            leaveRoom() {
                if (this.currentRoom && connectionManager.isConnected) {
                    connectionManager.emit('leaveRoom', {
                        roomCode: this.currentRoom.code,
                        playerId: this.playerId
                    });
                }

                this.currentRoom = null;
                this.players = [];
                this.gameState = null;
                clearInterval(this.timerInterval);

                categoryManager.showScreen('multiplayer-setup');
            },

            enableFallbackMode() {
                this.fallbackMode = true;
                console.log('üîÑ Multiplayer fallback mode enabled');
            },

            generateRoomCode() {
                const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
                let result = '';
                for (let i = 0; i < 4; i++) {
                    result += characters.charAt(Math.floor(Math.random() * characters.length));
                }
                return result;
            },

            generatePlayerId() {
                // Generate a persistent player ID
                let playerId = localStorage.getItem('quizMasterPlayerId');
                if (!playerId) {
                    playerId = 'player_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now().toString(36);
                    localStorage.setItem('quizMasterPlayerId', playerId);
                }
                return playerId;
            }
        };

        // Enhanced Analytics Manager
        const analyticsManager = {
            trackGameSession(sessionData) {
                const data = {
                    timestamp: Date.now(),
                    gameMode: sessionData.mode,
                    category: sessionData.category,
                    subject: sessionData.subject,
                    score: sessionData.score,
                    duration: sessionData.duration,
                    questionsAnswered: sessionData.questionsAnswered,
                    correctAnswers: sessionData.correctAnswers,
                    playerId: multiplayerSystem.playerId
                };
                
                this.saveSessionData(data);
                console.log('üìä Game session tracked:', data);
            },
            
            saveSessionData(data) {
                try {
                    const sessions = this.getSessionHistory();
                    sessions.push(data);
                    
                    // Keep only last 50 sessions
                    if (sessions.length > 50) {
                        sessions.splice(0, sessions.length - 50);
                    }
                    
                    localStorage.setItem('quizMasterSessions', JSON.stringify(sessions));
                } catch (error) {
                    console.error('Failed to save session data:', error);
                }
            },
            
            getSessionHistory() {
                try {
                    const saved = localStorage.getItem('quizMasterSessions');
                    return saved ? JSON.parse(saved) : [];
                } catch (error) {
                    console.error('Failed to load session history:', error);
                    return [];
                }
            },
            
            getPlayerStats() {
                const sessions = this.getSessionHistory();
                if (sessions.length === 0) {
                    return {
                        totalGames: 0,
                        averageScore: 0,
                        favoriteCategory: 'None',
                        improvementTrend: 0
                    };
                }
                
                const recentSessions = sessions.slice(-10); // Last 10 sessions
                const totalScore = sessions.reduce((sum, session) => sum + session.score, 0);
                const categoryCount = {};
                
                sessions.forEach(session => {
                    categoryCount[session.category] = (categoryCount[session.category] || 0) + 1;
                });
                
                const favoriteCategory = Object.keys(categoryCount).reduce((a, b) => 
                    categoryCount[a] > categoryCount[b] ? a : b
                );
                
                // Calculate improvement trend (average of last 5 vs previous 5)
                const recentAvg = recentSessions.slice(-5).reduce((sum, s) => sum + s.score, 0) / 5;
                const previousAvg = recentSessions.slice(0, 5).reduce((sum, s) => sum + s.score, 0) / 5;
                const improvementTrend = recentAvg - previousAvg;
                
                return {
                    totalGames: sessions.length,
                    averageScore: Math.round(totalScore / sessions.length),
                    favoriteCategory: favoriteCategory,
                    improvementTrend: Math.round(improvementTrend),
                    totalCorrectAnswers: sessions.reduce((sum, session) => sum + (session.correctAnswers || 0), 0),
                    totalQuestions: sessions.reduce((sum, session) => sum + (session.questionsAnswered || 0), 0)
                };
            },
            
            showPlayerStats() {
                const stats = this.getPlayerStats();
                const statsHTML = `
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i>Your Statistics</h5>
                        </div>
                        <div class="card-body">
                            <div class="row text-center">
                                <div class="col-md-3 mb-3">
                                    <div class="stat-card">
                                        <h3 class="text-primary">${stats.totalGames}</h3>
                                        <p class="mb-0">Total Games</p>
                                    </div>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <div class="stat-card">
                                        <h3 class="text-success">${stats.averageScore}</h3>
                                        <p class="mb-0">Avg Score</p>
                                    </div>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <div class="stat-card">
                                        <h3 class="text-info">${stats.favoriteCategory}</h3>
                                        <p class="mb-0">Favorite</p>
                                    </div>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <div class="stat-card">
                                        <h3 class="${stats.improvementTrend >= 0 ? 'text-success' : 'text-danger'}">
                                            ${stats.improvementTrend >= 0 ? '+' : ''}${stats.improvementTrend}
                                        </h3>
                                        <p class="mb-0">Trend</p>
                                    </div>
                                </div>
                            </div>
                            ${stats.totalGames > 0 ? `
                                <div class="mt-3">
                                    <small class="text-muted">
                                        Accuracy: ${Math.round((stats.totalCorrectAnswers / stats.totalQuestions) * 100)}% 
                                        (${stats.totalCorrectAnswers}/${stats.totalQuestions})
                                    </small>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
                
                return statsHTML;
            }
        };

        // Enhanced Validation Manager
        const validationManager = {
            validateRoomCode(code) {
                return /^[A-Z0-9]{4}$/.test(code);
            },
            
            sanitizeUserInput(input) {
                if (typeof input !== 'string') return '';
                const div = document.createElement('div');
                div.textContent = input;
                return div.innerHTML.trim();
            },
            
            validatePlayerName(name) {
                const cleanName = this.sanitizeUserInput(name);
                return cleanName.length > 0 && cleanName.length <= 20 && /^[a-zA-Z0-9\s]+$/.test(cleanName);
            },
            
            validateGameSettings(settings) {
                const errors = [];
                
                if (!settings.category || !this.categories[settings.category]) {
                    errors.push('Invalid category');
                }
                
                if (!settings.subject || !this.categories[settings.category]?.subjects.includes(settings.subject)) {
                    errors.push('Invalid subject');
                }
                
                if (!settings.difficulty || !['easy', 'medium', 'hard', 'all'].includes(settings.difficulty)) {
                    errors.push('Invalid difficulty');
                }
                
                if (!settings.questionCount || settings.questionCount < 1 || settings.questionCount > 50) {
                    errors.push('Question count must be between 1 and 50');
                }
                
                return errors;
            },
            
            get categories() {
                return categoryManager.categories;
            }
        };

        // Accessibility Manager
        const accessibilityManager = {
            init() {
                console.log('‚ôø Accessibility manager initialized');
                this.setupKeyboardNavigation();
                this.enhanceAccessibility();
                this.setupFocusManagement();
            },
            
            setupKeyboardNavigation() {
                document.addEventListener('keydown', (e) => {
                    // Number keys 1-4 for answer selection
                    if (e.key >= '1' && e.key <= '4' && currentState.screen.includes('quiz-screen')) {
                        const optionIndex = parseInt(e.key) - 1;
                        const options = document.querySelectorAll('.option');
                        if (options[optionIndex] && !options[optionIndex].classList.contains('selected')) {
                            options[optionIndex].click();
                        }
                    }
                    
                    // Space bar for next question
                    if (e.key === ' ' && document.getElementById('next-question')?.style.display !== 'none') {
                        e.preventDefault();
                        document.getElementById('next-question').click();
                    }
                    
                    // Escape key to go back
                    if (e.key === 'Escape') {
                        this.handleEscapeKey();
                    }
                    
                    // Tab key management for modals
                    if (e.key === 'Tab') {
                        this.handleTabKey(e);
                    }
                });
            },
            
            handleEscapeKey() {
                switch(currentState.screen) {
                    case 'subject-selection':
                        document.getElementById('back-to-categories').click();
                        break;
                    case 'multiplayer-lobby':
                        document.getElementById('leave-room-btn').click();
                        break;
                    default:
                        categoryManager.showCategorySelection();
                }
            },
            
            handleTabKey(e) {
                // Keep tab focus within modal dialogs
                const modal = document.querySelector('.modal.show');
                if (modal) {
                    const focusableElements = modal.querySelectorAll(
                        'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
                    );
                    const firstElement = focusableElements[0];
                    const lastElement = focusableElements[focusableElements.length - 1];
                    
                    if (e.shiftKey) {
                        if (document.activeElement === firstElement) {
                            lastElement.focus();
                            e.preventDefault();
                        }
                    } else {
                        if (document.activeElement === lastElement) {
                            firstElement.focus();
                            e.preventDefault();
                        }
                    }
                }
            },
            
            enhanceAccessibility() {
                // Add ARIA roles and labels to interactive elements
                document.querySelectorAll('.option').forEach(option => {
                    option.setAttribute('role', 'button');
                    option.setAttribute('tabindex', '0');
                });
                
                document.querySelectorAll('.card[role="button"]').forEach(card => {
                    card.setAttribute('tabindex', '0');
                });
                
                // Add skip to main content link
                this.addSkipLink();
                
                // Enhance form labels
                this.enhanceFormLabels();
            },
            
            addSkipLink() {
                const skipLink = document.createElement('a');
                skipLink.href = '#main-content';
                skipLink.className = 'skip-link';
                skipLink.textContent = 'Skip to main content';
                skipLink.style.cssText = `
                    position: absolute;
                    top: -40px;
                    left: 6px;
                    background: #000;
                    color: white;
                    padding: 8px;
                    z-index: 10000;
                    text-decoration: none;
                `;
                skipLink.addEventListener('focus', () => {
                    skipLink.style.top = '6px';
                });
                skipLink.addEventListener('blur', () => {
                    skipLink.style.top = '-40px';
                });
                
                document.body.insertBefore(skipLink, document.body.firstChild);
                
                // Add main content ID
                const mainContent = document.querySelector('.card-body') || document.querySelector('main');
                if (mainContent) {
                    mainContent.id = 'main-content';
                    mainContent.setAttribute('role', 'main');
                }
            },
            
            enhanceFormLabels() {
                const inputs = document.querySelectorAll('input[type="text"], input[type="email"], select');
                inputs.forEach(input => {
                    if (!input.id) {
                        input.id = `input-${Math.random().toString(36).substr(2, 9)}`;
                    }
                    
                    const label = input.previousElementSibling;
                    if (label && label.tagName === 'LABEL') {
                        label.htmlFor = input.id;
                    }
                });
            },
            
            setupFocusManagement() {
                // Focus management for screen transitions
                const observer = new MutationObserver((mutations) => {
                    mutations.forEach((mutation) => {
                        mutation.addedNodes.forEach((node) => {
                            if (node.nodeType === 1 && node.classList && !node.classList.contains('d-none')) {
                                this.focusFirstElement(node);
                            }
                        });
                    });
                });
                
                observer.observe(document.body, {
                    childList: true,
                    subtree: true
                });
            },
            
            focusFirstElement(container) {
                const focusableSelectors = [
                    'button:not(:disabled)',
                    '[href]',
                    'input:not(:disabled)',
                    'select:not(:disabled)',
                    'textarea:not(:disabled)',
                    '[tabindex]:not([tabindex="-1"])'
                ].join(', ');
                
                const focusableElements = container.querySelectorAll(focusableSelectors);
                if (focusableElements.length > 0) {
                    setTimeout(() => focusableElements[0].focus(), 100);
                }
            },
            
            announceToScreenReader(message, priority = 'polite') {
                const announcer = document.getElementById('screen-reader-announcer') || this.createAnnouncer();
                announcer.setAttribute('aria-live', priority);
                announcer.textContent = message;
                
                // Clear message after a delay
                setTimeout(() => {
                    announcer.textContent = '';
                }, 1000);
            },
            
            createAnnouncer() {
                const announcer = document.createElement('div');
                announcer.id = 'screen-reader-announcer';
                announcer.style.cssText = `
                    position: absolute;
                    left: -10000px;
                    width: 1px;
                    height: 1px;
                    overflow: hidden;
                `;
                announcer.setAttribute('aria-live', 'polite');
                announcer.setAttribute('aria-atomic', 'true');
                document.body.appendChild(announcer);
                return announcer;
            }
        };

        // Asset Manager
        const assetManager = {
            init() {
                console.log('üì¶ Asset manager initialized');
                this.preloadAssets();
            },
            
            preloadAssets() {
                const sounds = ['correct', 'wrong', 'victory'];
                sounds.forEach(sound => {
                    const audio = document.getElementById(`${sound}-sound`);
                    if (audio) {
                        audio.load();
                    }
                });
                
                // Preload critical images or other assets
                this.preloadCriticalImages();
            },
            
            preloadCriticalImages() {
                const criticalImages = [
                    // Add paths to critical images here
                ];
                
                criticalImages.forEach(src => {
                    const img = new Image();
                    img.src = src;
                });
            }
        };

        // Analytics tracking function
        function trackGameCompletion(gameData) {
            analyticsManager.trackGameSession({
                mode: gameData.mode,
                category: gameData.category,
                subject: gameData.subject,
                score: gameData.score,
                duration: gameData.duration,
                questionsAnswered: gameData.questionsAnswered,
                correctAnswers: gameData.correctAnswers
            });
        }

        // UI Event Handlers
        function setupEventListeners() {
            console.log('üîß Setting up event listeners...');

            // Sound toggle
            const soundToggle = document.getElementById('toggle-sound');
            if (soundToggle) {
                soundToggle.addEventListener('click', () => {
                    soundSystem.toggle();
                });
            }

            // Start quiz button (single player)
            const startQuizBtn = document.getElementById('start-quiz-btn');
            if (startQuizBtn) {
                startQuizBtn.addEventListener('click', buttonManager.debounce(() => {
                    const settings = categoryManager.getCurrentSettings();
                    const playerName = document.getElementById('player-name').value || 'Player';
                    
                    // Save player name
                    storageManager.savePreferences();
                    
                    if (!settings.category || !settings.subject) {
                        categoryManager.showError('Please select a category and subject');
                        return;
                    }

                    if (settings.gameMode === 'single') {
                        singlePlayerSystem.startGame(
                            settings.category,
                            settings.subject,
                            playerName,
                            avatarSystem.selectedAvatar,
                            settings.difficulty,
                            settings.questionCount,
                            settings.questionSource
                        );
                    } else {
                        // Multiplayer mode - go to multiplayer setup
                        categoryManager.showScreen('multiplayer-setup');
                    }
                }, 500));
            }

            // Multiplayer setup
            const setupMultiplayer = document.getElementById('setup-multiplayer');
            if (setupMultiplayer) {
                setupMultiplayer.addEventListener('click', () => {
                    categoryManager.showScreen('multiplayer-setup');
                });
            }

            // Create room
            const createRoomBtn = document.getElementById('create-room-btn');
            if (createRoomBtn) {
                createRoomBtn.addEventListener('click', buttonManager.debounce(() => {
                    const settings = categoryManager.getCurrentSettings();
                    multiplayerSystem.createRoom(settings);
                }, 500));
            }

            // Join room
            const joinRoomBtn = document.getElementById('join-room-btn');
            if (joinRoomBtn) {
                joinRoomBtn.addEventListener('click', buttonManager.debounce(() => {
                    const roomCode = document.getElementById('room-code-input').value;
                    multiplayerSystem.joinRoom(roomCode);
                }, 500));
            }

            // Start multiplayer game
            const startGameBtn = document.getElementById('start-game-btn');
            if (startGameBtn) {
                startGameBtn.addEventListener('click', buttonManager.debounce(() => {
                    multiplayerSystem.startGame();
                }, 500));
            }

            // Leave room
            const leaveRoomBtn = document.getElementById('leave-room-btn');
            if (leaveRoomBtn) {
                leaveRoomBtn.addEventListener('click', () => {
                    multiplayerSystem.leaveRoom();
                });
            }

            // Back to multiplayer setup
            const backToMultiplayerSetup = document.getElementById('back-to-multiplayer-setup');
            if (backToMultiplayerSetup) {
                backToMultiplayerSetup.addEventListener('click', () => {
                    multiplayerSystem.leaveRoom();
                });
            }

            // Quiz navigation
            const prevQuestion = document.getElementById('prev-question');
            if (prevQuestion) {
                prevQuestion.addEventListener('click', () => {
                    singlePlayerSystem.prevQuestion();
                });
            }

            const nextQuestion = document.getElementById('next-question');
            if (nextQuestion) {
                nextQuestion.addEventListener('click', () => {
                    singlePlayerSystem.nextQuestion();
                });
            }

            const submitQuiz = document.getElementById('submit-quiz');
            if (submitQuiz) {
                submitQuiz.addEventListener('click', () => {
                    singlePlayerSystem.submitQuiz();
                });
            }

            // Play again buttons
            const playAgainSingle = document.getElementById('play-again-btn');
            if (playAgainSingle) {
                playAgainSingle.addEventListener('click', () => {
                    categoryManager.showCategorySelection();
                });
            }

            const playAgainMultiplayer = document.getElementById('play-again-multiplayer');
            if (playAgainMultiplayer) {
                playAgainMultiplayer.addEventListener('click', () => {
                    multiplayerSystem.leaveRoom();
                    categoryManager.showScreen('multiplayer-setup');
                });
            }

            const backToMainFromResults = document.getElementById('back-to-menu');
            if (backToMainFromResults) {
                backToMainFromResults.addEventListener('click', () => {
                    categoryManager.showCategorySelection();
                });
            }

            // Back to main menu from various screens
            const backButtons = document.querySelectorAll('.back-to-main');
            backButtons.forEach(button => {
                button.addEventListener('click', () => {
                    categoryManager.showCategorySelection();
                });
            });

            // Room code input uppercase
            const roomCodeInput = document.getElementById('room-code-input');
            if (roomCodeInput) {
                roomCodeInput.addEventListener('input', (e) => {
                    e.target.value = e.target.value.toUpperCase();
                });
            }

            // Enter key for room code
            if (roomCodeInput) {
                roomCodeInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        document.getElementById('join-room-btn').click();
                    }
                });
            }

            // Player name input enter key
            const playerNameInput = document.getElementById('player-name');
            if (playerNameInput) {
                playerNameInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        document.getElementById('start-quiz-btn').click();
                    }
                });
                // Save on blur
                playerNameInput.addEventListener('blur', () => {
                    storageManager.savePreferences();
                });
            }

            const mpPlayerNameInput = document.getElementById('mp-player-name');
            if (mpPlayerNameInput) {
                mpPlayerNameInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        // Check which multiplayer screen we're on
                        if (currentState.screen === 'multiplayer-setup') {
                            document.getElementById('create-room-btn').click();
                        }
                    }
                });
                // Save on blur
                mpPlayerNameInput.addEventListener('blur', () => {
                    storageManager.savePreferences();
                });
            }

            // Auto-save preferences when inputs change
            const autoSaveInputs = document.querySelectorAll('#player-name, #mp-player-name, #difficulty-select, #question-count, #question-source');
            autoSaveInputs.forEach(input => {
                input.addEventListener('change', () => {
                    storageManager.savePreferences();
                });
            });
        }

        // Initialize the application
        async function initApp() {
            console.log('üöÄ Initializing Enhanced QuizMaster App...');

            try {
                // Validate stored data first
                if (!storageManager.validateStoredData()) {
                    categoryManager.showError('Corrupted data detected. Settings have been reset.');
                }
                
                // Load user preferences
                storageManager.loadPreferences();
                
                // Initialize all systems
                assetManager.init();
                avatarSystem.init();
                categoryManager.init();
                singlePlayerSystem.init();
                multiplayerSystem.init();
                chatSystem.init();
                accessibilityManager.init();
                
                // Setup event listeners
                setupEventListeners();
                
                // Initialize connection manager with timeout
                const connectionPromise = connectionManager.init();
                const timeoutPromise = new Promise((resolve) => {
                    setTimeout(() => {
                        console.log('‚è∞ Connection timeout - continuing in fallback mode');
                        connectionManager.handleConnectionFailure();
                        resolve();
                    }, 10000); // 10 second timeout
                });
                
                await Promise.race([connectionPromise, timeoutPromise]);
                
                // Update UI based on sound preferences
                const soundToggle = document.getElementById('toggle-sound');
                if (soundToggle) {
                    soundToggle.innerHTML = soundSystem.enabled ? 
                        '<i class="fas fa-volume-up me-1"></i> Sound On' : 
                        '<i class="fas fa-volume-mute me-1"></i> Sound Off';
                    soundToggle.classList.toggle('btn-outline-success', soundSystem.enabled);
                    soundToggle.classList.toggle('btn-outline-secondary', !soundSystem.enabled);
                }
                
                console.log('‚úÖ Enhanced QuizMaster App initialized successfully!');
                
                // Show connection status
                if (connectionManager.isConnected) {
                    connectionManager.setConnectionStatus('connected');
                } else {
                    connectionManager.setConnectionStatus('disconnected');
                }
                
                // Load any saved game progress
                const savedGame = storageManager.loadGameProgress();
                if (savedGame) {
                    console.log('üíæ Found saved game progress');
                    // You could implement a "Continue Game" feature here
                }
                
                // Announce readiness to screen readers
                accessibilityManager.announceToScreenReader('QuizMaster application ready');
                
            } catch (error) {
                console.error('‚ùå Failed to initialize app:', error);
                categoryManager.showError('Failed to initialize application. Please refresh the page.');
                accessibilityManager.announceToScreenReader('Application initialization failed', 'assertive');
            }
        }

        // Export for global access
        window.QuizMaster = {
            categoryManager: categoryManager,
            singlePlayerSystem: singlePlayerSystem,
            multiplayerSystem: multiplayerSystem,
            soundSystem: soundSystem,
            avatarSystem: avatarSystem,
            connectionManager: connectionManager,
            storageManager: storageManager,
            accessibilityManager: accessibilityManager,
            analyticsManager: analyticsManager,
            questionManager: questionManager,
            validationManager: validationManager
        };

        // Start the app when DOM is loaded
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initApp);
        } else {
            initApp();
        }
    </script>
</body>
</html>