<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuizMaster - Ghana Curriculum Quiz Platform</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary: #4361ee;
            --secondary: #3f37c9;
            --success: #4cc9f0;
            --danger: #f72585;
            --warning: #f8961e;
            --info: #4895ef;
            --light: #f8f9fa;
            --dark: #212529;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            background: rgba(255,255,255,0.95);
        }
        
        .category-card, .subject-card {
            transition: all 0.3s ease;
            cursor: pointer;
            border: 2px solid transparent;
        }
        
        .category-card:hover, .subject-card:hover {
            transform: translateY(-5px);
            border-color: var(--primary);
        }
        
        .category-card.selected, .subject-card.selected {
            border-color: var(--primary);
            background-color: rgba(67, 97, 238, 0.1);
        }
        
        .option {
            padding: 15px;
            margin: 10px 0;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .option:hover {
            border-color: var(--primary);
            background-color: rgba(67, 97, 238, 0.05);
        }
        
        .option.selected {
            border-color: var(--primary);
            background-color: rgba(67, 97, 238, 0.1);
        }
        
        .option.correct {
            border-color: var(--success);
            background-color: rgba(76, 201, 240, 0.2);
        }
        
        .option.incorrect {
            border-color: var(--danger);
            background-color: rgba(247, 37, 133, 0.1);
        }
        
        .timer {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary);
        }
        
        .timer.warning {
            color: var(--warning);
        }
        
        .timer.danger {
            color: var(--danger);
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .question-feedback {
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            display: none;
        }
        
        .question-feedback.show {
            display: block;
        }
        
        .question-feedback.correct {
            background-color: rgba(76, 201, 240, 0.2);
            border-left: 5px solid var(--success);
        }
        
        .question-feedback.incorrect {
            background-color: rgba(247, 37, 133, 0.1);
            border-left: 5px solid var(--danger);
        }
        
        .multiplayer-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            background: var(--light);
        }
        
        .player-item, .scoreboard-item, .leaderboard-item {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            margin: 5px 0;
            border-radius: 10px;
            background: var(--light);
            transition: all 0.3s ease;
        }
        
        .player-item:hover, .scoreboard-item:hover, .leaderboard-item:hover {
            transform: translateX(5px);
        }
        
        .current-player {
            background: rgba(67, 97, 238, 0.1);
            border-left: 4px solid var(--primary);
        }
        
        .scoreboard-rank, .leaderboard-rank {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 10px;
        }
        
        .chat-messages {
            max-height: 200px;
            overflow-y: auto;
        }
        
        .chat-message {
            padding: 8px 12px;
            margin: 5px 0;
            border-radius: 10px;
            background: var(--light);
        }
        
        .chat-message.own-message {
            background: rgba(67, 97, 238, 0.1);
            margin-left: 20px;
        }
        
        .chat-message.system-message {
            background: rgba(248, 150, 30, 0.1);
            font-style: italic;
            text-align: center;
        }
        
        .status {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        .status.connected {
            background: rgba(76, 201, 240, 0.2);
            color: var(--success);
        }
        
        .status.disconnected {
            background: rgba(247, 37, 133, 0.1);
            color: var(--danger);
        }
        
        .status.connecting {
            background: rgba(248, 150, 30, 0.2);
            color: var(--warning);
        }
        
        .online-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }
        
        .online-indicator.online {
            background: var(--success);
        }
        
        .online-indicator.offline {
            background: var(--danger);
        }
        
        .online-indicator.connecting {
            background: var(--warning);
            animation: pulse 1.5s infinite;
        }
        
        .countdown-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }
        
        .countdown-content {
            text-align: center;
            color: white;
        }
        
        .countdown-number {
            font-size: 5rem;
            font-weight: bold;
            color: var(--success);
        }
        
        .confetti {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 9999;
            display: none;
        }
        
        .skip-link {
            position: absolute;
            top: -40px;
            left: 6px;
            background: #000;
            color: white;
            padding: 8px;
            z-index: 10000;
            text-decoration: none;
        }
        
        .skip-link:focus {
            top: 6px;
        }
        
        .avatar-option {
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .avatar-option:hover {
            transform: scale(1.1);
        }
        
        .loading {
            opacity: 0.7;
            pointer-events: none;
        }
        
        .stat-card {
            padding: 15px;
            border-radius: 10px;
            background: var(--light);
            text-align: center;
        }
        
        .reconnection-alert {
            animation: slideDown 0.5s ease;
        }
        
        @keyframes slideDown {
            from { transform: translateY(-100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .option-content {
            display: flex;
            align-items: center;
        }
        
        .option-letter {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 15px;
        }

        .ready-btn.ready {
            background-color: var(--success);
            border-color: var(--success);
        }
    </style>
</head>
<body>
    <!-- Confetti Animation -->
    <div id="confetti" class="confetti"></div>

    <!-- Audio Elements -->
    <audio id="correct-sound" preload="auto">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-correct-answer-tone-2870.mp3" type="audio/mpeg">
    </audio>
    <audio id="wrong-sound" preload="auto">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-wrong-answer-fail-notification-946.mp3" type="audio/mpeg">
    </audio>
    <audio id="victory-sound" preload="auto">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-winning-chimes-2015.mp3" type="audio/mpeg">
    </audio>

    <div class="container py-4">
        <div class="row justify-content-center">
            <div class="col-lg-10 col-xl-8">
                <div class="card">
                    <div class="card-body p-4 p-md-5">
                        <!-- Header -->
                        <div class="text-center mb-4">
                            <h1 class="display-4 fw-bold text-primary mb-2">üéì QuizMaster</h1>
                            <p class="lead text-muted">Ghana Curriculum Quiz Platform</p>
                            
                            <!-- Connection Status -->
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <div id="connection-status" class="status connecting">
                                    <span class="online-indicator connecting"></span>
                                    <i class="fas fa-sync-alt me-2"></i>Connecting...
                                </div>
                                <button id="toggle-sound" class="btn btn-outline-success btn-sm">
                                    <i class="fas fa-volume-up me-1"></i>Sound On
                                </button>
                            </div>
                        </div>

                        <!-- Error/Success Messages -->
                        <div id="error-message" class="alert alert-danger d-none" role="alert">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <span id="error-text"></span>
                        </div>
                        
                        <div id="success-message" class="alert alert-success d-none" role="alert">
                            <i class="fas fa-check-circle me-2"></i>
                            <span id="success-text"></span>
                        </div>

                        <!-- Loading Spinner -->
                        <div id="loading-spinner" class="text-center d-none">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2 text-muted">Loading...</p>
                        </div>

                        <!-- Category Selection Screen -->
                        <div id="category-selection">
                            <div class="text-center mb-5">
                                <h2 class="mb-3">Select Education Level</h2>
                                <p class="text-muted">Choose your academic level to begin the quiz</p>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-4 mb-4">
                                    <div class="card category-card h-100" data-category="primary" role="button" tabindex="0" aria-label="Primary School Level">
                                        <div class="card-body text-center p-4">
                                            <i class="fas fa-pencil-alt fa-3x text-primary mb-3" aria-hidden="true"></i>
                                            <h4 class="card-title">Primary School</h4>
                                            <p class="card-text text-muted">Basic 1-6 (BECE Level)</p>
                                            <div class="mt-3">
                                                <span class="badge bg-success me-1">Easy</span>
                                                <span class="badge bg-warning">Medium</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-md-4 mb-4">
                                    <div class="card category-card h-100" data-category="highschool" role="button" tabindex="0" aria-label="High School Level">
                                        <div class="card-body text-center p-4">
                                            <i class="fas fa-graduation-cap fa-3x text-success mb-3" aria-hidden="true"></i>
                                            <h4 class="card-title">JHS & SHS</h4>
                                            <p class="card-text text-muted">WASSCE Level</p>
                                            <div class="mt-3">
                                                <span class="badge bg-success me-1">Easy</span>
                                                <span class="badge bg-warning me-1">Medium</span>
                                                <span class="badge bg-danger">Hard</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-md-4 mb-4">
                                    <div class="card category-card h-100" data-category="tertiary" role="button" tabindex="0" aria-label="Tertiary Education Level">
                                        <div class="card-body text-center p-4">
                                            <i class="fas fa-university fa-3x text-info mb-3" aria-hidden="true"></i>
                                            <h4 class="card-title">Tertiary</h4>
                                            <p class="card-text text-muted">University & College</p>
                                            <div class="mt-3">
                                                <span class="badge bg-warning me-1">Medium</span>
                                                <span class="badge bg-danger">Hard</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="text-center mt-4">
                                <button id="setup-multiplayer" class="btn btn-outline-primary btn-lg">
                                    <i class="fas fa-users me-2"></i>Multiplayer Mode
                                </button>
                            </div>
                        </div>

                        <!-- Subject Selection Screen -->
                        <div id="subject-selection" class="d-none">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <button id="back-to-categories" class="btn btn-outline-secondary">
                                    <i class="fas fa-arrow-left me-2"></i>Back
                                </button>
                                <h2 id="category-title" class="mb-0 text-center flex-grow-1">Select Subject</h2>
                                <div style="width: 100px;"></div> <!-- Spacer for alignment -->
                            </div>
                            
                            <div id="subjects-container" class="row">
                                <!-- Subjects will be dynamically loaded here -->
                            </div>
                            
                            <div class="mt-4 p-4 bg-light rounded">
                                <h5 class="mb-3"><i class="fas fa-cogs me-2"></i>Quiz Settings</h5>
                                
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label for="player-name" class="form-label">Your Name</label>
                                        <input type="text" class="form-control" id="player-name" placeholder="Enter your name" value="Player">
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <label class="form-label">Avatar</label>
                                        <div id="avatar-selection" class="d-flex gap-2">
                                            <!-- Avatars will be dynamically loaded here -->
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-4">
                                        <label for="difficulty-select" class="form-label">Difficulty</label>
                                        <select class="form-select" id="difficulty-select">
                                            <option value="all">All Levels</option>
                                            <option value="easy">Easy</option>
                                            <option value="medium" selected>Medium</option>
                                            <option value="hard">Hard</option>
                                        </select>
                                    </div>
                                    
                                    <div class="col-md-4">
                                        <label for="question-count" class="form-label">Questions</label>
                                        <select class="form-select" id="question-count">
                                            <option value="5">5 Questions</option>
                                            <option value="10" selected>10 Questions</option>
                                            <option value="15">15 Questions</option>
                                            <option value="20">20 Questions</option>
                                        </select>
                                    </div>
                                    
                                    <div class="col-md-4">
                                        <label for="question-source" class="form-label">Question Source</label>
                                        <select class="form-select" id="question-source">
                                            <option value="ghana_curriculum" selected>Ghana Curriculum</option>
                                            <option value="mixed">Mixed Sources</option>
                                        </select>
                                    </div>
                                    
                                    <div class="col-12">
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="radio" name="gameMode" id="singlePlayer" value="single" checked>
                                            <label class="form-check-label" for="singlePlayer">
                                                <i class="fas fa-user me-1"></i>Single Player
                                            </label>
                                        </div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="radio" name="gameMode" id="multiplayer" value="multiplayer">
                                            <label class="form-check-label" for="multiplayer">
                                                <i class="fas fa-users me-1"></i>Multiplayer
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="text-center mt-4">
                                    <button id="start-quiz-btn" class="btn btn-primary btn-lg">
                                        <i class="fas fa-play me-2"></i>Start Quiz
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Multiplayer Setup Screen -->
                        <div id="multiplayer-setup" class="d-none">
                            <div class="text-center mb-4">
                                <h2>Multiplayer Mode</h2>
                                <p class="text-muted">Challenge your friends in real-time quiz battles</p>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-4">
                                    <div class="card h-100">
                                        <div class="card-body text-center p-4">
                                            <i class="fas fa-plus-circle fa-3x text-success mb-3" aria-hidden="true"></i>
                                            <h4 class="card-title">Create Room</h4>
                                            <p class="card-text">Start a new game and invite friends</p>
                                            
                                            <div class="mt-4">
                                                <label for="mp-player-name" class="form-label">Your Name</label>
                                                <input type="text" class="form-control mb-3" id="mp-player-name" placeholder="Enter your name" value="Player">
                                                
                                                <label class="form-label">Avatar</label>
                                                <div id="mp-avatar-selection" class="d-flex gap-2 justify-content-center mb-3">
                                                    <!-- Avatars will be dynamically loaded here -->
                                                </div>
                                                
                                                <button id="create-room-btn" class="btn btn-success btn-lg w-100">
                                                    <i class="fas fa-plus me-2"></i>Create Room
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-md-6 mb-4">
                                    <div class="card h-100">
                                        <div class="card-body text-center p-4">
                                            <i class="fas fa-sign-in-alt fa-3x text-primary mb-3" aria-hidden="true"></i>
                                            <h4 class="card-title">Join Room</h4>
                                            <p class="card-text">Enter a room code to join existing game</p>
                                            
                                            <div class="mt-4">
                                                <label for="room-code-input" class="form-label">Room Code</label>
                                                <input type="text" class="form-control mb-3 text-uppercase" id="room-code-input" placeholder="Enter room code" maxlength="6">
                                                
                                                <button id="join-room-btn" class="btn btn-primary btn-lg w-100">
                                                    <i class="fas fa-sign-in-alt me-2"></i>Join Room
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="text-center mt-3">
                                <button id="back-to-main-from-mp" class="btn btn-outline-secondary">
                                    <i class="fas fa-arrow-left me-2"></i>Back to Main Menu
                                </button>
                            </div>
                        </div>

                        <!-- Multiplayer Lobby Screen -->
                        <div id="multiplayer-lobby" class="d-none">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <button id="leave-room-btn" class="btn btn-outline-danger">
                                    <i class="fas fa-door-open me-2"></i>Leave Room
                                </button>
                                <h2 class="mb-0">Game Lobby</h2>
                                <div class="text-end">
                                    <div class="fw-bold">Room: <span id="room-code" class="badge bg-primary">----</span></div>
                                    <small class="text-muted" id="player-count">0 players</small>
                                </div>
                            </div>
                            
                            <div class="card mb-4">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0"><i class="fas fa-users me-2"></i>Players</h5>
                                    <button id="toggle-ready-btn" class="btn btn-outline-primary btn-sm ready-btn">
                                        <i class="fas fa-clock me-1"></i>Not Ready
                                    </button>
                                </div>
                                <div class="card-body">
                                    <div id="players-list">
                                        <!-- Real players will appear here as they join -->
                                    </div>
                                </div>
                            </div>

                            <!-- Chat Section -->
                            <div class="chat-container mt-4">
                                <div class="card">
                                    <div class="card-header d-flex justify-content-between align-items-center">
                                        <h6 class="mb-0"><i class="fas fa-comments me-2"></i>Game Chat</h6>
                                        <span class="badge bg-primary" id="chat-indicator">Live</span>
                                    </div>
                                    <div class="card-body p-0">
                                        <div id="chat-messages-lobby" class="chat-messages" style="height: 150px; overflow-y: auto; padding: 10px;"></div>
                                        <div class="chat-input-container p-2 border-top">
                                            <div class="input-group">
                                                <input type="text" 
                                                       id="chat-input-lobby" 
                                                       class="form-control" 
                                                       placeholder="Type a message..." 
                                                       aria-label="Chat message"
                                                       maxlength="200">
                                                <button class="btn btn-primary" id="send-chat-lobby" type="button">
                                                    <i class="fas fa-paper-plane"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="text-center mt-4">
                                <button id="start-game-btn" class="btn btn-success btn-lg" style="display: none;">
                                    <i class="fas fa-play me-2"></i>Start Game
                                </button>
                                <p class="text-muted mt-2" id="start-game-hint">Share the room code with other players to begin</p>
                            </div>
                        </div>

                        <!-- Single Player Quiz Screen -->
                        <div id="quiz-screen" class="d-none">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <div>
                                    <h3 id="current-subject" class="mb-0">Loading Quiz...</h3>
                                    <span class="badge bg-primary" id="question-count-display">Question 1 of 10</span>
                                </div>
                                <div class="timer">
                                    <i class="fas fa-clock me-2" aria-hidden="true"></i>
                                    <span id="time-left" aria-live="assertive">30</span>s
                                </div>
                            </div>
                            
                            <div class="progress mb-4">
                                <div id="progress-bar" class="progress-bar bg-success" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                            
                            <div id="question-feedback" class="question-feedback" aria-live="polite">
                                <i class="fas fa-info-circle me-2" aria-hidden="true"></i>
                                <span id="feedback-text"></span>
                            </div>
                            
                            <div class="card question-card">
                                <div class="card-body">
                                    <h4 id="question-text" class="card-title">Loading question...</h4>
                                    <div id="options-container" class="mt-4" role="listbox" aria-label="Answer options">
                                        <!-- Options will be dynamically loaded here -->
                                    </div>
                                </div>
                            </div>
                            
                            <div class="d-flex justify-content-between mt-4">
                                <button id="prev-question" class="btn btn-outline-secondary" style="display: none;">
                                    <i class="fas fa-arrow-left me-2"></i>Previous
                                </button>
                                <div>
                                    <button id="next-question" class="btn btn-outline-primary" style="display: none;">
                                        Next <i class="fas fa-arrow-right ms-2"></i>
                                    </button>
                                    <button id="submit-quiz" class="btn btn-success" style="display: none;">
                                        <i class="fas fa-flag me-2"></i>Submit Quiz
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Single Player Results Screen -->
                        <div id="results-screen" class="d-none">
                            <div class="text-center mb-5">
                                <h2>Quiz Complete! üéâ</h2>
                                <div class="display-4 fw-bold text-primary mb-2" id="final-score">0/0</div>
                                <p class="lead" id="points-earned">0 points earned</p>
                            </div>
                            
                            <div id="performance-stats" class="mb-4">
                                <!-- Performance stats will be dynamically loaded here -->
                            </div>
                            
                            <div class="text-center mt-4">
                                <button id="play-again-btn" class="btn btn-primary btn-lg me-3">
                                    <i class="fas fa-redo me-2"></i>Play Again
                                </button>
                                <button id="back-to-menu" class="btn btn-outline-primary">
                                    <i class="fas fa-home me-2"></i>Main Menu
                                </button>
                            </div>
                        </div>

                        <!-- Multiplayer Quiz Screen -->
                        <div id="multiplayer-quiz-screen" class="d-none">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <div>
                                    <h3 id="mp-current-subject" class="mb-0">Loading Quiz...</h3>
                                    <span class="badge bg-primary" id="mp-question-count-display">Question 1 of 10</span>
                                </div>
                                <div class="timer">
                                    <i class="fas fa-clock me-2" aria-hidden="true"></i>
                                    <span id="mp-time-left" aria-live="assertive">30</span>s
                                </div>
                            </div>
                            
                            <div class="progress mb-4">
                                <div id="mp-progress-bar" class="progress-bar bg-success" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                            
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5 class="mb-0"><i class="fas fa-trophy me-2" aria-hidden="true"></i>Live Scoreboard</h5>
                                </div>
                                <div class="card-body">
                                    <div id="multiplayer-scoreboard" role="list" aria-label="Player scores">
                                    </div>
                                </div>
                            </div>

                            <!-- Chat Section -->
                            <div class="chat-container mb-4">
                                <div class="card">
                                    <div class="card-header d-flex justify-content-between align-items-center">
                                        <h6 class="mb-0"><i class="fas fa-comments me-2"></i>Game Chat</h6>
                                        <span class="badge bg-primary" id="chat-indicator-quiz">Live</span>
                                    </div>
                                    <div class="card-body p-0">
                                        <div id="chat-messages-quiz" class="chat-messages" style="height: 120px; overflow-y: auto; padding: 10px;"></div>
                                        <div class="chat-input-container p-2 border-top">
                                            <div class="input-group">
                                                <input type="text" 
                                                       id="chat-input-quiz" 
                                                       class="form-control" 
                                                       placeholder="Type a message..." 
                                                       aria-label="Chat message"
                                                       maxlength="200">
                                                <button class="btn btn-primary" id="send-chat-quiz" type="button">
                                                    <i class="fas fa-paper-plane"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div id="mp-question-feedback" class="question-feedback" aria-live="polite">
                                <i class="fas fa-info-circle me-2" aria-hidden="true"></i>
                                <span id="mp-feedback-text"></span>
                            </div>
                            
                            <div class="card question-card">
                                <div class="card-body">
                                    <h4 id="mp-question-text" class="card-title">Loading question...</h4>
                                    <div id="mp-options-container" class="mt-4" role="listbox" aria-label="Answer options">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Multiplayer Results Screen -->
                        <div id="multiplayer-results-screen" class="d-none">
                            <div class="text-center mb-5">
                                <h2>Game Finished! üéâ</h2>
                                <div class="display-4 fw-bold text-primary mb-2" id="mp-final-score">Winner!</div>
                                <div class="d-flex align-items-center justify-content-center mb-3">
                                    <div id="mp-winner-avatar" class="multiplayer-avatar me-3" style="width: 60px; height: 60px; font-size: 1.5rem;" aria-hidden="true"></div>
                                    <div>
                                        <h4 id="mp-winner-name" class="mb-1">Player</h4>
                                        <p class="mb-0 text-muted" id="mp-winner-score">0 points</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5 class="mb-0"><i class="fas fa-trophy me-2" aria-hidden="true"></i>Final Leaderboard</h5>
                                </div>
                                <div class="card-body">
                                    <div id="mp-leaderboard" class="leaderboard" role="list" aria-label="Final rankings">
                                    </div>
                                </div>
                            </div>

                            <div class="text-center mt-4">
                                <button id="play-again-multiplayer" class="btn btn-primary btn-lg me-3">
                                    <i class="fas fa-redo me-2" aria-hidden="true"></i>Play Again
                                </button>
                                <button id="back-to-multiplayer-menu" class="btn btn-outline-primary">
                                    <i class="fas fa-home me-2" aria-hidden="true"></i>Multiplayer Menu
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="text-center mt-4">
                    <small class="text-white-50">
                        &copy; 2024 QuizMaster - Ghana Curriculum Quiz Platform
                    </small>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.min.js"></script>
    
    <script>
        // QuizMaster - Complete JavaScript for Real Player Multiplayer
        console.log('üöÄ Loading QuizMaster JavaScript...');

        // Configuration
        const BACKEND_URL = 'https://quiz-app-backend-3g8p.onrender.com';
        const SOCKET_URL = BACKEND_URL;
        const API_URL = `${BACKEND_URL}/api`;

        // App State
        let currentState = {
            screen: 'category-selection',
            category: null,
            subject: null,
            gameMode: 'single',
            connectionStatus: 'connecting'
        };

        // Sound System
        const soundSystem = {
            enabled: true,
            play(soundName) {
                if (!this.enabled) return;
                try {
                    const sound = document.getElementById(`${soundName}-sound`);
                    if (sound) {
                        sound.currentTime = 0;
                        sound.play().catch(e => console.log('Audio play failed:', e));
                    }
                } catch (error) {
                    console.log('Sound error:', error);
                }
            },
            toggle() {
                this.enabled = !this.enabled;
                const button = document.getElementById('toggle-sound');
                if (button) {
                    button.innerHTML = this.enabled ? 
                        '<i class="fas fa-volume-up me-1"></i> Sound On' : 
                        '<i class="fas fa-volume-mute me-1"></i> Sound Off';
                    button.classList.toggle('btn-outline-success');
                    button.classList.toggle('btn-outline-secondary');
                }
                localStorage.setItem('quizMasterSoundEnabled', this.enabled);
            }
        };

        // Storage Manager
        const storageManager = {
            savePreferences() {
                try {
                    const preferences = {
                        soundEnabled: soundSystem.enabled,
                        selectedAvatar: avatarSystem.selectedAvatar,
                        playerName: document.getElementById('player-name')?.value || 'Player',
                        mpPlayerName: document.getElementById('mp-player-name')?.value || 'Player',
                        lastCategory: categoryManager.currentCategory,
                        lastSubject: categoryManager.currentSubject,
                        savedAt: Date.now()
                    };
                    localStorage.setItem('quizMasterPrefs', JSON.stringify(preferences));
                } catch (error) {
                    console.error('Failed to save preferences:', error);
                }
            },
            
            loadPreferences() {
                try {
                    const saved = localStorage.getItem('quizMasterPrefs');
                    if (saved) {
                        const prefs = JSON.parse(saved);
                        soundSystem.enabled = prefs.soundEnabled !== undefined ? prefs.soundEnabled : true;
                        avatarSystem.selectedAvatar = prefs.selectedAvatar || 'üë®‚Äçüíª';
                        
                        const playerNameInput = document.getElementById('player-name');
                        const mpPlayerNameInput = document.getElementById('mp-player-name');
                        
                        if (playerNameInput && prefs.playerName) {
                            playerNameInput.value = prefs.playerName;
                        }
                        if (mpPlayerNameInput && prefs.mpPlayerName) {
                            mpPlayerNameInput.value = prefs.mpPlayerName;
                        }
                        
                        if (prefs.lastCategory && prefs.lastSubject) {
                            categoryManager.currentCategory = prefs.lastCategory;
                            categoryManager.currentSubject = prefs.lastSubject;
                        }
                    }
                } catch (error) {
                    console.error('Failed to load preferences:', error);
                }
            }
        };

        // Button Manager
        const buttonManager = {
            setLoading(button, isLoading, originalText = null) {
                if (!button) return;
                
                if (isLoading) {
                    button.dataset.originalText = originalText || button.innerHTML;
                    button.disabled = true;
                    button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Loading...';
                    button.classList.add('loading');
                } else {
                    button.disabled = false;
                    button.innerHTML = button.dataset.originalText || originalText || 'Submit';
                    button.classList.remove('loading');
                }
            }
        };

        // Avatar System
        const avatarSystem = {
            selectedAvatar: 'üë®‚Äçüíª',
            init() {
                this.renderAvatarSelection();
                this.renderMultiplayerAvatarSelection();
            },
            
            renderAvatarSelection() {
                const container = document.getElementById('avatar-selection');
                if (!container) return;
                
                const avatars = ['üë®‚Äçüíª', 'üë©‚ÄçüöÄ', 'ü¶∏', 'üë®‚Äçüéì', 'üë©‚Äçüé®', 'ü§ñ', 'üê±', 'ü¶ä'];
                
                container.innerHTML = avatars.map(avatar => `
                    <div class="avatar-option ${avatar === this.selectedAvatar ? 'selected' : ''}" 
                         data-avatar="${avatar}" role="button" aria-label="Select ${avatar} avatar" tabindex="0">
                        <div class="avatar-display" style="font-size: 2rem; cursor: pointer; padding: 5px; border-radius: 10px; border: 3px solid ${avatar === this.selectedAvatar ? '#4361ee' : 'transparent'}">
                            ${avatar}
                        </div>
                    </div>
                `).join('');
                
                container.querySelectorAll('.avatar-option').forEach(option => {
                    option.addEventListener('click', () => {
                        this.selectAvatar(option.dataset.avatar);
                    });
                });
            },

            renderMultiplayerAvatarSelection() {
                const container = document.getElementById('mp-avatar-selection');
                if (!container) return;
                
                const avatars = ['üë®‚Äçüíª', 'üë©‚ÄçüöÄ', 'ü¶∏', 'üë®‚Äçüéì', 'üë©‚Äçüé®', 'ü§ñ', 'üê±', 'ü¶ä'];
                
                container.innerHTML = avatars.map(avatar => `
                    <div class="avatar-option ${avatar === this.selectedAvatar ? 'selected' : ''}" 
                         data-avatar="${avatar}" role="button" aria-label="Select ${avatar} avatar" tabindex="0">
                        <div class="avatar-display" style="font-size: 2rem; cursor: pointer; padding: 5px; border-radius: 10px; border: 3px solid ${avatar === this.selectedAvatar ? '#4361ee' : 'transparent'}">
                            ${avatar}
                        </div>
                    </div>
                `).join('');
                
                container.querySelectorAll('.avatar-option').forEach(option => {
                    option.addEventListener('click', () => {
                        this.selectAvatar(option.dataset.avatar);
                    });
                });
            },
            
            selectAvatar(avatar) {
                this.selectedAvatar = avatar;
                this.renderAvatarSelection();
                this.renderMultiplayerAvatarSelection();
                storageManager.savePreferences();
            }
        };

        // Connection Manager
        const connectionManager = {
            socket: null,
            isConnected: false,
            
            async init() {
                console.log('üîå Initializing connection manager...');
                
                try {
                    this.setConnectionStatus('connecting');
                    
                    this.socket = io(BACKEND_URL, {
                        transports: ['websocket', 'polling'],
                        timeout: 10000
                    });
                    
                    this.socket.on('connect', () => {
                        console.log('‚úÖ Socket.io connected successfully');
                        this.isConnected = true;
                        this.setConnectionStatus('connected');
                    });
                    
                    this.socket.on('disconnect', (reason) => {
                        console.log('‚ùå Socket.io disconnected:', reason);
                        this.isConnected = false;
                        this.setConnectionStatus('disconnected');
                    });
                    
                    this.socket.on('connect_error', (error) => {
                        console.error('Socket.io connection error:', error);
                        this.setConnectionStatus('disconnected');
                    });
                    
                    // Set up event listeners
                    this.setupSocketListeners();
                    
                } catch (error) {
                    console.error('Failed to connect with Socket.io:', error);
                    this.setConnectionStatus('disconnected');
                }
            },
            
            setupSocketListeners() {
                // Game events
                this.socket.on('gameCreated', (data) => {
                    multiplayerSystem.handleGameCreated(data);
                });

                this.socket.on('gameJoined', (data) => {
                    multiplayerSystem.handleGameJoined(data);
                });

                this.socket.on('playerJoined', (data) => {
                    multiplayerSystem.handlePlayerJoined(data);
                });

                this.socket.on('playerLeft', (data) => {
                    multiplayerSystem.handlePlayerLeft(data);
                });

                this.socket.on('gameStarting', (data) => {
                    multiplayerSystem.handleGameStarting(data);
                });

                this.socket.on('gameStarted', (data) => {
                    multiplayerSystem.handleGameStarted(data);
                });

                this.socket.on('playerAnswered', (data) => {
                    multiplayerSystem.handlePlayerAnswered(data);
                });

                this.socket.on('nextQuestion', (data) => {
                    multiplayerSystem.handleNextQuestion(data);
                });

                this.socket.on('gameFinished', (data) => {
                    multiplayerSystem.handleGameFinished(data);
                });

                this.socket.on('gameError', (data) => {
                    categoryManager.showError(data.message);
                });

                this.socket.on('playerReadyChanged', (data) => {
                    multiplayerSystem.handlePlayerReadyChanged(data);
                });

                this.socket.on('newHost', (data) => {
                    multiplayerSystem.handleNewHost(data);
                });

                this.socket.on('chatMessage', (data) => {
                    chatSystem.handleIncomingMessage(data);
                });
            },
            
            async emit(event, data) {
                if (!this.isConnected || !this.socket) {
                    console.warn('‚ö†Ô∏è Cannot emit - socket not connected');
                    return { success: false, error: 'Not connected' };
                }

                try {
                    return new Promise((resolve) => {
                        this.socket.emit(event, data, (response) => {
                            resolve(response || { success: true });
                        });
                    });
                } catch (error) {
                    console.error(`Error emitting ${event}:`, error);
                    return { success: false, error: error.message };
                }
            },
            
            setConnectionStatus(status) {
                currentState.connectionStatus = status;
                const statusElement = document.getElementById('connection-status');
                
                if (statusElement) {
                    statusElement.className = `status ${status}`;
                    
                    switch(status) {
                        case 'connected':
                            statusElement.innerHTML = '<span class="online-indicator online"></span><i class="fas fa-check-circle me-2"></i>Connected';
                            break;
                        case 'disconnected':
                            statusElement.innerHTML = '<span class="online-indicator offline"></span><i class="fas fa-times-circle me-2"></i>Disconnected';
                            break;
                        case 'connecting':
                            statusElement.innerHTML = '<span class="online-indicator connecting"></span><i class="fas fa-sync-alt me-2"></i>Connecting...';
                            break;
                    }
                }
            }
        };

        // Question Manager
        const questionManager = {
            getGhanaCurriculumQuestions(category, subject, difficulty, count) {
                const allQuestions = this.getAllGhanaQuestions();
                
                let filteredQuestions = allQuestions.filter(q => 
                    q.category === category && q.subject === subject
                );
                
                if (difficulty !== 'all') {
                    filteredQuestions = filteredQuestions.filter(q => q.difficulty === difficulty);
                }
                
                return this.shuffleArray(filteredQuestions).slice(0, count);
            },
            
            getAllGhanaQuestions() {
                return [
                    // PRIMARY LEVEL - MATHEMATICS
                    {
                        question: "What is the place value of 7 in the number 4,732?",
                        options: ["Thousands", "Hundreds", "Tens", "Units"],
                        correctAnswer: 1,
                        explanation: "In 4,732, 7 is in the hundreds place (7 √ó 100 = 700).",
                        category: "primary",
                        subject: "mathematics",
                        difficulty: "easy"
                    },
                    {
                        question: "If a bag of rice costs GH‚Çµ 25.50 and you pay with GH‚Çµ 50.00, how much change should you receive?",
                        options: ["GH‚Çµ 24.50", "GH‚Çµ 25.50", "GH‚Çµ 24.00", "GH‚Çµ 23.50"],
                        correctAnswer: 0,
                        explanation: "GH‚Çµ 50.00 - GH‚Çµ 25.50 = GH‚Çµ 24.50",
                        category: "primary",
                        subject: "mathematics",
                        difficulty: "medium"
                    },
                    {
                        question: "Calculate: ¬æ of 48",
                        options: ["12", "24", "36", "40"],
                        correctAnswer: 2,
                        explanation: "¬æ √ó 48 = (48 √∑ 4) √ó 3 = 12 √ó 3 = 36",
                        category: "primary",
                        subject: "mathematics",
                        difficulty: "medium"
                    },

                    // PRIMARY LEVEL - SCIENCE
                    {
                        question: "Which of these is a renewable source of energy?",
                        options: ["Solar power", "Coal", "Natural gas", "Petroleum"],
                        correctAnswer: 0,
                        explanation: "Solar power is renewable because it comes from the sun which won't run out.",
                        category: "primary",
                        subject: "science",
                        difficulty: "easy"
                    },
                    {
                        question: "What is the main function of roots in plants?",
                        options: ["To absorb water and minerals", "To produce food", "To attract insects", "To store air"],
                        correctAnswer: 0,
                        explanation: "Roots anchor the plant and absorb water and minerals from the soil.",
                        category: "primary",
                        subject: "science",
                        difficulty: "easy"
                    },

                    // PRIMARY LEVEL - ENGLISH
                    {
                        question: "Choose the correct plural form of 'child'",
                        options: ["Childs", "Children", "Childes", "Childern"],
                        correctAnswer: 1,
                        explanation: "The irregular plural of 'child' is 'children'.",
                        category: "primary",
                        subject: "english",
                        difficulty: "easy"
                    },
                    {
                        question: "Which word is a noun in this sentence: 'The quick brown fox jumps over the lazy dog'?",
                        options: ["quick", "jumps", "fox", "over"],
                        correctAnswer: 2,
                        explanation: "'Fox' is a noun - it's the name of an animal.",
                        category: "primary",
                        subject: "english",
                        difficulty: "medium"
                    },

                    // PRIMARY LEVEL - SOCIAL STUDIES
                    {
                        question: "Who was the first President of Ghana?",
                        options: ["Jerry John Rawlings", "Kwame Nkrumah", "John Agyekum Kufuor", "John Atta Mills"],
                        correctAnswer: 1,
                        explanation: "Dr. Kwame Nkrumah became Ghana's first President after independence in 1957.",
                        category: "primary",
                        subject: "social_studies",
                        difficulty: "easy"
                    },

                    // JHS - MATHEMATICS
                    {
                        question: "Solve for x: 2x + 5 = 15",
                        options: ["x = 5", "x = 10", "x = 7.5", "x = 20"],
                        correctAnswer: 0,
                        explanation: "2x + 5 = 15 ‚Üí 2x = 10 ‚Üí x = 5",
                        category: "highschool",
                        subject: "mathematics",
                        difficulty: "easy"
                    },
                    {
                        question: "What is the area of a triangle with base 8cm and height 6cm?",
                        options: ["14 cm¬≤", "24 cm¬≤", "48 cm¬≤", "28 cm¬≤"],
                        correctAnswer: 1,
                        explanation: "Area = ¬Ω √ó base √ó height = ¬Ω √ó 8 √ó 6 = 24 cm¬≤",
                        category: "highschool",
                        subject: "mathematics",
                        difficulty: "medium"
                    },

                    // JHS - SCIENCE/PHYSICS
                    {
                        question: "Which of these is a vector quantity?",
                        options: ["Mass", "Speed", "Velocity", "Temperature"],
                        correctAnswer: 2,
                        explanation: "Velocity is a vector quantity because it has both magnitude and direction.",
                        category: "highschool",
                        subject: "physics",
                        difficulty: "medium"
                    },

                    // JHS - SCIENCE/CHEMISTRY
                    {
                        question: "What is the chemical symbol for gold?",
                        options: ["Go", "Gd", "Au", "Ag"],
                        correctAnswer: 2,
                        explanation: "The chemical symbol for gold is Au (from Latin 'aurum').",
                        category: "highschool",
                        subject: "chemistry",
                        difficulty: "easy"
                    },

                    // JHS - SCIENCE/BIOLOGY
                    {
                        question: "Which cell organelle is known as the 'powerhouse of the cell'?",
                        options: ["Nucleus", "Mitochondria", "Ribosome", "Chloroplast"],
                        correctAnswer: 1,
                        explanation: "Mitochondria produce energy (ATP) for the cell through cellular respiration.",
                        category: "highschool",
                        subject: "biology",
                        difficulty: "easy"
                    },

                    // JHS - HISTORY
                    {
                        question: "In which year did Ghana gain independence?",
                        options: ["1951", "1957", "1960", "1945"],
                        correctAnswer: 1,
                        explanation: "Ghana gained independence from British colonial rule on March 6, 1957.",
                        category: "highschool",
                        subject: "history",
                        difficulty: "easy"
                    },

                    // SHS - MATHEMATICS (ADVANCED)
                    {
                        question: "Differentiate: y = 3x¬≤ + 2x - 5",
                        options: ["dy/dx = 6x + 2", "dy/dx = 3x + 2", "dy/dx = 6x", "dy/dx = 3x¬≤ + 2"],
                        correctAnswer: 0,
                        explanation: "Using power rule: d/dx(3x¬≤) = 6x, d/dx(2x) = 2, d/dx(-5) = 0",
                        category: "highschool",
                        subject: "mathematics",
                        difficulty: "hard"
                    },

                    // TERTIARY - PROGRAMMING
                    {
                        question: "Which of these is NOT a programming language?",
                        options: ["Python", "Java", "HTML", "C++"],
                        correctAnswer: 2,
                        explanation: "HTML is a markup language, not a programming language.",
                        category: "tertiary",
                        subject: "programming",
                        difficulty: "easy"
                    },

                    // TERTIARY - BUSINESS
                    {
                        question: "What does ROI stand for in business?",
                        options: ["Return on Investment", "Rate of Interest", "Return on Income", "Rate of Investment"],
                        correctAnswer: 0,
                        explanation: "ROI stands for Return on Investment - a measure of profitability.",
                        category: "tertiary",
                        subject: "business",
                        difficulty: "easy"
                    }
                ];
            },
            
            shuffleArray(array) {
                const shuffled = [...array];
                for (let i = shuffled.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
                }
                return shuffled;
            }
        };

        // Category Manager
        const categoryManager = {
            categories: {
                primary: {
                    name: "Primary School (Basic 1-6)",
                    subjects: ["mathematics", "science", "english", "social_studies"],
                    difficulties: ["easy", "medium"],
                    description: "Basic Education Certificate Examination (BECE) level"
                },
                highschool: {
                    name: "Junior & Senior High School", 
                    subjects: ["mathematics", "physics", "chemistry", "biology", "history", "geography"],
                    difficulties: ["easy", "medium", "hard"],
                    description: "West African Senior School Certificate Examination (WASSCE) level"
                },
                tertiary: {
                    name: "Tertiary Education",
                    subjects: ["programming", "business", "engineering", "medicine", "law", "economics"],
                    difficulties: ["medium", "hard"],
                    description: "University and College level education"
                }
            },
            currentCategory: null,
            currentSubject: null,
            
            init() {
                this.setupEventListeners();
            },
            
            setupEventListeners() {
                document.querySelectorAll('.category-card').forEach(card => {
                    card.addEventListener('click', () => {
                        this.selectCategory(card.dataset.category);
                    });
                });
                
                const backButton = document.getElementById('back-to-categories');
                if (backButton) {
                    backButton.addEventListener('click', () => {
                        this.showCategorySelection();
                    });
                }
            },
            
            selectCategory(categoryId) {
                document.querySelectorAll('.category-card').forEach(card => {
                    card.classList.remove('selected', 'border-primary');
                });
                
                const selectedCard = document.querySelector(`[data-category="${categoryId}"]`);
                if (selectedCard) {
                    selectedCard.classList.add('selected', 'border-primary');
                }
                
                this.currentCategory = categoryId;
                const category = this.categories[categoryId];
                
                if (!category) {
                    this.showError('Category not found. Please try again.');
                    return;
                }
                
                this.showSubjectSelection(category);
            },
            
            showSubjectSelection(category) {
                document.getElementById('category-title').textContent = `Select Subject - ${category.name}`;
                
                const container = document.getElementById('subjects-container');
                container.innerHTML = '';
                
                const subjectNames = {
                    mathematics: { icon: 'fa-calculator', color: 'primary', name: 'Mathematics' },
                    science: { icon: 'fa-flask', color: 'success', name: 'Integrated Science' },
                    english: { icon: 'fa-language', color: 'info', name: 'English Language' },
                    social_studies: { icon: 'fa-globe-africa', color: 'warning', name: 'Social Studies' },
                    physics: { icon: 'fa-atom', color: 'danger', name: 'Physics' },
                    chemistry: { icon: 'fa-vial', color: 'success', name: 'Chemistry' },
                    biology: { icon: 'fa-dna', color: 'success', name: 'Biology' },
                    history: { icon: 'fa-landmark', color: 'warning', name: 'History' },
                    geography: { icon: 'fa-map', color: 'info', name: 'Geography' },
                    programming: { icon: 'fa-code', color: 'dark', name: 'Computer Science' },
                    business: { icon: 'fa-chart-line', color: 'success', name: 'Business Studies' },
                    engineering: { icon: 'fa-cogs', color: 'info', name: 'Engineering' },
                    medicine: { icon: 'fa-heartbeat', color: 'danger', name: 'Medicine' },
                    law: { icon: 'fa-gavel', color: 'warning', name: 'Law' },
                    economics: { icon: 'fa-money-bill-wave', color: 'success', name: 'Economics' }
                };
                
                category.subjects.forEach(subjectId => {
                    const subject = subjectNames[subjectId] || { 
                        icon: 'fa-book', 
                        color: 'secondary', 
                        name: subjectId 
                    };
                    
                    const col = document.createElement('div');
                    col.className = 'col-md-4 col-sm-6 mb-4';
                    col.innerHTML = `
                        <div class="card subject-card h-100" data-subject="${subjectId}" 
                             role="button" aria-label="Select ${subject.name} subject" tabindex="0">
                            <div class="card-body text-center d-flex flex-column">
                                <i class="fas ${subject.icon} fa-2x mb-3 text-${subject.color}" aria-hidden="true"></i>
                                <h5 class="card-title">${subject.name}</h5>
                                <p class="card-text small flex-grow-1">${category.description}</p>
                                <div class="mt-2">
                                    ${this.getDifficultyBadges(category.difficulties)}
                                </div>
                            </div>
                        </div>
                    `;
                    container.appendChild(col);
                });
                
                setTimeout(() => {
                    document.querySelectorAll('.subject-card').forEach(card => {
                        card.addEventListener('click', () => {
                            this.selectSubject(card.dataset.subject);
                        });
                    });
                }, 100);
                
                this.showScreen('subject-selection');
            },
            
            getDifficultyBadges(difficulties) {
                const difficultyColors = {
                    easy: 'success',
                    medium: 'warning',
                    hard: 'danger'
                };
                
                return difficulties.map(diff => 
                    `<span class="badge bg-${difficultyColors[diff]} me-1">${diff}</span>`
                ).join('');
            },
            
            getSubjectDisplayName(subjectId) {
                const subjectNames = {
                    mathematics: { icon: 'fa-calculator', color: 'primary', name: 'Mathematics' },
                    science: { icon: 'fa-flask', color: 'success', name: 'Integrated Science' },
                    english: { icon: 'fa-language', color: 'info', name: 'English Language' },
                    social_studies: { icon: 'fa-globe-africa', color: 'warning', name: 'Social Studies' },
                    physics: { icon: 'fa-atom', color: 'danger', name: 'Physics' },
                    chemistry: { icon: 'fa-vial', color: 'success', name: 'Chemistry' },
                    biology: { icon: 'fa-dna', color: 'success', name: 'Biology' },
                    history: { icon: 'fa-landmark', color: 'warning', name: 'History' },
                    geography: { icon: 'fa-map', color: 'info', name: 'Geography' },
                    programming: { icon: 'fa-code', color: 'dark', name: 'Computer Science' },
                    business: { icon: 'fa-chart-line', color: 'success', name: 'Business Studies' },
                    engineering: { icon: 'fa-cogs', color: 'info', name: 'Engineering' },
                    medicine: { icon: 'fa-heartbeat', color: 'danger', name: 'Medicine' },
                    law: { icon: 'fa-gavel', color: 'warning', name: 'Law' },
                    economics: { icon: 'fa-money-bill-wave', color: 'success', name: 'Economics' }
                };
                return subjectNames[subjectId] || { icon: 'fa-book', color: 'secondary', name: subjectId };
            },
            
            selectSubject(subjectId) {
                document.querySelectorAll('.subject-card').forEach(card => {
                    card.classList.remove('selected', 'border-primary');
                });
                
                const selectedCard = document.querySelector(`[data-subject="${subjectId}"]`);
                if (selectedCard) {
                    selectedCard.classList.add('selected', 'border-primary');
                }
                
                this.currentSubject = subjectId;
            },
            
            showCategorySelection() {
                this.showScreen('category-selection');
                this.currentCategory = null;
                this.currentSubject = null;
            },
            
        // In categoryManager object, update showScreen method:

showScreen(screenName) {
    console.log('üîÑ Switching to screen:', screenName);
    
    const screens = [
        'category-selection',
        'subject-selection', 
        'multiplayer-setup',
        'multiplayer-lobby',
        'quiz-screen',
        'results-screen',
        'multiplayer-quiz-screen',
        'multiplayer-results-screen',
        'dashboard-screen'
    ];
    
    screens.forEach(screen => {
        const element = document.getElementById(screen);
        if (element) {
            element.classList.add('d-none');
            element.setAttribute('aria-hidden', 'true');
        }
    });
    
    const targetScreen = document.getElementById(screenName);
    if (targetScreen) {
        targetScreen.classList.remove('d-none');
        targetScreen.setAttribute('aria-hidden', 'false');
        currentState.screen = screenName;
        
        console.log('‚úÖ Screen switched to:', screenName);
        
        // Focus management for accessibility
        const mainHeading = targetScreen.querySelector('h1, h2, h3');
        if (mainHeading) {
            setTimeout(() => mainHeading.focus(), 100);
        }
    } else {
        console.error('‚ùå Target screen not found:', screenName);
    }
},
            getCurrentSettings() {
                return {
                    category: this.currentCategory,
                    subject: this.currentSubject,
                    difficulty: document.getElementById('difficulty-select').value,
                    questionCount: parseInt(document.getElementById('question-count').value),
                    questionSource: document.getElementById('question-source').value,
                    gameMode: document.querySelector('input[name="gameMode"]:checked').value
                };
            },
            
            showError(message) {
                const errorElement = document.getElementById('error-message');
                const errorText = document.getElementById('error-text');
                if (errorElement && errorText) {
                    errorText.textContent = message;
                    errorElement.classList.remove('d-none');
                    
                    setTimeout(() => {
                        errorElement.classList.add('d-none');
                    }, 5000);
                }
            },
            
            showSuccess(message) {
                const successElement = document.getElementById('success-message');
                const successText = document.getElementById('success-text');
                if (successElement && successText) {
                    successText.textContent = message;
                    successElement.classList.remove('d-none');
                    
                    setTimeout(() => {
                        successElement.classList.add('d-none');
                    }, 3000);
                }
            },
            
            showLoading(show) {
                const loadingElement = document.getElementById('loading-spinner');
                if (loadingElement) {
                    loadingElement.classList.toggle('d-none', !show);
                }
            }
        };

        // Single Player System
        const singlePlayerSystem = {
            currentGame: null,
            timerInterval: null,
            timeLeft: 0,
            
            init() {
                console.log('üéÆ Single player system initialized');
            },
            
            async startGame(category, subject, playerName, avatar, difficulty, questionCount, questionSource) {
                try {
                    const startBtn = document.getElementById('start-quiz-btn');
                    buttonManager.setLoading(startBtn, true, 'Starting Game...');
                    
                    const questions = questionManager.getGhanaCurriculumQuestions(
                        category, subject, difficulty, questionCount
                    );
                    
                    if (questions.length === 0) {
                        categoryManager.showError('No questions available.');
                        buttonManager.setLoading(startBtn, false, 'Start Quiz');
                        return false;
                    }
                    
                    this.currentGame = {
                        category: category,
                        subject: subject,
                        playerName: playerName,
                        avatar: avatar,
                        questions: questions,
                        currentQuestion: 0,
                        answers: [],
                        score: 0,
                        startTime: Date.now(),
                        timePerQuestion: 30
                    };
                    
                    this.loadQuestion(0);
                    this.startTimer();
                    
                    buttonManager.setLoading(startBtn, false, 'Start Quiz');
                    return true;
                    
                } catch (error) {
                    console.error('Error starting game:', error);
                    categoryManager.showError('Error starting game. Please try again.');
                    const startBtn = document.getElementById('start-quiz-btn');
                    buttonManager.setLoading(startBtn, false, 'Start Quiz');
                    return false;
                }
            },
            
            loadQuestion(questionIndex) {
                if (!this.currentGame || questionIndex >= this.currentGame.questions.length) {
                    this.finishGame();
                    return;
                }
                
                this.currentGame.currentQuestion = questionIndex;
                const question = this.currentGame.questions[questionIndex];
                
                document.getElementById('current-subject').textContent = 
                    `${this.currentGame.category} - ${this.currentGame.subject}`;
                
                document.getElementById('question-count-display').textContent = 
                    `Question ${questionIndex + 1} of ${this.currentGame.questions.length}`;
                
                document.getElementById('question-text').textContent = question.question;
                
                const progress = ((questionIndex) / this.currentGame.questions.length) * 100;
                document.getElementById('progress-bar').style.width = `${progress}%`;
                
                const optionsContainer = document.getElementById('options-container');
                optionsContainer.innerHTML = '';
                
                question.options.forEach((option, index) => {
                    const optionElement = document.createElement('div');
                    optionElement.className = 'option';
                    optionElement.setAttribute('role', 'button');
                    optionElement.setAttribute('aria-label', `Option ${String.fromCharCode(65 + index)}: ${option}`);
                    optionElement.setAttribute('tabindex', '0');
                    optionElement.innerHTML = `
                        <div class="option-content">
                            <div class="option-letter">${String.fromCharCode(65 + index)}</div>
                            <div class="option-text">${option}</div>
                        </div>
                    `;
                    
                    optionElement.addEventListener('click', () => {
                        this.selectAnswer(index);
                    });
                    
                    optionsContainer.appendChild(optionElement);
                });
                
                this.resetTimer();
                
                document.getElementById('prev-question').style.display = 
                    questionIndex > 0 ? 'inline-block' : 'none';
                
                document.getElementById('next-question').style.display = 
                    questionIndex < this.currentGame.questions.length - 1 ? 'inline-block' : 'none';
                
                document.getElementById('submit-quiz').style.display = 
                    questionIndex === this.currentGame.questions.length - 1 ? 'inline-block' : 'none';
                
                const feedbackElement = document.getElementById('question-feedback');
                if (feedbackElement) {
                    feedbackElement.classList.remove('show');
                }
                
                categoryManager.showScreen('quiz-screen');
            },
            
            selectAnswer(optionIndex) {
                const question = this.currentGame.questions[this.currentGame.currentQuestion];
                const options = document.querySelectorAll('.option');
                
                options.forEach(opt => {
                    opt.style.pointerEvents = 'none';
                    opt.classList.remove('selected', 'correct', 'incorrect');
                });
                
                options[optionIndex].classList.add('selected');
                
                const isCorrect = optionIndex === question.correctAnswer;
                
                if (isCorrect) {
                    soundSystem.play('correct');
                    options[optionIndex].classList.add('correct');
                } else {
                    soundSystem.play('wrong');
                    options[optionIndex].classList.add('incorrect');
                    if (question.correctAnswer >= 0 && question.correctAnswer < options.length) {
                        options[question.correctAnswer].classList.add('correct');
                    }
                }
                
                const feedbackElement = document.getElementById('question-feedback');
                const feedbackText = document.getElementById('feedback-text');
                
                if (feedbackElement && feedbackText) {
                    feedbackElement.className = `question-feedback ${isCorrect ? 'correct' : 'incorrect'} show`;
                    feedbackText.textContent = question.explanation || 
                        (isCorrect ? 'Correct! Well done.' : `Incorrect. The right answer is ${String.fromCharCode(65 + question.correctAnswer)}.`);
                }
                
                this.currentGame.answers[this.currentGame.currentQuestion] = {
                    selected: optionIndex,
                    isCorrect: isCorrect,
                    timeSpent: this.currentGame.timePerQuestion - this.timeLeft
                };
                
                if (isCorrect) {
                    this.currentGame.score += 10;
                }
                
                setTimeout(() => {
                    this.nextQuestion();
                }, 3000);
            },
            
            nextQuestion() {
                if (this.currentGame.currentQuestion < this.currentGame.questions.length - 1) {
                    this.loadQuestion(this.currentGame.currentQuestion + 1);
                } else {
                    this.finishGame();
                }
            },
            
            prevQuestion() {
                if (this.currentGame.currentQuestion > 0) {
                    this.loadQuestion(this.currentGame.currentQuestion - 1);
                }
            },
            
            submitQuiz() {
                this.finishGame();
            },
            
            finishGame() {
                clearInterval(this.timerInterval);
                
                let correctAnswers = 0;
                this.currentGame.questions.forEach((question, index) => {
                    if (this.currentGame.answers[index] && this.currentGame.answers[index].isCorrect) {
                        correctAnswers++;
                    }
                });
                
                this.currentGame.score = correctAnswers * 10;
                this.currentGame.endTime = Date.now();
                
                const timeTaken = Math.floor((this.currentGame.endTime - this.currentGame.startTime) / 1000);
                
                this.showResults(correctAnswers, timeTaken);
            },
            
            showResults(correctAnswers, timeTaken) {
                const totalQuestions = this.currentGame.questions.length;
                const percentage = Math.round((correctAnswers / totalQuestions) * 100);
                
                document.getElementById('final-score').textContent = `${correctAnswers}/${totalQuestions}`;
                document.getElementById('points-earned').textContent = `${this.currentGame.score} points`;
                
                const statsContainer = document.getElementById('performance-stats');
                statsContainer.innerHTML = `
                    <div class="row text-center">
                        <div class="col-md-3 mb-3">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h3 class="text-primary">${percentage}%</h3>
                                    <p class="mb-0">Score</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h3 class="text-success">${correctAnswers}</h3>
                                    <p class="mb-0">Correct</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h3 class="text-danger">${totalQuestions - correctAnswers}</h3>
                                    <p class="mb-0">Incorrect</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h3 class="text-info">${Math.floor(timeTaken / 60)}:${(timeTaken % 60).toString().padStart(2, '0')}</h3>
                                    <p class="mb-0">Time</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                if (percentage >= 80) {
                    document.getElementById('confetti').style.display = 'block';
                    soundSystem.play('victory');
                    
                    setTimeout(() => {
                        document.getElementById('confetti').style.display = 'none';
                    }, 5000);
                }
                
                categoryManager.showScreen('results-screen');
            },
            
            startTimer() {
                this.timeLeft = this.currentGame.timePerQuestion;
                this.updateTimerDisplay();
                
                this.timerInterval = setInterval(() => {
                    this.timeLeft--;
                    this.updateTimerDisplay();
                    
                    if (this.timeLeft <= 0) {
                        clearInterval(this.timerInterval);
                        this.nextQuestion();
                    }
                }, 1000);
            },
            
            resetTimer() {
                clearInterval(this.timerInterval);
                this.startTimer();
            },
            
            updateTimerDisplay() {
                const timerElement = document.getElementById('time-left');
                if (timerElement) {
                    timerElement.textContent = this.timeLeft;
                    timerElement.className = `timer ${this.timeLeft <= 10 ? 'warning' : ''} ${this.timeLeft <= 5 ? 'danger' : ''}`;
                }
            }
        };

        // Chat System
        const chatSystem = {
            init() {
                this.setupChatListeners();
            },
            
            setupChatListeners() {
                const sendLobbyBtn = document.getElementById('send-chat-lobby');
                const lobbyInput = document.getElementById('chat-input-lobby');
                
                const sendQuizBtn = document.getElementById('send-chat-quiz');
                const quizInput = document.getElementById('chat-input-quiz');
                
                if (sendLobbyBtn && lobbyInput) {
                    sendLobbyBtn.addEventListener('click', () => this.sendMessage('lobby'));
                    lobbyInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') this.sendMessage('lobby');
                    });
                }
                
                if (sendQuizBtn && quizInput) {
                    sendQuizBtn.addEventListener('click', () => this.sendMessage('quiz'));
                    quizInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') this.sendMessage('quiz');
                    });
                }
            },
            
            async sendMessage(context) {
                const inputId = `chat-input-${context}`;
                const messagesId = `chat-messages-${context}`;
                
                const input = document.getElementById(inputId);
                const message = input.value.trim();
                
                if (!message) return;
                
                const playerName = document.getElementById('mp-player-name')?.value || 'Player';
                
                this.addMessage(playerName, message, false, messagesId);
                
                if (connectionManager.isConnected && multiplayerSystem.currentRoom) {
                    await connectionManager.emit('chatMessage', {
                        gameCode: multiplayerSystem.currentRoom.code,
                        message: message,
                        playerName: playerName,
                        playerId: multiplayerSystem.playerId
                    });
                }
                
                input.value = '';
                input.focus();
            },
            
            handleIncomingMessage(data) {
                if (multiplayerSystem.currentRoom) {
                    if (data.playerId !== multiplayerSystem.playerId) {
                        this.addMessage(data.playerName, data.message, false, 'chat-messages-lobby');
                        this.addMessage(data.playerName, data.message, false, 'chat-messages-quiz');
                    }
                }
            },
            
            addMessage(playerName, message, isSystem = false, containerId) {
                const timestamp = new Date().toLocaleTimeString();
                
                const container = document.getElementById(containerId);
                if (!container) return;
                
                const messageElement = document.createElement('div');
                messageElement.className = `chat-message ${isSystem ? 'system-message' : ''} ${playerName === (document.getElementById('mp-player-name')?.value || 'Player') ? 'own-message' : ''}`;
                messageElement.innerHTML = `
                    <div class="message-header">
                        ${!isSystem ? `<strong>${playerName}</strong>` : '<em>System</em>'}
                        <small class="text-muted ms-2">${timestamp}</small>
                    </div>
                    <div class="message-content">${this.escapeHtml(message)}</div>
                `;
                container.appendChild(messageElement);
                container.scrollTop = container.scrollHeight;
            },
            
            addSystemMessage(message, containerId) {
                this.addMessage('', message, true, containerId);
            },
            
            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
        };

        // Multiplayer System
        const multiplayerSystem = {
            currentRoom: null,
            players: [],
            gameState: null,
            timerInterval: null,
            timeLeft: 0,
            playerId: null,
            
            init() {
                console.log('üéÆ Multiplayer system initialized for real players only');
                this.playerId = this.generatePlayerId();
            },
            
            generatePlayerId() {
                let playerId = localStorage.getItem('quizMasterPlayerId');
                if (!playerId) {
                    playerId = 'player_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now().toString(36);
                    localStorage.setItem('quizMasterPlayerId', playerId);
                }
                return playerId;
            },

            // Event handlers
      // In connectionManager setupSocketListeners(), update these handlers:

setupSocketListeners() {
    // Game events
    this.socket.on('gameCreated', (data) => {
        console.log('üéÆ Game created:', data);
        multiplayerSystem.handleGameCreated(data);
    });

    this.socket.on('gameJoined', (data) => {
        console.log('üéÆ Game joined:', data);
        multiplayerSystem.handleGameJoined(data);
    });

    this.socket.on('playerJoined', (data) => {
        console.log('üë§ Player joined:', data);
        multiplayerSystem.handlePlayerJoined(data);
    });

    this.socket.on('playerLeft', (data) => {
        console.log('üë§ Player left:', data);
        multiplayerSystem.handlePlayerLeft(data);
    });

    this.socket.on('gameStarting', (data) => {
        console.log('üéÆ Game starting:', data);
        multiplayerSystem.handleGameStarting(data);
    });

    this.socket.on('gameStarted', (data) => {
        console.log('üéÆ Game started:', data);
        multiplayerSystem.handleGameStarted(data);
    });

    this.socket.on('playerAnswered', (data) => {
        console.log('‚úÖ Player answered:', data);
        multiplayerSystem.handlePlayerAnswered(data);
    });

    this.socket.on('nextQuestion', (data) => {
        console.log('‚ùì Next question:', data);
        multiplayerSystem.handleNextQuestion(data);
    });

    this.socket.on('gameFinished', (data) => {
        console.log('üèÅ Game finished:', data);
        multiplayerSystem.handleGameFinished(data);
    });

    this.socket.on('gameError', (data) => {
        console.error('‚ùå Game error:', data);
        categoryManager.showError(data.message);
    });

    this.socket.on('playerReadyChanged', (data) => {
        console.log('‚úÖ Player ready changed:', data);
        multiplayerSystem.handlePlayerReadyChanged(data);
    });

    this.socket.on('newHost', (data) => {
        console.log('üëë New host:', data);
        multiplayerSystem.handleNewHost(data);
    });

    this.socket.on('chatMessage', (data) => {
        console.log('üí¨ Chat message:', data);
        chatSystem.handleIncomingMessage(data);
    });
},

// In multiplayerSystem object, update these methods:

handleGameCreated(data) {
    console.log('‚úÖ Game created on server:', data.gameCode);
    
    this.currentRoom = {
        code: data.gameCode,
        host: data.hostId,
        settings: data.settings,
        status: 'waiting'
    };
    
    this.players = data.players || [];
    
    this.updateLobbyDisplay();
    categoryManager.showSuccess(`Room created! Code: ${data.gameCode}`);
    chatSystem.addSystemMessage(`Room created. Share code: ${data.gameCode}`, 'chat-messages-lobby');
    chatSystem.addSystemMessage('Waiting for other players to join...', 'chat-messages-lobby');
    
    // Ensure we're on the lobby screen
    categoryManager.showScreen('multiplayer-lobby');
},

handleGameJoined(data) {
    console.log('‚úÖ Joined game on server:', data.gameCode);
    
    this.currentRoom = {
        code: data.gameCode,
        host: data.hostId,
        settings: data.settings,
        status: 'waiting'
    };
    
    this.players = data.players || [];
    
    this.updateLobbyDisplay();
    categoryManager.showSuccess(`Joined room: ${data.gameCode}`);
    chatSystem.addSystemMessage(`You joined the room. Welcome!`, 'chat-messages-lobby');
    
    // Ensure we're on the lobby screen
    categoryManager.showScreen('multiplayer-lobby');
},

handleGameStarting(data) {
    console.log('üéÆ Game starting with countdown:', data);
    chatSystem.addSystemMessage(`Game starting in ${data.countdown} seconds...`, 'chat-messages-lobby');
    
    this.showGameCountdown(data.countdown);
},

handleGameStarted(data) {
    console.log('üéÆ Game started with questions:', data.questions?.length);
    
    if (!this.currentRoom) {
        console.error('‚ùå No current room when game started');
        return;
    }
    
    this.gameState = {
        currentQuestion: 0,
        questions: data.questions,
        players: [...this.players],
        timePerQuestion: 30,
        startTime: Date.now()
    };
    
    // Reset player answer status for new game
    this.players.forEach(player => {
        player.hasAnswered = false;
        player.score = 0;
    });
    
    chatSystem.addSystemMessage('Game started! Good luck everyone!', 'chat-messages-lobby');
    
    // Force screen change to quiz screen
    setTimeout(() => {
        this.loadQuestion(0);
    }, 1000);
},

handleNextQuestion(data) {
    console.log('‚ùì Next question received:', data.index);
    this.loadQuestion(data.index);
},

// Enhanced loadQuestion method with better error handling
loadQuestion(questionIndex) {
    console.log('üìù Loading question:', questionIndex);
    
    if (!this.gameState) {
        console.error('‚ùå No game state available');
        return;
    }
    
    if (questionIndex >= this.gameState.questions.length) {
        console.log('üèÅ No more questions, finishing game');
        this.showResults(this.gameState.players);
        return;
    }
    
    this.gameState.currentQuestion = questionIndex;
    const question = this.gameState.questions[questionIndex];
    
    if (!question) {
        console.error('‚ùå Invalid question at index:', questionIndex);
        return;
    }
    
    console.log('üìã Question loaded:', question.question.substring(0, 50) + '...');
    
    // Reset answered status for new question
    this.players.forEach(player => {
        player.hasAnswered = false;
    });
    
    // Update UI with Ghana curriculum info
    const examInfo = {
        primary: "BECE Curriculum",
        highschool: "WASSCE Curriculum", 
        tertiary: "Tertiary Education"
    };
    
    const subjectInfo = categoryManager.getSubjectDisplayName(this.currentRoom.settings.subject);
    const subjectElement = document.getElementById('mp-current-subject');
    if (subjectElement) {
        subjectElement.textContent = `${subjectInfo.name} - ${examInfo[this.currentRoom.settings.category]}`;
    }
    
    const questionCountElement = document.getElementById('mp-question-count-display');
    if (questionCountElement) {
        questionCountElement.textContent = `Question ${questionIndex + 1} of ${this.gameState.questions.length}`;
    }
    
    const questionTextElement = document.getElementById('mp-question-text');
    if (questionTextElement) {
        questionTextElement.textContent = question.question;
    }
    
    // Update progress bar
    const progress = ((questionIndex) / this.gameState.questions.length) * 100;
    const progressBar = document.getElementById('mp-progress-bar');
    if (progressBar) {
        progressBar.style.width = `${progress}%`;
        progressBar.setAttribute('aria-valuenow', progress);
    }
    
    // Render options
    const optionsContainer = document.getElementById('mp-options-container');
    if (optionsContainer) {
        optionsContainer.innerHTML = '';
        
        question.options.forEach((option, index) => {
            const optionElement = document.createElement('div');
            optionElement.className = 'option';
            optionElement.setAttribute('role', 'button');
            optionElement.setAttribute('aria-label', `Option ${String.fromCharCode(65 + index)}: ${option}`);
            optionElement.setAttribute('tabindex', '0');
            optionElement.innerHTML = `
                <div class="option-content">
                    <div class="option-letter">${String.fromCharCode(65 + index)}</div>
                    <div class="option-text">${option}</div>
                </div>
            `;
            
            optionElement.addEventListener('click', () => {
                console.log('üñ±Ô∏è Option clicked:', index);
                this.selectAnswer(index);
            });
            
            optionElement.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' || e.key === ' ') {
                    console.log('‚å®Ô∏è Option selected via keyboard:', index);
                    this.selectAnswer(index);
                }
            });
            
            optionsContainer.appendChild(optionElement);
        });
    }
    
    // Start timer
    this.startTimer();
    
    // Update scoreboard
    this.updateScoreboard();
    
    // Switch to quiz screen
    console.log('üîÑ Switching to multiplayer quiz screen');
    categoryManager.showScreen('multiplayer-quiz-screen');
    
    // Add chat message for new question
    chatSystem.addSystemMessage(`Question ${questionIndex + 1} started!`, 'chat-messages-quiz');
},

// Enhanced selectAnswer method
selectAnswer(optionIndex) {
    console.log('üéØ Answer selected:', optionIndex);
    
    if (!this.gameState) {
        console.error('‚ùå No game state when answering');
        return;
    }
    
    const questionIndex = this.gameState.currentQuestion;
    const question = this.gameState.questions[questionIndex];
    const options = document.querySelectorAll('#mp-options-container .option');
    
    console.log('üìä Question details:', {
        questionIndex,
        correctAnswer: question.correctAnswer,
        selectedAnswer: optionIndex
    });
    
    // Disable all options after selection
    options.forEach(opt => {
        opt.style.pointerEvents = 'none';
        opt.classList.remove('selected', 'correct', 'incorrect');
    });
    
    options[optionIndex].classList.add('selected');
    
    const isCorrect = optionIndex === question.correctAnswer;
    console.log('‚úÖ Answer correct:', isCorrect);
    
    // Show correct/incorrect feedback
    if (isCorrect) {
        soundSystem.play('correct');
        options[optionIndex].classList.add('correct');
    } else {
        soundSystem.play('wrong');
        options[optionIndex].classList.add('incorrect');
        if (question.correctAnswer >= 0 && question.correctAnswer < options.length) {
            options[question.correctAnswer].classList.add('correct');
        }
    }
    
    // Submit answer
    this.submitAnswer(questionIndex, optionIndex);
    
    // Show explanation
    const feedbackElement = document.getElementById('mp-question-feedback');
    const feedbackText = document.getElementById('mp-feedback-text');
    
    if (feedbackElement && feedbackText) {
        feedbackElement.className = `question-feedback ${isCorrect ? 'correct' : 'incorrect'} show`;
        feedbackText.textContent = question.explanation || 
            (isCorrect ? 'Correct! Well done.' : `Incorrect. The right answer is ${String.fromCharCode(65 + question.correctAnswer)}.`);
        feedbackElement.setAttribute('aria-live', 'assertive');
    }
},
            // Room management
            async createRoom(settings) {
                const createBtn = document.getElementById('create-room-btn');
                buttonManager.setLoading(createBtn, true, 'Creating Room...');
                
                try {
                    const playerName = document.getElementById('mp-player-name').value || 'Player';
                    const avatar = avatarSystem.selectedAvatar;
                    
                    storageManager.savePreferences();
                    
                    const result = await connectionManager.emit('createGame', {
                        playerName: playerName,
                        avatar: avatar,
                        settings: settings
                    });
                    
                    if (!result.success) {
                        throw new Error(result.error || 'Failed to create room');
                    }
                    
                    console.log('üì§ Room creation request sent to server');
                    
                } catch (error) {
                    console.error('Error creating room:', error);
                    categoryManager.showError(error.message || 'Failed to create room. Please try again.');
                } finally {
                    buttonManager.setLoading(createBtn, false, 'Create Room');
                }
            },

            async joinRoom(roomCode) {
                const joinBtn = document.getElementById('join-room-btn');
                buttonManager.setLoading(joinBtn, true, 'Joining Room...');
                
                try {
                    const playerName = document.getElementById('mp-player-name').value || 'Player';
                    const avatar = avatarSystem.selectedAvatar;

                    if (!roomCode) {
                        categoryManager.showError('Please enter a room code');
                        return false;
                    }

                    storageManager.savePreferences();

                    const result = await connectionManager.emit('joinGame', {
                        gameCode: roomCode.toUpperCase(),
                        playerName: playerName,
                        avatar: avatar
                    });

                    if (!result.success) {
                        throw new Error(result.error || 'Failed to join room');
                    }

                    return true;

                } catch (error) {
                    console.error('Error joining room:', error);
                    categoryManager.showError(error.message || 'Failed to join room. Please check the room code.');
                    return false;
                } finally {
                    buttonManager.setLoading(joinBtn, false, 'Join Room');
                }
            },

            async sendPlayerReady() {
                if (this.currentRoom) {
                    const player = this.players.find(p => p.id === this.playerId);
                    if (player) {
                        player.ready = !player.ready;
                        
                        // Update button UI
                        const readyBtn = document.getElementById('toggle-ready-btn');
                        if (readyBtn) {
                            if (player.ready) {
                                readyBtn.innerHTML = '<i class="fas fa-check me-1"></i>Ready';
                                readyBtn.classList.remove('btn-outline-primary');
                                readyBtn.classList.add('btn-success', 'ready');
                            } else {
                                readyBtn.innerHTML = '<i class="fas fa-clock me-1"></i>Not Ready';
                                readyBtn.classList.remove('btn-success', 'ready');
                                readyBtn.classList.add('btn-outline-primary');
                            }
                        }
                        
                        await connectionManager.emit('playerReady', {
                            gameCode: this.currentRoom.code,
                            ready: player.ready
                        });
                        
                        this.updateLobbyDisplay();
                    }
                }
            },

            async startGame() {
                if (!this.currentRoom) {
                    categoryManager.showError('No room found');
                    return;
                }

                const currentPlayer = this.players.find(p => p.id === this.playerId);
                if (!currentPlayer?.isHost) {
                    categoryManager.showError('Only the host can start the game');
                    return;
                }

                if (this.players.length < 2) {
                    categoryManager.showError('Need at least 2 players to start the game');
                    return;
                }

                if (!this.players.every(p => p.ready)) {
                    categoryManager.showError('All players must be ready before starting');
                    return;
                }

                const startBtn = document.getElementById('start-game-btn');
                buttonManager.setLoading(startBtn, true, 'Starting Game...');

                try {
                    const result = await connectionManager.emit('startGame', {
                        gameCode: this.currentRoom.code
                    });

                    if (!result.success) {
                        throw new Error(result.error || 'Failed to start game');
                    }

                    categoryManager.showSuccess('Game starting...');

                } catch (error) {
                    console.error('Error starting game:', error);
                    categoryManager.showError(error.message || 'Failed to start game');
                } finally {
                    buttonManager.setLoading(startBtn, false, 'Start Game');
                }
            },

            // Gameplay
            loadQuestion(questionIndex) {
                if (!this.gameState || questionIndex >= this.gameState.questions.length) {
                    this.showResults(this.gameState.players);
                    return;
                }
                
                this.gameState.currentQuestion = questionIndex;
                const question = this.gameState.questions[questionIndex];
                
                // Reset answered status for new question
                this.players.forEach(player => {
                    player.hasAnswered = false;
                });
                
                document.getElementById('mp-current-subject').textContent = 
                    `${this.currentRoom.settings.category} - ${this.currentRoom.settings.subject}`;
                
                document.getElementById('mp-question-count-display').textContent = 
                    `Question ${questionIndex + 1} of ${this.gameState.questions.length}`;
                
                document.getElementById('mp-question-text').textContent = question.question;
                
                const progress = ((questionIndex) / this.gameState.questions.length) * 100;
                document.getElementById('mp-progress-bar').style.width = `${progress}%`;
                
                const optionsContainer = document.getElementById('mp-options-container');
                optionsContainer.innerHTML = '';
                
                question.options.forEach((option, index) => {
                    const optionElement = document.createElement('div');
                    optionElement.className = 'option';
                    optionElement.setAttribute('role', 'button');
                    optionElement.setAttribute('aria-label', `Option ${String.fromCharCode(65 + index)}: ${option}`);
                    optionElement.setAttribute('tabindex', '0');
                    optionElement.innerHTML = `
                        <div class="option-content">
                            <div class="option-letter">${String.fromCharCode(65 + index)}</div>
                            <div class="option-text">${option}</div>
                        </div>
                    `;
                    
                    optionElement.addEventListener('click', () => {
                        this.selectAnswer(index);
                    });
                    
                    optionsContainer.appendChild(optionElement);
                });
                
                this.startTimer();
                this.updateScoreboard();
                
                categoryManager.showScreen('multiplayer-quiz-screen');
                chatSystem.addSystemMessage(`Question ${questionIndex + 1} started!`, 'chat-messages-quiz');
            },

            selectAnswer(optionIndex) {
                if (!this.gameState) return;
                
                const questionIndex = this.gameState.currentQuestion;
                const question = this.gameState.questions[questionIndex];
                const options = document.querySelectorAll('#mp-options-container .option');
                
                options.forEach(opt => {
                    opt.style.pointerEvents = 'none';
                    opt.classList.remove('selected', 'correct', 'incorrect');
                });
                
                options[optionIndex].classList.add('selected');
                
                const isCorrect = optionIndex === question.correctAnswer;
                
                if (isCorrect) {
                    soundSystem.play('correct');
                    options[optionIndex].classList.add('correct');
                } else {
                    soundSystem.play('wrong');
                    options[optionIndex].classList.add('incorrect');
                    if (question.correctAnswer >= 0 && question.correctAnswer < options.length) {
                        options[question.correctAnswer].classList.add('correct');
                    }
                }
                
                this.submitAnswer(questionIndex, optionIndex);
                
                const feedbackElement = document.getElementById('mp-question-feedback');
                const feedbackText = document.getElementById('mp-feedback-text');
                
                if (feedbackElement && feedbackText) {
                    feedbackElement.className = `question-feedback ${isCorrect ? 'correct' : 'incorrect'} show`;
                    feedbackText.textContent = question.explanation || 
                        (isCorrect ? 'Correct! Well done.' : `Incorrect. The right answer is ${String.fromCharCode(65 + question.correctAnswer)}.`);
                }
            },

            async submitAnswer(questionIndex, optionIndex) {
                if (!this.gameState || !this.currentRoom) return;
                
                const question = this.gameState.questions[questionIndex];
                const isCorrect = optionIndex === question.correctAnswer;
                
                // Update player score
                const player = this.players.find(p => p.id === this.playerId);
                if (player) {
                    if (isCorrect) {
                        player.score += 100;
                    }
                    player.hasAnswered = true;
                }
                
                this.updateScoreboard();
                
                // Send answer to server
                if (connectionManager.isConnected) {
                    await connectionManager.emit('submitAnswer', {
                        gameCode: this.currentRoom.code,
                        questionIndex: questionIndex,
                        selectedIndex: optionIndex
                    });
                }
            },

            startTimer() {
                clearInterval(this.timerInterval);
                this.timeLeft = this.gameState.timePerQuestion;
                this.updateTimerDisplay();
                
                this.timerInterval = setInterval(() => {
                    this.timeLeft--;
                    this.updateTimerDisplay();
                    
                    if (this.timeLeft <= 0) {
                        clearInterval(this.timerInterval);
                        // Auto-submit if time runs out
                        const options = document.querySelectorAll('#mp-options-container .option');
                        if (options.length > 0 && !options[0].classList.contains('selected')) {
                            this.submitAnswer(this.gameState.currentQuestion, -1);
                        }
                    }
                }, 1000);
            },

            updateTimerDisplay() {
                const timerElement = document.getElementById('mp-time-left');
                if (timerElement) {
                    timerElement.textContent = this.timeLeft;
                    timerElement.className = `timer ${this.timeLeft <= 10 ? 'warning' : ''} ${this.timeLeft <= 5 ? 'danger' : ''}`;
                }
            },

            updateScoreboard() {
                const scoreboard = document.getElementById('multiplayer-scoreboard');
                if (!scoreboard || !this.players.length) return;
                
                const sortedPlayers = [...this.players].sort((a, b) => b.score - a.score);
                
                scoreboard.innerHTML = sortedPlayers.map((player, index) => {
                    const isCurrentPlayer = player.id === this.playerId;
                    const playerClass = isCurrentPlayer ? 'current-player' : '';
                    const rank = index + 1;
                    
                    return `
                        <div class="scoreboard-item ${playerClass}" role="listitem">
                            <div class="scoreboard-rank">${rank}</div>
                            <div class="multiplayer-avatar">${player.avatar}</div>
                            <div class="flex-grow-1">
                                <strong>${player.name}</strong>
                                ${player.isHost ? '<span class="badge bg-warning ms-2">Host</span>' : ''}
                            </div>
                            <div class="fw-bold">${player.score} pts</div>
                            ${player.hasAnswered ? '<span class="badge bg-success ms-2"><i class="fas fa-check"></i></span>' : '<span class="badge bg-secondary ms-2"><i class="fas fa-clock"></i></span>'}
                        </div>
                    `;
                }).join('');
            },

            showResults(finalScores) {
                clearInterval(this.timerInterval);
                
                if (!finalScores) {
                    finalScores = this.players;
                }
                
                const sortedPlayers = [...finalScores].sort((a, b) => b.score - a.score);
                const winner = sortedPlayers[0];
                const isWinner = winner.id === this.playerId;
                
                document.getElementById('mp-final-score').textContent = `${winner.name} wins!`;
                document.getElementById('mp-winner-avatar').textContent = winner.avatar;
                document.getElementById('mp-winner-name').textContent = winner.name;
                document.getElementById('mp-winner-score').textContent = `${winner.score} points`;
                
                if (isWinner) {
                    document.getElementById('confetti').style.display = 'block';
                    soundSystem.play('victory');
                    
                    setTimeout(() => {
                        document.getElementById('confetti').style.display = 'none';
                    }, 5000);
                }
                
                const leaderboard = document.getElementById('mp-leaderboard');
                leaderboard.innerHTML = sortedPlayers.map((player, index) => {
                    const isCurrentPlayer = player.id === this.playerId;
                    const playerClass = isCurrentPlayer ? 'current-player' : '';
                    const rank = index + 1;
                    const medal = rank === 1 ? 'ü•á' : rank === 2 ? 'ü•à' : rank === 3 ? 'ü•â' : `${rank}.`;
                    
                    return `
                        <div class="leaderboard-item ${playerClass}" role="listitem">
                            <div class="leaderboard-rank">${medal}</div>
                            <div class="multiplayer-avatar">${player.avatar}</div>
                            <div class="flex-grow-1">
                                <strong>${player.name}</strong>
                                ${player.isHost ? '<span class="badge bg-warning ms-2">Host</span>' : ''}
                            </div>
                            <div class="fw-bold">${player.score} pts</div>
                        </div>
                    `;
                }).join('');
                
                categoryManager.showScreen('multiplayer-results-screen');
                chatSystem.addSystemMessage(`Game finished! Winner: ${winner.name} with ${winner.score} points`, 'chat-messages-quiz');
            },

            // UI Management
            updateLobbyDisplay() {
                const roomCodeElement = document.getElementById('room-code');
                const playerCountElement = document.getElementById('player-count');
                const playersList = document.getElementById('players-list');
                const startButton = document.getElementById('start-game-btn');
                const startHint = document.getElementById('start-game-hint');

                if (roomCodeElement && this.currentRoom) {
                    roomCodeElement.textContent = this.currentRoom.code || '----';
                }

                if (playerCountElement) {
                    playerCountElement.textContent = `${this.players.length} player(s)`;
                }

                if (playersList) {
                    // Clear waiting messages
                    const waitingMessages = playersList.parentNode.querySelectorAll('.alert');
                    waitingMessages.forEach(msg => msg.remove());

                    // Show waiting message if only one player
                    if (this.players.length === 1) {
                        const waitingMessage = document.createElement('div');
                        waitingMessage.className = 'alert alert-info text-center';
                        waitingMessage.innerHTML = `
                            <i class="fas fa-users me-2"></i>
                            <strong>Waiting for players to join...</strong><br>
                            <small>Share this room code: <code class="fs-5">${this.currentRoom?.code}</code></small>
                        `;
                        playersList.parentNode.insertBefore(waitingMessage, playersList);
                    }

                    playersList.innerHTML = this.players.map(player => {
                        const isCurrentPlayer = player.id === this.playerId;
                        return `
                            <div class="player-item ${isCurrentPlayer ? 'current-player' : ''}" role="listitem">
                                <div class="multiplayer-avatar me-2">${player.avatar}</div>
                                <div class="flex-grow-1">
                                    <strong>${player.name}</strong>
                                    ${isCurrentPlayer ? '<span class="badge bg-primary ms-2">You</span>' : ''}
                                </div>
                                ${player.isHost ? '<span class="badge bg-warning me-2">Host</span>' : ''}
                                ${player.ready ? '<span class="badge bg-success me-2"><i class="fas fa-check"></i> Ready</span>' : '<span class="badge bg-secondary me-2"><i class="fas fa-clock"></i> Waiting</span>'}
                            </div>
                        `;
                    }).join('');
                }

                if (startButton && startHint && this.currentRoom) {
                    const isHost = this.players.find(p => p.id === this.playerId)?.isHost || false;
                    const canStart = this.players.length >= 2 && this.players.every(p => p.ready);

                    startButton.style.display = isHost ? 'block' : 'none';
                    startButton.disabled = !canStart;

                    if (isHost) {
                        if (this.players.length < 2) {
                            startHint.textContent = `Need ${2 - this.players.length} more player(s) to start`;
                            startHint.className = 'text-warning';
                        } else if (!this.players.every(p => p.ready)) {
                            startHint.textContent = 'Waiting for all players to be ready';
                            startHint.className = 'text-warning';
                        } else {
                            startHint.textContent = 'All players ready! You can start the game';
                            startHint.className = 'text-success';
                        }
                    } else {
                        startHint.textContent = 'Waiting for host to start the game...';
                        startHint.className = 'text-muted';
                    }
                }
            },

            showGameCountdown(seconds) {
                const countdownElement = document.createElement('div');
                countdownElement.className = 'countdown-overlay';
                countdownElement.innerHTML = `
                    <div class="countdown-content">
                        <h2>Game Starting</h2>
                        <div class="countdown-number">${seconds}</div>
                    </div>
                `;
                
                document.body.appendChild(countdownElement);
                
                let count = seconds;
                const countdownInterval = setInterval(() => {
                    count--;
                    const numberElement = countdownElement.querySelector('.countdown-number');
                    if (numberElement) {
                        numberElement.textContent = count;
                    }
                    
                    if (count <= 0) {
                        clearInterval(countdownInterval);
                        countdownElement.remove();
                    }
                }, 1000);
            },

            leaveRoom() {
                if (this.currentRoom && connectionManager.isConnected) {
                    // The server will handle the disconnection
                    this.socket.disconnect();
                }

                this.currentRoom = null;
                this.players = [];
                this.gameState = null;
                clearInterval(this.timerInterval);

                categoryManager.showScreen('multiplayer-setup');
            },

            // Add to multiplayerSystem object:

// Debug method to check current state
debugState() {
    console.log('üêõ MULTIPLAYER DEBUG STATE:');
    console.log('Current Room:', this.currentRoom);
    console.log('Players:', this.players);
    console.log('Game State:', this.gameState);
    console.log('Current Screen:', currentState.screen);
    console.log('Socket Connected:', connectionManager.isConnected);
},

// Method to manually trigger game start (for testing)
debugStartGame() {
    if (!this.currentRoom) {
        console.error('‚ùå No current room for debug start');
        return;
    }
    
    console.log('üêõ DEBUG: Manually starting game');
    this.startGame();
}
        };

        

        // Setup Event Listeners
        function setupEventListeners() {
            console.log('üîß Setting up event listeners...');

            // Sound toggle
            const soundToggle = document.getElementById('toggle-sound');
            if (soundToggle) {
                soundToggle.addEventListener('click', () => {
                    soundSystem.toggle();
                });
            }

            // Start quiz button (single player)
            const startQuizBtn = document.getElementById('start-quiz-btn');
            if (startQuizBtn) {
                startQuizBtn.addEventListener('click', () => {
                    const settings = categoryManager.getCurrentSettings();
                    const playerName = document.getElementById('player-name').value || 'Player';
                    
                    storageManager.savePreferences();
                    
                    if (!settings.category || !settings.subject) {
                        categoryManager.showError('Please select a category and subject');
                        return;
                    }

                    if (settings.gameMode === 'single') {
                        singlePlayerSystem.startGame(
                            settings.category,
                            settings.subject,
                            playerName,
                            avatarSystem.selectedAvatar,
                            settings.difficulty,
                            settings.questionCount,
                            settings.questionSource
                        );
                    } else {
                        categoryManager.showScreen('multiplayer-setup');
                    }
                });
            }

            // Multiplayer setup
            const setupMultiplayer = document.getElementById('setup-multiplayer');
            if (setupMultiplayer) {
                setupMultiplayer.addEventListener('click', () => {
                    categoryManager.showScreen('multiplayer-setup');
                });
            }

            // Create room
            const createRoomBtn = document.getElementById('create-room-btn');
            if (createRoomBtn) {
                createRoomBtn.addEventListener('click', () => {
                    const settings = categoryManager.getCurrentSettings();
                    multiplayerSystem.createRoom(settings);
                });
            }

            // Join room
            const joinRoomBtn = document.getElementById('join-room-btn');
            if (joinRoomBtn) {
                joinRoomBtn.addEventListener('click', () => {
                    const roomCode = document.getElementById('room-code-input').value;
                    multiplayerSystem.joinRoom(roomCode);
                });
            }

            // Start multiplayer game
            const startGameBtn = document.getElementById('start-game-btn');
            if (startGameBtn) {
                startGameBtn.addEventListener('click', () => {
                    multiplayerSystem.startGame();
                });
            }

            // Leave room
            const leaveRoomBtn = document.getElementById('leave-room-btn');
            if (leaveRoomBtn) {
                leaveRoomBtn.addEventListener('click', () => {
                    multiplayerSystem.leaveRoom();
                });
            }

            // Ready toggle
            const toggleReadyBtn = document.getElementById('toggle-ready-btn');
            if (toggleReadyBtn) {
                toggleReadyBtn.addEventListener('click', () => {
                    multiplayerSystem.sendPlayerReady();
                });
            }

            // Back buttons
            const backToMainFromMp = document.getElementById('back-to-main-from-mp');
            if (backToMainFromMp) {
                backToMainFromMp.addEventListener('click', () => {
                    categoryManager.showCategorySelection();
                });
            }

            const backToMultiplayerMenu = document.getElementById('back-to-multiplayer-menu');
            if (backToMultiplayerMenu) {
                backToMultiplayerMenu.addEventListener('click', () => {
                    multiplayerSystem.leaveRoom();
                });
            }

            // Quiz navigation
            const prevQuestion = document.getElementById('prev-question');
            if (prevQuestion) {
                prevQuestion.addEventListener('click', () => {
                    singlePlayerSystem.prevQuestion();
                });
            }

            const nextQuestion = document.getElementById('next-question');
            if (nextQuestion) {
                nextQuestion.addEventListener('click', () => {
                    singlePlayerSystem.nextQuestion();
                });
            }

            const submitQuiz = document.getElementById('submit-quiz');
            if (submitQuiz) {
                submitQuiz.addEventListener('click', () => {
                    singlePlayerSystem.submitQuiz();
                });
            }

            // Play again buttons
            const playAgainSingle = document.getElementById('play-again-btn');
            if (playAgainSingle) {
                playAgainSingle.addEventListener('click', () => {
                    categoryManager.showCategorySelection();
                });
            }

            const playAgainMultiplayer = document.getElementById('play-again-multiplayer');
            if (playAgainMultiplayer) {
                playAgainMultiplayer.addEventListener('click', () => {
                    multiplayerSystem.leaveRoom();
                    categoryManager.showScreen('multiplayer-setup');
                });
            }

            const backToMainFromResults = document.getElementById('back-to-menu');
            if (backToMainFromResults) {
                backToMainFromResults.addEventListener('click', () => {
                    categoryManager.showCategorySelection();
                });
            }

            // Room code input uppercase
            const roomCodeInput = document.getElementById('room-code-input');
            if (roomCodeInput) {
                roomCodeInput.addEventListener('input', (e) => {
                    e.target.value = e.target.value.toUpperCase();
                });
            }

            // Enter key for room code
            if (roomCodeInput) {
                roomCodeInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        document.getElementById('join-room-btn').click();
                    }
                });
            }
            // Add this temporary debug button to your setupEventListeners():
const debugBtn = document.createElement('button');
debugBtn.className = 'btn btn-warning btn-sm position-fixed';
debugBtn.style = 'top: 10px; right: 10px; z-index: 10000;';
debugBtn.innerHTML = 'üêõ Debug';
debugBtn.addEventListener('click', () => {
    multiplayerSystem.debugState();
});
document.body.appendChild(debugBtn);
        }
  

        // Initialize the application
        async function initApp() {
            console.log('üöÄ Initializing QuizMaster App...');

            try {
                // Load user preferences
                storageManager.loadPreferences();
                
                // Initialize all systems
                avatarSystem.init();
                categoryManager.init();
                singlePlayerSystem.init();
                multiplayerSystem.init();
                chatSystem.init();
                
                // Setup event listeners
                setupEventListeners();
                
                // Initialize connection manager
                await connectionManager.init();
                
                // Update UI based on sound preferences
                const soundToggle = document.getElementById('toggle-sound');
                if (soundToggle) {
                    soundToggle.innerHTML = soundSystem.enabled ? 
                        '<i class="fas fa-volume-up me-1"></i> Sound On' : 
                        '<i class="fas fa-volume-mute me-1"></i> Sound Off';
                    soundToggle.classList.toggle('btn-outline-success', soundSystem.enabled);
                    soundToggle.classList.toggle('btn-outline-secondary', !soundSystem.enabled);
                }
                
                console.log('‚úÖ QuizMaster App initialized successfully!');
                
            } catch (error) {
                console.error('‚ùå Failed to initialize app:', error);
                categoryManager.showError('Failed to initialize application. Please refresh the page.');
            }
        }

        // Start the app when DOM is loaded
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initApp);
        } else {
            initApp();
        }
    </script>
</body>
</html>